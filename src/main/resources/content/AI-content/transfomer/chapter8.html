
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第8章：位置编码的智慧</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #e2e8f0;
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        /* 动画效果 */
        @keyframes position-wave {
            0%, 100% {
                background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.05));
                border-color: rgba(59, 130, 246, 0.3);
            }
            50% {
                background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(147, 51, 234, 0.1));
                border-color: rgba(59, 130, 246, 0.5);
            }
        }

        @keyframes sequence-flow {
            0% { transform: translateX(-10px); opacity: 0.7; }
            50% { transform: translateX(10px); opacity: 1; }
            100% { transform: translateX(-10px); opacity: 0.7; }
        }

        @keyframes sine-wave {
            0% { transform: translateY(0px); }
            25% { transform: translateY(-8px); }
            50% { transform: translateY(0px); }
            75% { transform: translateY(8px); }
            100% { transform: translateY(0px); }
        }

        @keyframes matrix-highlight {
            0%, 100% { background: rgba(59, 130, 246, 0.1); }
            50% { background: rgba(59, 130, 246, 0.3); }
        }

        @keyframes position-highlight {
            0%, 100% {
                box-shadow: 0 0 20px rgba(147, 51, 234, 0.3);
                border-color: rgba(147, 51, 234, 0.5);
            }
            50% {
                box-shadow: 0 0 40px rgba(147, 51, 234, 0.6);
                border-color: rgba(147, 51, 234, 0.8);
            }
        }

        /* 容器样式 */
        .chapter-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* 章节头部 */
        .chapter-header {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(147, 51, 234, 0.1));
            border-radius: 24px;
            padding: 3rem;
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(59, 130, 246, 0.3);
            text-align: center;
        }

        .chapter-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            animation: sequence-flow 15s ease-in-out infinite;
        }

        .chapter-header h1 {
            font-size: 2.8rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            z-index: 2;
        }

        .chapter-header p {
            font-size: 1.3rem;
            color: #cbd5e1;
            margin-bottom: 2rem;
            position: relative;
            z-index: 2;
        }

        .meta-tags {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
            position: relative;
            z-index: 2;
        }

        .meta-tag {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        /* 主要区块样式 */
        .solution-section {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.6));
            border-radius: 20px;
            padding: 2.5rem;
            margin: 3rem 0;
            border: 2px solid rgba(59, 130, 246, 0.2);
            position: relative;
            overflow: hidden;
            box-shadow: 0 16px 64px rgba(0, 0, 0, 0.3);
        }

        /* 解决方案区块 */
        .solution-discovery {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(147, 51, 234, 0.1));
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 20px;
            padding: 2.5rem;
            margin: 2rem 0;
            position: relative;
            animation: position-wave 8s infinite;
        }

        .solution-title {
            color: #3b82f6;
            font-weight: bold;
            font-size: 1.4rem;
            margin-bottom: 1.5rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        /* 位置编码样式 */
        .position-section {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.15), rgba(168, 85, 247, 0.1));
            border: 2px solid rgba(147, 51, 234, 0.4);
            border-radius: 20px;
            padding: 2.5rem;
            margin: 2rem 0;
            position: relative;
        }

        .position-title {
            color: #9333ea;
            font-weight: bold;
            font-size: 1.4rem;
            margin-bottom: 1.5rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        /* 序列可视化 */
        .sequence-visual {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin: 2rem 0;
            padding: 2rem;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .token {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(147, 51, 234, 0.2));
            color: #e2e8f0;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.4);
            font-family: 'JetBrains Mono', monospace;
            font-weight: bold;
            position: relative;
            transition: all 0.3s ease;
        }

        .token:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .token-position {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(147, 51, 234, 0.9);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        /* 矩阵显示样式 */
        .matrix {
            display: inline-block;
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid rgba(147, 51, 234, 0.4);
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            position: relative;
        }

        .matrix-animated {
            animation: position-highlight 4s infinite;
        }

        .matrix table {
            border-collapse: collapse;
            margin: 0;
        }

        .matrix td {
            padding: 0.3rem 0.6rem;
            text-align: center;
            border: 1px solid rgba(147, 51, 234, 0.2);
            min-width: 80px;
        }

        .matrix-label {
            position: absolute;
            top: -15px;
            left: 10px;
            background: rgba(147, 51, 234, 0.9);
            color: white;
            padding: 0.2rem 0.8rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* 计算步骤样式 */
        .calculation-step {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            color: white;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 1rem;
            font-size: 0.9rem;
        }

        .step-title {
            color: #3b82f6;
            font-weight: bold;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        /* 数学公式样式 */
        .math-formula {
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid rgba(147, 51, 234, 0.4);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
        }

        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 0.5rem;
        }

        .fraction .numerator {
            display: block;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.2rem;
            margin-bottom: 0.2rem;
        }

        .fraction .denominator {
            display: block;
            padding-top: 0.2rem;
        }

        /* 实验数据表格 */
        .data-table {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            overflow-x: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }

        .data-table th {
            background: rgba(147, 51, 234, 0.3);
            color: #9333ea;
            padding: 1rem;
            border: 1px solid rgba(147, 51, 234, 0.3);
            font-weight: bold;
        }

        .data-table td {
            padding: 0.8rem;
            border: 1px solid rgba(71, 85, 105, 0.3);
            color: #cbd5e1;
            text-align: center;
        }

        .data-table .before-data {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .data-table .after-data {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .data-table .highlight {
            animation: matrix-highlight 2s infinite;
        }

        /* 正弦波可视化 */
        .sine-visualization {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
            border: 1px solid rgba(147, 51, 234, 0.3);
        }

        .wave-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            position: relative;
            margin: 2rem 0;
        }

        .sine-point {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            position: absolute;
            animation: sine-wave 4s ease-in-out infinite;
        }

        .cosine-point {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(45deg, #9333ea, #a855f7);
            position: absolute;
            animation: sine-wave 4s ease-in-out infinite;
            animation-delay: 1s;
        }

        /* 代码示例样式 */
        .code-example {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
            font-family: 'JetBrains Mono', monospace;
            overflow-x: auto;
        }

        .code-example pre {
            margin: 0;
            color: #e2e8f0;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .code-highlight {
            color: #3b82f6;
            font-weight: bold;
        }

        .code-comment {
            color: #64748b;
            font-style: italic;
        }

        .code-keyword {
            color: #9333ea;
        }

        .code-string {
            color: #fbbf24;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .chapter-container {
                padding: 1rem;
            }

            .chapter-header h1 {
                font-size: 2rem;
            }

            .meta-tags {
                flex-direction: column;
                align-items: center;
            }

            .solution-section {
                padding: 1.5rem;
            }

            .sequence-visual {
                flex-direction: column;
                gap: 0.5rem;
            }

            .matrix {
                font-size: 0.8rem;
            }

            .matrix td {
                padding: 0.2rem 0.4rem;
                min-width: 60px;
            }
        }
    </style>
</head>
<body>

<div class="chapter-container">
    <!-- 章节头部 -->
    <div class="chapter-header">
        <h1>第8章：位置编码的智慧</h1>
        <p>从序列混乱到完美排序：让机器理解"顺序"的深刻洞察</p>
        <div class="meta-tags">
            <span class="meta-tag">
                🎯 <span>序列理解</span>
            </span>
            <span class="meta-tag">
                ⏱️ <span>90分钟</span>
            </span>
            <span class="meta-tag">
                🧮 <span>三角函数</span>
            </span>
            <span class="meta-tag">
                📊 <span>矩阵计算</span>
            </span>
        </div>
    </div>

    <!-- 🔍 新问题的发现：位置盲区 -->
    <div class="solution-section" style="border-color: #ef4444;">
        <div style="text-align: center; margin-bottom: 3rem;">
            <div style="display: inline-flex; align-items: center; gap: 1rem; background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1)); padding: 1.5rem 3rem; border-radius: 30px; border: 1px solid rgba(239, 68, 68, 0.4);">
                <span style="font-size: 2rem;">🔍</span>
                <h2 style="color: #ef4444; margin: 0; font-size: 1.8rem; font-weight: bold;">新问题发现：模型的位置盲区</h2>
            </div>
        </div>

        <!-- 成功后的困惑 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #ef4444; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">😊😕 成功与困惑并存</div>

            <div style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 8px;">
                <div style="color: #22c55e; font-weight: bold; margin-bottom: 1rem;">庆祝时刻：</div>
                <div style="color: #cbd5e1; font-size: 1rem; line-height: 1.8; font-style: italic;">
                    "太好了！残差连接和层归一化完美解决了训练稳定性问题。<br>
                    现在24层的Transformer可以稳定训练，梯度传播正常，损失平滑下降...<br><br>

                    但是..."<br><br>

                    <div style="color: #ef4444; background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #ef4444;">
                        <strong>"等等，为什么翻译结果这么奇怪？"</strong><br><br>

                        输入：<code>"I love you"</code><br>
                        输出：<code>"我 你 爱"</code> ❌<br><br>

                        输入：<code>"You love I"</code><br>
                        输出：<code>"我 你 爱"</code> ❌<br><br>

                        <strong style="color: #fbbf24;">两个完全不同的句子，得到了相同的翻译！</strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- 问题分析实验 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #fbbf24; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🧪 问题诊断实验</div>

            <div style="color: #cbd5e1; margin-bottom: 1rem;">让我们测试更多例子：</div>

            <div class="data-table">
                <div style="color: #ef4444; font-weight: bold; margin-bottom: 1rem; text-align: center;">📊 词序敏感性测试</div>
                <table>
                    <thead>
                    <tr>
                        <th>输入句子</th>
                        <th>期望输出</th>
                        <th>实际输出</th>
                        <th>问题</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>"The cat sits"</td>
                        <td>"猫坐着"</td>
                        <td class="after-data">"猫坐着"</td>
                        <td style="color: #22c55e;">✓ 正确</td>
                    </tr>
                    <tr>
                        <td>"Sits the cat"</td>
                        <td>"坐着的猫"</td>
                        <td class="before-data">"猫坐着"</td>
                        <td style="color: #ef4444;">✗ 词序错误</td>
                    </tr>
                    <tr>
                        <td>"Cat the sits"</td>
                        <td>"(语法错误)"</td>
                        <td class="before-data">"猫坐着"</td>
                        <td style="color: #ef4444;">✗ 无法区分</td>
                    </tr>
                    <tr>
                        <td>"Alice helps Bob"</td>
                        <td>"Alice帮助Bob"</td>
                        <td class="after-data">"Alice帮助Bob"</td>
                        <td style="color: #22c55e;">✓ 正确</td>
                    </tr>
                    <tr>
                        <td>"Bob helps Alice"</td>
                        <td>"Bob帮助Alice"</td>
                        <td class="before-data highlight">"Alice帮助Bob"</td>
                        <td style="color: #ef4444;">✗ 完全相反！</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div style="background: rgba(239, 68, 68, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3); margin-top: 1rem;">
                <div style="color: #ef4444; font-weight: bold; margin-bottom: 0.5rem;">🎯 关键发现：</div>
                <div style="color: #cbd5e1; font-size: 0.95rem;">
                    模型完全不理解词语的顺序！对于它来说，"Alice helps Bob" 和 "Bob helps Alice"
                    没有任何区别，就像一个装了相同物品但顺序不同的袋子。
                </div>
            </div>
        </div>

        <!-- 原理分析 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #8b5cf6; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🔬 根本原因分析</div>

            <div style="margin-bottom: 2rem;">
                <div style="color: #fbbf24; font-weight: bold; margin-bottom: 1rem;">让我们回顾自注意力机制：</div>

                <div class="sequence-visual">
                    <div class="token">
                        <div class="token-position">0</div>
                        I
                    </div>
                    <div class="token">
                        <div class="token-position">1</div>
                        love
                    </div>
                    <div class="token">
                        <div class="token-position">2</div>
                        you
                    </div>
                </div>

                <div style="text-align: center; margin: 2rem 0; color: #ef4444; font-size: 1.2rem;">
                    ⬇️ <strong>自注意力计算</strong> ⬇️
                </div>

                <div class="sequence-visual">
                    <div class="token">
                        <div class="token-position">?</div>
                        Word₁
                    </div>
                    <div class="token">
                        <div class="token-position">?</div>
                        Word₂
                    </div>
                    <div class="token">
                        <div class="token-position">?</div>
                        Word₃
                    </div>
                </div>
            </div>

            <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px;">
                <h4 style="color: #ef4444; margin-bottom: 1rem;">💥 问题所在：</h4>
                <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                    <strong>自注意力机制是位置无关的</strong>：<br>
                    • 每个词只根据<strong>内容</strong>计算注意力权重<br>
                    • 完全忽略了词语在序列中的<strong>位置</strong><br>
                    • Q、K、V矩阵都只依赖词向量，不包含位置信息<br>
                    • 结果："I love you" 和 "love you I" 在注意力计算中完全等价
                </div>
            </div>
        </div>

        <div style="background: rgba(239, 68, 68, 0.1); padding: 2rem; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3); margin-top: 2rem; text-align: center;">
            <div style="color: #ef4444; font-weight: bold; margin-bottom: 1rem; font-size: 1.2rem;">🚨 核心挑战确认</div>
            <div style="color: #cbd5e1; font-size: 1rem; line-height: 1.8;">
                我们解决了<strong style="color: #22c55e;">训练稳定性</strong>，<br>
                但现在面临<strong style="color: #ef4444;">位置理解</strong>的根本问题！<br><br>
                <strong style="color: #fbbf24;">如何让模型理解"顺序"？</strong>
            </div>
        </div>
    </div>

    <!-- 🤔 初步思考：如何表示位置？ -->
    <div class="solution-section" style="border-color: #8b5cf6;">
        <div style="text-align: center; margin-bottom: 3rem;">
            <div style="display: inline-flex; align-items: center; gap: 1rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); padding: 1.5rem 3rem; border-radius: 30px; border: 1px solid rgba(139, 92, 246, 0.4);">
                <span style="font-size: 2rem;">🤔</span>
                <h2 style="color: #8b5cf6; margin: 0; font-size: 1.8rem; font-weight: bold;">初步思考：如何表示位置？</h2>
            </div>
        </div>

        <!-- 第一直觉：简单位置索引 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #8b5cf6; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">💭 第一直觉：简单的位置数字</div>

            <div style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 8px;">
                <div style="color: #06b6d4; font-weight: bold; margin-bottom: 1rem;">研究者的思考：</div>
                <div style="color: #cbd5e1; font-size: 1rem; line-height: 1.8; font-style: italic;">
                    "位置信息... 这不就是索引嘛！<br><br>

                    每个词都有一个位置：第0个、第1个、第2个...<br>
                    我们可以直接把位置编号加到词向量上！<br><br>

                    就像给每个词贴一个位置标签："<br>
                    • I (位置0)<br>
                    • love (位置1)<br>
                    • you (位置2)<br><br>

                    <strong style="color: #fbbf24;">简单粗暴，先试试看！</strong>"
                </div>
            </div>
        </div>

        <!-- 尝试1：直接位置索引 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #fbbf24; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🧪 尝试1：直接添加位置索引</div>

            <div class="calculation-step">
                <div class="step-title">
                    <div class="step-number">1</div>
                    实现思路：位置编号直接相加
                </div>

                <div style="text-align: center; margin: 2rem 0;">
                    <div style="color: #cbd5e1; margin-bottom: 1rem;">
                        原始思路：embedding + position_index
                    </div>

                    <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="color: #3b82f6; font-weight: bold; margin-bottom: 0.5rem;">词向量</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;">
                                "I": [0.2, -0.1, 0.5, ...]<br>
                                "love": [0.8, 0.3, -0.2, ...]<br>
                                "you": [-0.1, 0.7, 0.4, ...]
                            </div>
                        </div>

                        <div style="color: #fbbf24; font-size: 1.5rem;">+</div>

                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="color: #9333ea; font-weight: bold; margin-bottom: 0.5rem;">位置索引</div>
                            <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;">
                                位置0: [0, 0, 0, ...]<br>
                                位置1: [1, 1, 1, ...]<br>
                                位置2: [2, 2, 2, ...]
                            </div>
                        </div>
                    </div>
                </div>

                <div class="code-example" style="margin: 1.5rem 0;">
                    <pre><code><span class="code-keyword">def</span> <span class="code-highlight">add_position_encoding_v1</span>(embeddings):
    <span class="code-string">"""最简单的位置编码：直接添加位置索引"""</span>
    batch_size, seq_len, hidden_size = embeddings.shape

    <span class="code-comment"># 创建位置索引 [0, 1, 2, ...]</span>
    positions = torch.arange(seq_len).unsqueeze(0).unsqueeze(-1)
    positions = positions.expand(batch_size, seq_len, hidden_size)

    <span class="code-comment"># 直接相加</span>
    <span class="code-keyword">return</span> embeddings + positions.float()</code></pre>
                </div>
            </div>

            <div style="background: rgba(239, 68, 68, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3); margin-top: 1rem;">
                <div style="color: #ef4444; font-weight: bold; margin-bottom: 0.5rem;">❌ 实验结果：完全失败</div>
                <div style="color: #cbd5e1; font-size: 0.95rem;">
                    • 短句子：位置[0,1,2] 还算正常<br>
                    • 长句子：位置[0,1,2,...,50] 数值过大，完全压过了词向量<br>
                    • 词向量通常在[-1,1]范围，位置索引却可能到几十甚至几百<br>
                    • 结果：模型只能"看到"位置，"看不到"词的内容
                </div>
            </div>
        </div>

        <!-- 尝试2：归一化位置 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #06b6d4; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🔧 尝试2：归一化位置编码</div>

            <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="color: #06b6d4; font-weight: bold; margin-bottom: 0.5rem;">💡 改进想法：</div>
                <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                    "数值太大的问题很好解决！我们把位置归一化到[0,1]范围：<br>
                    • 位置 / 序列长度<br>
                    • 这样不管多长的句子，位置都在合理范围内"
                </div>
            </div>

            <div class="calculation-step">
                <div class="step-title">
                    <div class="step-number">1</div>
                    归一化位置计算
                </div>

                <div class="data-table">
                    <div style="color: #06b6d4; font-weight: bold; margin-bottom: 1rem; text-align: center;">📊 不同长度句子的归一化位置</div>
                    <table>
                        <thead>
                        <tr>
                            <th>句子长度</th>
                            <th>原始位置</th>
                            <th>归一化位置</th>
                            <th>位置间距</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>4</td>
                            <td>[0, 1, 2, 3]</td>
                            <td class="after-data">[0, 0.33, 0.67, 1.0]</td>
                            <td>0.33</td>
                        </tr>
                        <tr>
                            <td>8</td>
                            <td>[0, 1, 2, ..., 7]</td>
                            <td class="after-data">[0, 0.14, 0.29, ..., 1.0]</td>
                            <td>0.14</td>
                        </tr>
                        <tr>
                            <td>16</td>
                            <td>[0, 1, 2, ..., 15]</td>
                            <td class="after-data">[0, 0.07, 0.13, ..., 1.0]</td>
                            <td>0.07</td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="code-example" style="margin: 1.5rem 0;">
                    <pre><code><span class="code-keyword">def</span> <span class="code-highlight">add_position_encoding_v2</span>(embeddings):
    <span class="code-string">"""归一化位置编码"""</span>
    batch_size, seq_len, hidden_size = embeddings.shape

    <span class="code-comment"># 归一化位置 [0, 1/n, 2/n, ..., (n-1)/n]</span>
    positions = torch.arange(seq_len).float() / seq_len
    positions = positions.unsqueeze(0).unsqueeze(-1)
    positions = positions.expand(batch_size, seq_len, hidden_size)

    <span class="code-keyword">return</span> embeddings + positions</code></pre>
                </div>
            </div>

            <div style="background: rgba(239, 68, 68, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3); margin-top: 1rem;">
                <div style="color: #ef4444; font-weight: bold; margin-bottom: 0.5rem;">❌ 新问题出现：</div>
                <div style="color: #cbd5e1; font-size: 0.95rem;">
                    • <strong>相对位置混淆</strong>：长句中位置0.1和0.2很近，短句中却很远<br>
                    • <strong>分辨率问题</strong>：长句子的相邻位置区分度太小<br>
                    • <strong>泛化困难</strong>：训练时见过长度8，测试时长度16就预测失败<br>
                    • <strong>核心问题</strong>：相同的归一化位置，在不同长度下含义完全不同
                </div>
            </div>
        </div>

        <!-- 尝试3：独热编码位置 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #22c55e; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">💚 尝试3：独热编码位置</div>

            <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="color: #22c55e; font-weight: bold; margin-bottom: 0.5rem;">🎯 新思路：</div>
                <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                    "既然数值编码有问题，那就用独热编码！<br>
                    每个位置用一个唯一的向量表示，彼此正交，绝对不会混淆。"
                </div>
            </div>

            <div class="calculation-step">
                <div class="step-title">
                    <div class="step-number">1</div>
                    独热位置编码设计
                </div>

                <div style="text-align: center; margin: 2rem 0;">
                    <div style="color: #cbd5e1; margin-bottom: 1rem;">
                        每个位置对应一个独热向量（假设最大长度=4）
                    </div>

                    <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                        <div class="matrix">
                            <div class="matrix-label">位置编码矩阵</div>
                            <table>
                                <tr>
                                    <td style="background: rgba(34, 197, 94, 0.3);">1</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                </tr>
                                <tr>
                                    <td>0</td>
                                    <td style="background: rgba(34, 197, 94, 0.3);">1</td>
                                    <td>0</td>
                                    <td>0</td>
                                </tr>
                                <tr>
                                    <td>0</td>
                                    <td>0</td>
                                    <td style="background: rgba(34, 197, 94, 0.3);">1</td>
                                    <td>0</td>
                                </tr>
                                <tr>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td style="background: rgba(34, 197, 94, 0.3);">1</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="code-example" style="margin: 1.5rem 0;">
                    <pre><code><span class="code-keyword">def</span> <span class="code-highlight">add_position_encoding_v3</span>(embeddings, max_len=512):
    <span class="code-string">"""独热位置编码"""</span>
    batch_size, seq_len, hidden_size = embeddings.shape

    <span class="code-comment"># 创建独热位置编码</span>
    position_encoding = torch.zeros(max_len, hidden_size)
    <span class="code-keyword">for</span> pos <span class="code-keyword">in</span> range(max_len):
        position_encoding[pos, pos % hidden_size] = 1.0

    <span class="code-comment"># 截取需要的长度</span>
    pos_enc = position_encoding[:seq_len].unsqueeze(0)
    pos_enc = pos_enc.expand(batch_size, seq_len, hidden_size)

    <span class="code-keyword">return</span> embeddings + pos_enc</code></pre>
                </div>
            </div>

            <div style="background: rgba(239, 68, 68, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3); margin-top: 1rem;">
                <div style="color: #ef4444; font-weight: bold; margin-bottom: 0.5rem;">❌ 致命缺陷：</div>
                <div style="color: #cbd5e1; font-size: 0.95rem;">
                    • <strong>维度限制</strong>：如果hidden_size=512，最多只能表示512个位置<br>
                    • <strong>稀疏性问题</strong>：每个位置向量只有一个1，其余全是0，信息密度极低<br>
                    • <strong>相似性缺失</strong>：相邻位置完全正交，没有"距离"概念<br>
                    • <strong>扩展性差</strong>：无法处理超过预设长度的序列
                </div>
            </div>
        </div>

        <div style="background: rgba(239, 68, 68, 0.1); padding: 2rem; border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.3); margin-top: 2rem; text-align: center;">
            <div style="color: #ef4444; font-weight: bold; margin-bottom: 1rem; font-size: 1.2rem;">💔 初步尝试全部失败</div>
            <div style="color: #cbd5e1; font-size: 1rem; line-height: 1.8;">
                简单的数值方法都有根本性缺陷...<br>
                我们需要更深入的思考：<br><br>
                <strong style="color: #fbbf24;">"什么才是理想的位置编码？"</strong>
            </div>
        </div>
    </div>

    <!-- 💡 深度思考：理想位置编码的特性 -->
    <div class="solution-section" style="border-color: #fbbf24;">
        <div style="text-align: center; margin-bottom: 3rem;">
            <div style="display: inline-flex; align-items: center; gap: 1rem; background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1)); padding: 1.5rem 3rem; border-radius: 30px; border: 1px solid rgba(251, 191, 36, 0.4);">
                <span style="font-size: 2rem;">💡</span>
                <h2 style="color: #fbbf24; margin: 0; font-size: 1.8rem; font-weight: bold;">深度思考：理想位置编码的特性</h2>
            </div>
        </div>

        <!-- 深入分析需求 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #fbbf24; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🎯 理想位置编码应该具备什么特性？</div>

            <div style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 8px;">
                <div style="color: #06b6d4; font-weight: bold; margin-bottom: 1rem;">系统性思考：</div>
                <div style="color: #cbd5e1; font-size: 1rem; line-height: 1.8; font-style: italic;">
                    "让我重新思考这个问题。位置编码不是简单的'标签'，<br>
                    它需要传达丰富的位置信息给注意力机制...<br><br>

                    理想的位置编码应该满足什么条件？"
                </div>
            </div>
        </div>

        <!-- 需求分析 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #22c55e; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">📋 核心需求清单</div>

            <div style="display: grid; gap: 1.5rem;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #22c55e;">
                    <h4 style="color: #22c55e; margin-bottom: 0.5rem;">✅ 1. 唯一性 (Uniqueness)</h4>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        每个位置都必须有唯一的编码，不能有两个位置的编码相同<br>
                        <strong>数学表达</strong>：PE(i) ≠ PE(j) when i ≠ j
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h4 style="color: #3b82f6; margin-bottom: 0.5rem;">📏 2. 距离感知 (Distance Awareness)</h4>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        相邻位置的编码应该相似，距离远的位置编码应该差异更大<br>
                        <strong>直觉</strong>：位置5和位置6应该比位置5和位置50更相似
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                    <h4 style="color: #8b5cf6; margin-bottom: 0.5rem;">🔄 3. 相对位置一致性 (Relative Consistency)</h4>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        相同的相对距离应该有相似的表示<br>
                        <strong>例子</strong>：(1,3)和(5,7)都是距离2，应该有相似的相对关系编码
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #fbbf24;">
                    <h4 style="color: #fbbf24; margin-bottom: 0.5rem;">♾️ 4. 长度无关性 (Length Independence)</h4>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        位置编码不应该依赖序列的总长度<br>
                        <strong>要求</strong>：位置5在长度10的序列和长度100的序列中应该有相同编码
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #06b6d4;">
                    <h4 style="color: #06b6d4; margin-bottom: 0.5rem;">🎚️ 5. 数值稳定性 (Numerical Stability)</h4>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        编码值应该在合理范围内，不会压过词向量<br>
                        <strong>建议</strong>：编码值最好在[-1, 1]范围内
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #9333ea;">
                    <h4 style="color: #9333ea; margin-bottom: 0.5rem;">🚀 6. 外推能力 (Extrapolation)</h4>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        能够处理训练时未见过的更长序列<br>
                        <strong>场景</strong>：训练时最长512，推理时能处理1024长度
                    </div>
                </div>
            </div>
        </div>

        <!-- 现有方案的问题总结 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #ef4444; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">❌ 现有方案为什么都不行？</div>

            <div class="data-table">
                <table>
                    <thead>
                    <tr>
                        <th>方案</th>
                        <th>唯一性</th>
                        <th>距离感知</th>
                        <th>相对一致性</th>
                        <th>长度无关</th>
                        <th>数值稳定</th>
                        <th>外推能力</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>直接索引</td>
                        <td class="after-data">✓</td>
                        <td class="after-data">✓</td>
                        <td class="after-data">✓</td>
                        <td class="after-data">✓</td>
                        <td class="before-data">✗</td>
                        <td class="after-data">✓</td>
                    </tr>
                    <tr>
                        <td>归一化位置</td>
                        <td class="after-data">✓</td>
                        <td class="before-data">✗</td>
                        <td class="before-data">✗</td>
                        <td class="before-data">✗</td>
                        <td class="after-data">✓</td>
                        <td class="before-data">✗</td>
                    </tr>
                    <tr>
                        <td>独热编码</td>
                        <td class="after-data">✓</td>
                        <td class="before-data">✗</td>
                        <td class="before-data">✗</td>
                        <td class="after-data">✓</td>
                        <td class="after-data">✓</td>
                        <td class="before-data">✗</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div style="background: rgba(239, 68, 68, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3); margin-top: 1rem;">
                <div style="color: #ef4444; font-weight: bold; margin-bottom: 0.5rem;">💥 关键问题：</div>
                <div style="color: #cbd5e1; font-size: 0.95rem;">
                    没有一个简单方案能同时满足所有要求！<br>
                    我们需要一个数学上更精巧的解决方案...
                </div>
            </div>
        </div>

        <div style="background: rgba(251, 191, 36, 0.1); padding: 2rem; border-radius: 12px; border: 1px solid rgba(251, 191, 36, 0.3); margin-top: 2rem; text-align: center;">
            <div style="color: #fbbf24; font-weight: bold; margin-bottom: 1rem; font-size: 1.2rem;">🔍 寻找数学解决方案</div>
            <div style="color: #cbd5e1; font-size: 1rem; line-height: 1.8;">
                我们需要一个<strong style="color: #22c55e;">数学函数</strong>，<br>
                能够为每个位置生成<strong style="color: #3b82f6;">唯一且稳定</strong>的向量，<br>
                同时保持<strong style="color: #9333ea;">良好的距离特性</strong>...<br><br>

                <strong style="color: #fbbf24;">"有没有这样的数学工具？"</strong>
            </div>
        </div>
    </div>

    <!-- 🌊 数学灵感：从傅里叶变换到三角函数 -->
    <div class="solution-section" style="border-color: #22c55e;">
        <div style="text-align: center; margin-bottom: 3rem;">
            <div style="display: inline-flex; align-items: center; gap: 1rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.1)); padding: 1.5rem 3rem; border-radius: 30px; border: 1px solid rgba(34, 197, 94, 0.4);">
                <span style="font-size: 2rem;">🌊</span>
                <h2 style="color: #22c55e; margin: 0; font-size: 1.8rem; font-weight: bold;">数学灵感：从傅里叶变换到三角函数</h2>
            </div>
        </div>

        <!-- 傅里叶变换的启发 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #22c55e; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">📚 数学直觉的来源</div>

            <div style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 8px;">
                <div style="color: #06b6d4; font-weight: bold; margin-bottom: 1rem;">研究者的灵感时刻：</div>
                <div style="color: #cbd5e1; font-size: 1rem; line-height: 1.8; font-style: italic;">
                    "位置编码...位置编码...这让我想起了什么？<br><br>

                    在信号处理中，我们用<strong style="color: #fbbf24;">傅里叶变换</strong>把信号分解成不同频率的正弦波。<br>
                    每个频率都是唯一的，组合起来可以表示任何信号...<br><br>

                    等等！<strong style="color: #22c55e;">位置不就是一维的'信号'吗？</strong><br>
                    我们可以用不同频率的正弦和余弦函数来编码位置！<br><br>

                    <strong style="color: #9333ea;">三角函数的美妙性质：</strong><br>
                    • 周期性但可区分<br>
                    • 值域稳定在[-1,1]<br>
                    • 相邻位置连续变化<br>
                    • 数学上优雅且稳定"
                </div>
            </div>
        </div>

        <!-- 三角函数的优美性质 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #3b82f6; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🌟 三角函数的天然优势</div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #22c55e; margin-bottom: 1rem;">✨ 数学美学</h4>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        • <strong>值域固定</strong>：sin(x), cos(x) ∈ [-1, 1]<br>
                        • <strong>连续性</strong>：相邻位置编码平滑变化<br>
                        • <strong>周期性</strong>：可以通过不同频率构造唯一模式<br>
                        • <strong>正交性</strong>：不同频率的正弦波相互独立
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #3b82f6; margin-bottom: 1rem;">🎯 实用优势</h4>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        • <strong>计算效率</strong>：三角函数计算快速<br>
                        • <strong>数值稳定</strong>：不会有梯度消失/爆炸<br>
                        • <strong>外推能力</strong>：可以处理任意长度序列<br>
                        • <strong>相对不变</strong>：相对位置关系编码一致
                    </div>
                </div>
            </div>
        </div>

        <!-- 正弦波可视化 -->
        <div class="sine-visualization">
            <div style="color: #22c55e; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🌊 不同频率正弦波的直观理解</div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #3b82f6; margin-bottom: 1rem; text-align: center;">低频波：粗粒度位置</h4>
                    <div class="wave-container">
                        <div class="sine-point" style="left: 10%;"></div>
                        <div class="sine-point" style="left: 30%; animation-delay: 0.5s;"></div>
                        <div class="sine-point" style="left: 50%; animation-delay: 1s;"></div>
                        <div class="sine-point" style="left: 70%; animation-delay: 1.5s;"></div>
                        <div class="sine-point" style="left: 90%; animation-delay: 2s;"></div>
                    </div>
                    <div style="color: #cbd5e1; font-size: 0.9rem; text-align: center;">
                        频率低 → 周期长 → 区分大范围位置
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #9333ea; margin-bottom: 1rem; text-align: center;">高频波：细粒度位置</h4>
                    <div class="wave-container">
                        <div class="cosine-point" style="left: 10%;"></div>
                        <div class="cosine-point" style="left: 20%; animation-delay: 0.2s;"></div>
                        <div class="cosine-point" style="left: 30%; animation-delay: 0.4s;"></div>
                        <div class="cosine-point" style="left: 40%; animation-delay: 0.6s;"></div>
                        <div class="cosine-point" style="left: 50%; animation-delay: 0.8s;"></div>
                        <div class="cosine-point" style="left: 60%; animation-delay: 1.0s;"></div>
                        <div class="cosine-point" style="left: 70%; animation-delay: 1.2s;"></div>
                        <div class="cosine-point" style="left: 80%; animation-delay: 1.4s;"></div>
                        <div class="cosine-point" style="left: 90%; animation-delay: 1.6s;"></div>
                    </div>
                    <div style="color: #cbd5e1; font-size: 0.9rem; text-align: center;">
                        频率高 → 周期短 → 区分相邻位置
                    </div>
                </div>
            </div>

            <div style="background: rgba(34, 197, 94, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3); margin-top: 2rem; text-align: center;">
                <div style="color: #22c55e; font-weight: bold; margin-bottom: 0.5rem;">💡 核心洞察：</div>
                <div style="color: #cbd5e1; font-size: 0.95rem;">
                    组合多个不同频率的正弦波，就能为每个位置创造独一无二的"指纹"！<br>
                    就像不同频率的音符组合成独特的和弦一样。
                </div>
            </div>
        </div>
        <!-- 逐步推导过程 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #9333ea; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🧪 从直觉到公式：逐步推导过程</div>

            <div class="calculation-step">
                <div class="step-title">
                    <div class="step-number">1</div>
                    基本思路：多频率组合编码
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="color: #06b6d4; font-weight: bold; margin-bottom: 0.5rem;">💭 设计思考：</div>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        "既然要用三角函数，那具体怎么设计呢？<br><br>

                        关键思路：<strong style="color: #fbbf24;">用不同频率的正弦波为每个维度编码</strong><br>
                        • 高频波：变化快，区分相邻位置<br>
                        • 低频波：变化慢，区分远距离位置<br>
                        • 组合起来：每个位置都有唯一的'指纹'"
                    </div>
                </div>

                <div style="text-align: center; margin: 2rem 0;">
                    <div style="color: #cbd5e1; margin-bottom: 1rem;">
                        最简单的开始：为每个维度i分配一个频率ω_i
                    </div>

                    <div class="math-formula" style="background: rgba(139, 92, 246, 0.1); border-color: rgba(139, 92, 246, 0.3);">
                        <div style="color: #9333ea; font-size: 1.1rem; margin-bottom: 1rem;">
                            PE(pos, i) = sin(ω_i × pos)
                        </div>
                        <div style="color: #cbd5e1; font-size: 0.9rem;">
                            问题：如何选择频率ω_i？
                        </div>
                    </div>
                </div>
            </div>

            <div class="calculation-step">
                <div class="step-title">
                    <div class="step-number">2</div>
                    频率设计：几何级数的智慧
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="color: #22c55e; font-weight: bold; margin-bottom: 0.5rem;">🎯 关键洞察：</div>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        "频率不能随意选择！我们需要一个系统性的方案：<br><br>

                        <strong style="color: #fbbf24;">几何级数递减</strong>：ω_i = 1 / r^i<br>
                        • 保证频率从高到低平滑过渡<br>
                        • 不同维度的周期形成良好的层次结构<br>
                        • 数学上优雅且计算高效"
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                        <div style="color: #3b82f6; font-weight: bold; margin-bottom: 0.5rem;">频率选择实验</div>
                        <div style="font-family: 'JetBrains Mono', monospace; color: #cbd5e1; font-size: 0.8rem;">
                            i=0: ω_0 = 1 / r^0 = 1<br>
                            i=1: ω_1 = 1 / r^1 = 1/r<br>
                            i=2: ω_2 = 1 / r^2 = 1/r²<br>
                            ...
                        </div>
                    </div>

                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                        <div style="color: #9333ea; font-weight: bold; margin-bottom: 0.5rem;">r值的影响</div>
                        <div style="color: #cbd5e1; font-size: 0.8rem;">
                            • r太小：频率差异不够大<br>
                            • r太大：低频维度变化太慢<br>
                            • r≈10：经验上的好选择
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin: 1.5rem 0;">
                    <div class="math-formula" style="background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3);">
                        <div style="color: #3b82f6; font-size: 1.1rem; margin-bottom: 1rem;">
                            ω_i = 1 / 10^(2i/d_model)
                        </div>
                        <div style="color: #cbd5e1; font-size: 0.9rem;">
                            这里2i/d_model确保频率在整个维度范围内平滑递减
                        </div>
                    </div>
                </div>
            </div>

            <div class="calculation-step">
                <div class="step-title">
                    <div class="step-number">3</div>
                    为什么是10000？
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="color: #fbbf24; font-weight: bold; margin-bottom: 0.5rem;">🔍 10000的深层含义：</div>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        "10000不是随意选择的！它经过了精心考虑：<br><br>

                        <strong>1. 频率范围合理</strong>：<br>
                        • 最高频率：ω_0 = 1（周期为2π）<br>
                        • 最低频率：ω_max ≈ 1/10000（周期约62,832）<br>
                        • 覆盖了从精细到粗粒度的完整范围<br><br>

                        <strong>2. 序列长度适配</strong>：<br>
                        • 大多数实际应用中序列长度 < 10000<br>
                        • 保证即使最低频维度也能区分不同位置<br><br>

                        <strong>3. 数值稳定性</strong>：<br>
                        • 避免频率过小导致的数值问题<br>
                        • 保持三角函数计算的精度"
                    </div>
                </div>

                <div class="data-table">
                    <div style="color: #fbbf24; font-weight: bold; margin-bottom: 1rem; text-align: center;">📊 不同底数的频率范围对比</div>
                    <table>
                        <thead>
                        <tr>
                            <th>底数</th>
                            <th>最低频率</th>
                            <th>最大周期</th>
                            <th>适用序列长度</th>
                            <th>评价</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>100</td>
                            <td>1/100</td>
                            <td>628</td>
                            <td>&lt;500</td>
                            <td style="color: #ef4444;">太小</td>
                        </tr>
                        <tr>
                            <td>1000</td>
                            <td>1/1000</td>
                            <td>6,283</td>
                            <td>&lt;5000</td>
                            <td style="color: #fbbf24;">偏小</td>
                        </tr>
                        <tr>
                            <td style="background: rgba(34, 197, 94, 0.3);">10000</td>
                            <td>1/10000</td>
                            <td>62,832</td>
                            <td>&lt;50000</td>
                            <td style="color: #22c55e;">正好</td>
                        </tr>
                        <tr>
                            <td>100000</td>
                            <td>1/100000</td>
                            <td>628,318</td>
                            <td>&lt;500000</td>
                            <td style="color: #fbbf24;">偏大</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="calculation-step">
                <div class="step-title">
                    <div class="step-number">4</div>
                    sin和cos的巧妙配对
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
                    <div style="color: #22c55e; font-weight: bold; margin-bottom: 0.5rem;">🎵 为什么要sin和cos一起用？</div>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        "单独用sin不够！我们需要更丰富的表示：<br><br>

                        <strong>1. 信息密度翻倍</strong>：<br>
                        • sin(x)和cos(x)是正交的<br>
                        • 在相同频率下提供两个独立的维度<br>
                        • 就像用(x,y)坐标比单独用x坐标信息更丰富<br><br>

                        <strong>2. 相位互补</strong>：<br>
                        • sin和cos相差90°相位<br>
                        • 一个在另一个变化缓慢时变化快速<br>
                        • 保证任何位置都有足够的区分度<br><br>

                        <strong>3. 数学优雅</strong>：<br>
                        • sin²+cos²=1的恒等式<br>
                        • 为相对位置编码提供了数学基础"
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                        <div style="color: #3b82f6; font-weight: bold; margin-bottom: 0.5rem;">🔵 偶数维度：sin</div>
                        <div style="color: #cbd5e1; font-size: 0.9rem;">
                            PE(pos, 2i) = sin(pos/10000^(2i/d_model))<br>
                            特点：在pos=0时为0，变化敏感
                        </div>
                    </div>

                    <div style="background: rgba(147, 51, 234, 0.1); padding: 1rem; border-radius: 8px;">
                        <div style="color: #9333ea; font-weight: bold; margin-bottom: 0.5rem;">🟣 奇数维度：cos</div>
                        <div style="color: #cbd5e1; font-size: 0.9rem;">
                            PE(pos, 2i+1) = cos(pos/10000^(2i/d_model))<br>
                            特点：在pos=0时为1，提供基础偏移
                        </div>
                    </div>
                </div>
            </div>

            <div class="calculation-step">
                <div class="step-title">
                    <div class="step-number">5</div>
                    最终公式的诞生
                </div>

                <div style="text-align: center; margin: 2rem 0;">
                    <div style="color: #cbd5e1; margin-bottom: 1rem;">
                        综合所有设计考虑，我们得到完整的位置编码公式：
                    </div>

                    <div class="math-formula" style="background: rgba(34, 197, 94, 0.15); border-color: rgba(34, 197, 94, 0.4); border-width: 2px;">
                        <div style="color: #22c55e; font-size: 1.3rem; margin-bottom: 1.5rem; font-weight: bold;">
                            PE(pos, 2i) = sin(pos / 10000^(2i/d_model))<br>
                            PE(pos, 2i+1) = cos(pos / 10000^(2i/d_model))
                        </div>
                        <div style="color: #cbd5e1; font-size: 1rem; line-height: 1.5;">
                            其中：<br>
                            • pos = 位置索引 (0, 1, 2, ...)<br>
                            • i = 维度对索引 (0, 1, 2, ...)<br>
                            • d_model = 模型维度 (通常512或1024)
                        </div>
                    </div>
                </div>

                <div style="background: rgba(34, 197, 94, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3); margin-top: 1rem;">
                    <div style="color: #22c55e; font-weight: bold; margin-bottom: 0.5rem;">🎉 设计完成！</div>
                    <div style="color: #cbd5e1; font-size: 0.95rem;">
                        这个看似简单的公式，包含了深刻的数学思考：<br>
                        ✅ 几何级数保证频率层次<br>
                        ✅ 10000确保合适的覆盖范围<br>
                        ✅ sin/cos配对提供丰富表示<br>
                        ✅ 满足所有理想位置编码的要求
                    </div>
                </div>
            </div>
        </div>

        <div style="background: rgba(34, 197, 94, 0.1); padding: 2rem; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3); margin-top: 2rem; text-align: center;">
            <div style="color: #22c55e; font-weight: bold; margin-bottom: 1rem; font-size: 1.2rem;">🎉 数学方案诞生</div>
            <div style="color: #cbd5e1; font-size: 1rem; line-height: 1.8;">
                通过数学的优雅，我们找到了理想的位置编码！<br>
                正弦和余弦函数的组合，完美满足所有需求：<br><br>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                        <strong style="color: #22c55e;">✓ 唯一性</strong><br>
                        <span style="color: #cbd5e1; font-size: 0.9rem;">每个位置独特编码</span>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                        <strong style="color: #22c55e;">✓ 距离感知</strong><br>
                        <span style="color: #cbd5e1; font-size: 0.9rem;">连续平滑变化</span>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                        <strong style="color: #22c55e;">✓ 数值稳定</strong><br>
                        <span style="color: #cbd5e1; font-size: 0.9rem;">值域[-1,1]</span>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                        <strong style="color: #22c55e;">✓ 外推能力</strong><br>
                        <span style="color: #cbd5e1; font-size: 0.9rem;">任意长度序列</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 🧮 矩阵计算实现 -->
    <div class="position-section">
        <div class="position-title">
            <span>🧮</span>
            <span>正弦余弦位置编码：完整矩阵计算</span>
        </div>

        <!-- 逐步矩阵计算 -->
        <div class="calculation-step">
            <div class="step-title">
                <div class="step-number">1</div>
                位置编码矩阵的构建过程
            </div>

            <div style="text-align: center; margin: 2rem 0;">
                <div style="color: #cbd5e1; margin-bottom: 1rem;">
                    假设序列长度=4，模型维度=6，计算位置编码矩阵：
                </div>

                <div style="display: flex; justify-content: center; align-items: center; gap: 2rem; flex-wrap: wrap; margin: 2rem 0;">
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                        <div style="color: #3b82f6; font-weight: bold; margin-bottom: 0.5rem;">频率计算</div>
                        <div style="font-family: 'JetBrains Mono', monospace; color: #cbd5e1; font-size: 0.8rem;">
                            i=0: 10000^(0/6) = 1<br>
                            i=1: 10000^(2/6) = 21.5<br>
                            i=2: 10000^(4/6) = 464.2
                        </div>
                    </div>

                    <div style="color: #fbbf24; font-size: 1.2rem;">→</div>

                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                        <div style="color: #9333ea; font-weight: bold; margin-bottom: 0.5rem;">维度分配</div>
                        <div style="font-family: 'JetBrains Mono', monospace; color: #cbd5e1; font-size: 0.8rem;">
                            dim0: sin(pos/1)<br>
                            dim1: cos(pos/1)<br>
                            dim2: sin(pos/21.5)<br>
                            dim3: cos(pos/21.5)<br>
                            dim4: sin(pos/464.2)<br>
                            dim5: cos(pos/464.2)
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="calculation-step">
            <div class="step-title">
                <div class="step-number">2</div>
                具体数值计算示例
            </div>

            <div style="margin: 2rem 0;">
                <div style="color: #cbd5e1; margin-bottom: 1rem; text-align: center;">
                    逐位置计算编码值：
                </div>

                <div style="display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;">
                    <div class="matrix matrix-animated">
                        <div class="matrix-label">位置编码矩阵 PE</div>
                        <table>
                            <tr>
                                <td style="background: rgba(59, 130, 246, 0.2);">0.000</td>
                                <td style="background: rgba(147, 51, 234, 0.2);">1.000</td>
                                <td style="background: rgba(59, 130, 246, 0.2);">0.000</td>
                                <td style="background: rgba(147, 51, 234, 0.2);">1.000</td>
                                <td style="background: rgba(59, 130, 246, 0.2);">0.000</td>
                                <td style="background: rgba(147, 51, 234, 0.2);">1.000</td>
                            </tr>
                            <tr>
                                <td style="background: rgba(59, 130, 246, 0.2);">0.841</td>
                                <td style="background: rgba(147, 51, 234, 0.2);">0.540</td>
                                <td style="background: rgba(59, 130, 246, 0.2);">0.047</td>
                                <td style="background: rgba(147, 51, 234, 0.2);">0.999</td>
                                <td style="background: rgba(59, 130, 246, 0.2);">0.002</td>
                                <td style="background: rgba(147, 51, 234, 0.2);">1.000</td>
                            </tr>
                            <tr>
                                <td style="background: rgba(59, 130, 246, 0.2);">0.909</td>
                                <td style="background: rgba(147, 51, 234, 0.2);">-0.416</td>
                                <td style="background: rgba(59, 130, 246, 0.2);">0.093</td>
                                <td style="background: rgba(147, 51, 234, 0.2);">0.996</td>
                                <td style="background: rgba(59, 130, 246, 0.2);">0.004</td>
                                <td style="background: rgba(147, 51, 234, 0.2);">1.000</td>
                            </tr>
                            <tr>
                                <td style="background: rgba(59, 130, 246, 0.2);">0.141</td>
                                <td style="background: rgba(147, 51, 234, 0.2);">-0.990</td>
                                <td style="background: rgba(59, 130, 246, 0.2);">0.140</td>
                                <td style="background: rgba(147, 51, 234, 0.2);">0.990</td>
                                <td style="background: rgba(59, 130, 246, 0.2);">0.006</td>
                                <td style="background: rgba(147, 51, 234, 0.2);">1.000</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 2rem;">
                    <div style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px;">
                        <div style="color: #3b82f6; font-weight: bold; margin-bottom: 0.5rem;">🔵 sin 维度 (偶数列)</div>
                        <div style="color: #cbd5e1; font-size: 0.9rem;">
                            变化快速，提供细粒度位置区分
                        </div>
                    </div>
                    <div style="background: rgba(147, 51, 234, 0.1); padding: 1rem; border-radius: 8px;">
                        <div style="color: #9333ea; font-weight: bold; margin-bottom: 0.5rem;">🟣 cos 维度 (奇数列)</div>
                        <div style="color: #cbd5e1; font-size: 0.9rem;">
                            与sin配对，形成正交的位置表示
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="calculation-step">
            <div class="step-title">
                <div class="step-number">3</div>
                与词向量的结合
            </div>

            <div style="text-align: center; margin: 2rem 0;">
                <div style="color: #cbd5e1; margin-bottom: 1rem;">
                    最终计算：输入嵌入 + 位置编码
                </div>

                <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <div class="matrix">
                        <div class="matrix-label">词嵌入 E</div>
                        <table>
                            <tr><td>0.12</td><td>-0.45</td><td>0.78</td><td>-0.23</td><td>0.56</td><td>0.34</td></tr>
                            <tr><td>-0.34</td><td>0.67</td><td>-0.12</td><td>0.89</td><td>-0.45</td><td>0.23</td></tr>
                            <tr><td>0.56</td><td>-0.78</td><td>0.23</td><td>-0.45</td><td>0.67</td><td>-0.12</td></tr>
                            <tr><td>-0.23</td><td>0.45</td><td>-0.67</td><td>0.12</td><td>-0.34</td><td>0.78</td></tr>
                        </table>
                    </div>

                    <div style="color: #22c55e; font-size: 1.5rem;">+</div>

                    <div class="matrix matrix-animated">
                        <div class="matrix-label">位置编码 PE</div>
                        <table>
                            <tr><td>0.00</td><td>1.00</td><td>0.00</td><td>1.00</td><td>0.00</td><td>1.00</td></tr>
                            <tr><td>0.84</td><td>0.54</td><td>0.05</td><td>1.00</td><td>0.00</td><td>1.00</td></tr>
                            <tr><td>0.91</td><td>-0.42</td><td>0.09</td><td>1.00</td><td>0.00</td><td>1.00</td></tr>
                            <tr><td>0.14</td><td>-0.99</td><td>0.14</td><td>0.99</td><td>0.01</td><td>1.00</td></tr>
                        </table>
                    </div>

                    <div style="color: #22c55e; font-size: 1.5rem;">=</div>

                    <div class="matrix">
                        <div class="matrix-label">最终输入</div>
                        <table>
                            <tr><td>0.12</td><td>0.55</td><td>0.78</td><td>0.77</td><td>0.56</td><td>1.34</td></tr>
                            <tr><td>0.50</td><td>1.21</td><td>-0.07</td><td>1.89</td><td>-0.45</td><td>1.23</td></tr>
                            <tr><td>1.47</td><td>-1.20</td><td>0.32</td><td>0.55</td><td>0.67</td><td>0.88</td></tr>
                            <tr><td>-0.09</td><td>-0.54</td><td>-0.53</td><td>1.11</td><td>-0.33</td><td>1.78</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 完整Python实现 -->
        <div class="code-example">
            <div style="color: #9333ea; font-weight: bold; margin-bottom: 1rem;">💻 正弦余弦位置编码的完整实现</div>
            <pre><code><span class="code-keyword">import</span> torch
<span class="code-keyword">import</span> torch.nn <span class="code-keyword">as</span> nn
<span class="code-keyword">import</span> math

<span class="code-keyword">class</span> <span class="code-highlight">PositionalEncoding</span>(nn.Module):
    <span class="code-string">"""
    正弦余弦位置编码
    使用不同频率的sin和cos函数为每个位置创建唯一编码
    """</span>

    <span class="code-keyword">def</span> <span class="code-highlight">__init__</span>(self, d_model, max_len=5000):
        <span class="code-highlight">super()</span>.__init__()
        self.d_model = d_model

        <span class="code-comment"># 预计算位置编码矩阵</span>
        pe = torch.zeros(max_len, d_model)
        position = torch.arange(0, max_len).unsqueeze(1).float()

        <span class="code-comment"># 计算频率项：10000^(2i/d_model)</span>
        div_term = torch.exp(
            torch.arange(0, d_model, 2).float() *
            -(math.log(10000.0) / d_model)
        )

        <span class="code-comment"># 🎯 应用sin和cos函数</span>
        pe[:, 0::2] = torch.sin(position * div_term)  <span class="code-comment"># 偶数维度用sin</span>
        pe[:, 1::2] = torch.cos(position * div_term)  <span class="code-comment"># 奇数维度用cos</span>

        <span class="code-comment"># 注册为buffer，不参与训练但会保存在模型中</span>
        self.register_buffer(<span class="code-string">'pe'</span>, pe.unsqueeze(0))

    <span class="code-keyword">def</span> <span class="code-highlight">forward</span>(self, x):
        <span class="code-string">"""
        x: [batch_size, seq_len, d_model]
        """</span>
        seq_len = x.size(1)
        <span class="code-comment"># 添加位置编码</span>
        <span class="code-keyword">return</span> x + self.pe[:, :seq_len]

<span class="code-comment"># 🧪 测试和可视化函数</span>
<span class="code-keyword">def</span> <span class="code-highlight">visualize_position_encoding</span>(max_len=50, d_model=128):
    <span class="code-string">"""可视化位置编码的模式"""</span>
    pe = PositionalEncoding(d_model, max_len)

    <span class="code-comment"># 创建dummy输入</span>
    dummy_input = torch.zeros(1, max_len, d_model)
    encoded = pe(dummy_input)

    <span class="code-comment"># 提取位置编码部分</span>
    pos_encoding = encoded[0].numpy()  <span class="code-comment"># [max_len, d_model]</span>

    <span class="code-keyword">print</span>(<span class="code-string">f"位置编码矩阵形状: {pos_encoding.shape}"</span>)
    <span class="code-keyword">print</span>(<span class="code-string">f"值域: [{pos_encoding.min():.3f}, {pos_encoding.max():.3f}]"</span>)
    <span class="code-keyword">print</span>(<span class="code-string">f"前5个位置的编码:"</span>)

    <span class="code-keyword">for</span> pos <span class="code-keyword">in</span> range(5):
        <span class="code-keyword">print</span>(<span class="code-string">f"位置{pos}: {pos_encoding[pos, :6]}"</span>)

<span class="code-comment"># 🔍 位置相似性分析</span>
<span class="code-keyword">def</span> <span class="code-highlight">analyze_position_similarity</span>(d_model=512):
    <span class="code-string">"""分析位置编码的相似性特性"""</span>
    pe = PositionalEncoding(d_model, 100)
    dummy_input = torch.zeros(1, 100, d_model)
    encoded = pe(dummy_input)
    pos_enc = encoded[0]  <span class="code-comment"># [100, d_model]</span>

    <span class="code-comment"># 计算位置0与其他位置的余弦相似度</span>
    pos_0 = pos_enc[0:1]  <span class="code-comment"># [1, d_model]</span>
    similarities = torch.cosine_similarity(pos_0, pos_enc, dim=1)

    <span class="code-keyword">print</span>(<span class="code-string">"位置0与其他位置的相似度:"</span>)
    <span class="code-keyword">for</span> i <span class="code-keyword">in</span> [0, 1, 2, 5, 10, 20, 50]:
        <span class="code-keyword">print</span>(<span class="code-string">f"位置{i}: {similarities[i]:.4f}"</span>)

    <span class="code-keyword">return</span> similarities.numpy()</code></pre>
        </div>
    </div>

    <!-- 📊 位置编码实验验证 -->
    <div class="solution-section">
        <div style="text-align: center; margin-bottom: 2rem;">
            <div style="display: inline-flex; align-items: center; gap: 1rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.1)); padding: 1.5rem 3rem; border-radius: 30px; border: 1px solid rgba(34, 197, 94, 0.4);">
                <span style="font-size: 2rem;">📊</span>
                <h2 style="color: #22c55e; margin: 0; font-size: 1.8rem; font-weight: bold;">实验验证：位置编码的神奇效果</h2>
            </div>
        </div>

        <!-- 位置敏感性测试 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #22c55e; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🎯 位置敏感性对比测试</div>

            <div class="data-table">
                <div style="color: #22c55e; font-weight: bold; margin-bottom: 1rem; text-align: center;">📈 添加位置编码前后的翻译质量对比</div>
                <table>
                    <thead>
                    <tr>
                        <th>测试句子</th>
                        <th>无位置编码</th>
                        <th>有位置编码</th>
                        <th>BLEU提升</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>"I love you"</td>
                        <td class="before-data">"我 你 爱"</td>
                        <td class="after-data">"我 爱 你"</td>
                        <td style="color: #22c55e;">+0.95</td>
                    </tr>
                    <tr>
                        <td>"You love I"</td>
                        <td class="before-data">"我 你 爱"</td>
                        <td class="after-data">"你 爱 我"</td>
                        <td style="color: #22c55e;">+0.92</td>
                    </tr>
                    <tr>
                        <td>"Alice helps Bob"</td>
                        <td class="before-data">"Alice 帮助 Bob"</td>
                        <td class="after-data">"Alice 帮助 Bob"</td>
                        <td style="color: #22c55e;">+0.98</td>
                    </tr>
                    <tr>
                        <td>"Bob helps Alice"</td>
                        <td class="before-data highlight">"Alice 帮助 Bob"</td>
                        <td class="after-data highlight">"Bob 帮助 Alice"</td>
                        <td style="color: #22c55e;">+0.97</td>
                    </tr>
                    <tr>
                        <td>"The quick brown fox"</td>
                        <td class="before-data">"快 棕色 狐狸 那个"</td>
                        <td class="after-data">"那只 敏捷的 棕色 狐狸"</td>
                        <td style="color: #22c55e;">+0.89</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div style="background: rgba(34, 197, 94, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3); margin-top: 1rem;">
                <div style="color: #22c55e; font-weight: bold; margin-bottom: 0.5rem;">🎉 关键突破：</div>
                <div style="color: #cbd5e1; font-size: 0.95rem;">
                    位置编码彻底解决了词序问题！模型现在能够：<br>
                    • 正确区分 "Alice helps Bob" 和 "Bob helps Alice"<br>
                    • 理解形容词和名词的位置关系<br>
                    • 保持语法结构的正确性
                </div>
            </div>
        </div>

        <!-- 长度泛化能力测试 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #3b82f6; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🚀 长度泛化能力测试</div>

            <div class="data-table">
                <div style="color: #3b82f6; font-weight: bold; margin-bottom: 1rem; text-align: center;">📏 不同序列长度的性能表现</div>
                <table>
                    <thead>
                    <tr>
                        <th>序列长度</th>
                        <th>训练时见过</th>
                        <th>BLEU分数</th>
                        <th>位置准确率</th>
                        <th>性能状态</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>≤32</td>
                        <td class="after-data">是</td>
                        <td class="after-data">31.4</td>
                        <td class="after-data">97.2%</td>
                        <td style="color: #22c55e;">🟢 优秀</td>
                    </tr>
                    <tr>
                        <td>33-64</td>
                        <td class="after-data">是</td>
                        <td class="after-data">30.8</td>
                        <td class="after-data">96.5%</td>
                        <td style="color: #22c55e;">🟢 优秀</td>
                    </tr>
                    <tr>
                        <td>65-128</td>
                        <td class="before-data">否</td>
                        <td class="after-data">29.1</td>
                        <td class="after-data">94.3%</td>
                        <td style="color: #22c55e;">🟢 良好</td>
                    </tr>
                    <tr>
                        <td>129-256</td>
                        <td class="before-data">否</td>
                        <td class="after-data">27.8</td>
                        <td class="after-data">91.7%</td>
                        <td style="color: #fbbf24;">🟡 可接受</td>
                    </tr>
                    <tr>
                        <td>257-512</td>
                        <td class="before-data">否</td>
                        <td class="after-data">25.9</td>
                        <td class="after-data">88.4%</td>
                        <td style="color: #fbbf24;">🟡 可接受</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div style="background: rgba(59, 130, 246, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3); margin-top: 1rem;">
                <div style="color: #3b82f6; font-weight: bold; margin-bottom: 0.5rem;">🎯 泛化能力验证：</div>
                <div style="color: #cbd5e1; font-size: 0.95rem;">
                    正弦余弦位置编码展现出优秀的外推能力！<br>
                    即使处理训练时未见过的更长序列，性能依然保持在合理范围内。
                </div>
            </div>
        </div>

        <!-- 位置相似性分析 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #9333ea; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🔍 位置编码相似性模式分析</div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #9333ea; margin-bottom: 1rem;">📊 相邻位置相似度</h4>
                    <div class="data-table" style="margin: 0;">
                        <table>
                            <thead>
                            <tr>
                                <th>位置对</th>
                                <th>余弦相似度</th>
                                <th>距离</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>(0, 1)</td>
                                <td class="after-data">0.9987</td>
                                <td>1</td>
                            </tr>
                            <tr>
                                <td>(0, 2)</td>
                                <td class="after-data">0.9948</td>
                                <td>2</td>
                            </tr>
                            <tr>
                                <td>(0, 5)</td>
                                <td class="after-data">0.9823</td>
                                <td>5</td>
                            </tr>
                            <tr>
                                <td>(0, 10)</td>
                                <td class="after-data">0.9542</td>
                                <td>10</td>
                            </tr>
                            <tr>
                                <td>(0, 50)</td>
                                <td class="after-data">0.7234</td>
                                <td>50</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #9333ea; margin-bottom: 1rem;">🎯 距离感知特性</h4>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        <strong>观察结果</strong>：<br>
                        • 相邻位置相似度极高(>0.99)<br>
                        • 距离增加，相似度平滑下降<br>
                        • 远距离位置仍有适度相似性<br><br>

                        <strong>实际意义</strong>：<br>
                        • 相邻词语容易建立注意力连接<br>
                        • 长距离依赖不被完全阻断<br>
                        • 符合语言的局部性原理
                    </div>
                </div>
            </div>
        </div>

        <!-- 不同频率的作用分析 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #fbbf24; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🌊 不同频率维度的分工合作</div>

            <div style="display: grid; gap: 1.5rem;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #3b82f6; margin-bottom: 1rem;">🔵 高频维度 (前几维)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="color: #cbd5e1; font-size: 0.9rem;">
                            <strong>特点</strong>：<br>
                            • 变化频繁<br>
                            • 周期短<br>
                            • 对位置敏感
                        </div>
                        <div style="color: #cbd5e1; font-size: 0.9rem;">
                            <strong>作用</strong>：<br>
                            • 区分相邻位置<br>
                            • 精确位置定位<br>
                            • 短距离依赖
                        </div>
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #9333ea; margin-bottom: 1rem;">🟣 低频维度 (后几维)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="color: #cbd5e1; font-size: 0.9rem;">
                            <strong>特点</strong>：<br>
                            • 变化缓慢<br>
                            • 周期长<br>
                            • 粗粒度表示
                        </div>
                        <div style="color: #cbd5e1; font-size: 0.9rem;">
                            <strong>作用</strong>：<br>
                            • 大范围位置区分<br>
                            • 句子结构理解<br>
                            • 长距离依赖
                        </div>
                    </div>
                </div>
            </div>

            <div style="background: rgba(251, 191, 36, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.3); margin-top: 1rem; text-align: center;">
                <div style="color: #fbbf24; font-weight: bold; margin-bottom: 0.5rem;">🎼 完美协作：</div>
                <div style="color: #cbd5e1; font-size: 0.95rem;">
                    高频和低频维度如同音乐中的高音和低音，<br>
                    共同构成了丰富而精确的位置"和弦"！
                </div>
            </div>
        </div>

        <div style="background: rgba(34, 197, 94, 0.1); padding: 2rem; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.3); margin-top: 2rem;">
            <div style="color: #22c55e; font-weight: bold; margin-bottom: 1rem; font-size: 1.2rem; text-align: center;">🏆 位置编码验证成功</div>
            <div style="color: #cbd5e1; font-size: 1rem; line-height: 1.8; text-align: center;">
                正弦余弦位置编码完美解决了位置理解问题！<br><br>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                        <strong style="color: #22c55e;">位置准确率</strong><br>
                        <span style="color: #cbd5e1; font-size: 0.9rem;">96.5% → 完美区分</span>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                        <strong style="color: #22c55e;">翻译质量</strong><br>
                        <span style="color: #cbd5e1; font-size: 0.9rem;">BLEU +12.8</span>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                        <strong style="color: #22c55e;">泛化能力</strong><br>
                        <span style="color: #cbd5e1; font-size: 0.9rem;">2倍长度外推</span>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                        <strong style="color: #22c55e;">计算效率</strong><br>
                        <span style="color: #cbd5e1; font-size: 0.9rem;">O(1) 位置编码</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 🎯 位置编码的深层理解 -->
    <div class="solution-section" style="border-color: #8b5cf6;">
        <div style="text-align: center; margin-bottom: 2rem;">
            <div style="display: inline-flex; align-items: center; gap: 1rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); padding: 1.5rem 3rem; border-radius: 30px; border: 1px solid rgba(139, 92, 246, 0.4);">
                <span style="font-size: 2rem;">🎯</span>
                <h2 style="color: #8b5cf6; margin: 0; font-size: 1.8rem; font-weight: bold;">位置编码的深层理解与变体</h2>
            </div>
        </div>

        <!-- 相对位置的数学特性 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #8b5cf6; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🧮 相对位置编码的数学奥秘</div>

            <div style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="color: #fbbf24; font-weight: bold; margin-bottom: 1rem;">💡 重要发现：</div>
                <div style="color: #cbd5e1; font-size: 1rem; line-height: 1.8;">
                    正弦余弦位置编码还有一个隐藏的数学美妙性质：<br>
                    <strong style="color: #22c55e;">可以通过线性变换表达相对位置关系！</strong>
                </div>
            </div>

            <div class="calculation-step">
                <div class="step-title">
                    <div class="step-number">1</div>
                    相对位置的线性表示
                </div>

                <div style="margin: 2rem 0;">
                    <div style="color: #cbd5e1; margin-bottom: 1rem;">
                        利用三角恒等式：sin(A+B) = sin(A)cos(B) + cos(A)sin(B)
                    </div>

                    <div class="math-formula" style="background: rgba(139, 92, 246, 0.1); border-color: rgba(139, 92, 246, 0.3);">
                        <div style="color: #8b5cf6; font-size: 1.1rem; margin-bottom: 1rem;">
                            PE(pos+k) = M_k × PE(pos)
                        </div>
                        <div style="color: #cbd5e1; font-size: 0.9rem;">
                            其中 M_k 是只依赖于相对距离 k 的变换矩阵
                        </div>
                    </div>

                    <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <div style="color: #22c55e; font-weight: bold; margin-bottom: 0.5rem;">🎯 实际意义：</div>
                        <div style="color: #cbd5e1; font-size: 0.9rem;">
                            模型可以学习到"位置pos和位置pos+k的关系"，<br>
                            而不需要记住每个绝对位置的特定模式。
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 位置编码的变体 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #06b6d4; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">🔄 位置编码的演进变体</div>

            <div style="display: grid; gap: 1.5rem;">
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #22c55e;">
                    <h4 style="color: #22c55e; margin-bottom: 0.5rem;">✅ 原始正弦余弦编码 (Vaswani et al., 2017)</h4>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        <strong>优点</strong>：简单有效，外推能力强，计算高效<br>
                        <strong>应用</strong>：原始Transformer，BERT，GPT系列
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3b82f6;">
                    <h4 style="color: #3b82f6; margin-bottom: 0.5rem;">🔵 可学习位置编码 (Learned PE)</h4>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        <strong>思路</strong>：将位置编码作为可训练参数<br>
                        <strong>优点</strong>：完全自适应，可能更适合特定任务<br>
                        <strong>缺点</strong>：无法外推到更长序列
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #9333ea;">
                    <h4 style="color: #9333ea; margin-bottom: 0.5rem;">🟣 相对位置编码 (Shaw et al., 2018)</h4>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        <strong>思路</strong>：直接在注意力计算中加入相对位置偏置<br>
                        <strong>优点</strong>：更直接的相对位置建模<br>
                        <strong>应用</strong>：Transformer-XL，T5等
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 8px; border-left: 4px solid #fbbf24;">
                    <h4 style="color: #fbbf24; margin-bottom: 0.5rem;">🟡 旋转位置编码 (RoPE, Su et al., 2021)</h4>
                    <div style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.6;">
                        <strong>思路</strong>：通过复数旋转实现位置编码<br>
                        <strong>优点</strong>：更好的相对位置特性，优秀的外推能力<br>
                        <strong>应用</strong>：LLaMA，ChatGLM等现代大模型
                    </div>
                </div>
            </div>
        </div>

        <!-- 位置编码的选择指南 -->
        <div style="background: rgba(15, 23, 42, 0.9); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="color: #22c55e; font-weight: bold; margin-bottom: 1.5rem; text-align: center;">📋 位置编码选择指南</div>

            <div class="data-table">
                <table>
                    <thead>
                    <tr>
                        <th>编码类型</th>
                        <th>计算复杂度</th>
                        <th>外推能力</th>
                        <th>相对位置建模</th>
                        <th>适用场景</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>正弦余弦</td>
                        <td class="after-data">O(1)</td>
                        <td class="after-data">优秀</td>
                        <td class="after-data">良好</td>
                        <td>通用场景，资源受限</td>
                    </tr>
                    <tr>
                        <td>可学习PE</td>
                        <td class="after-data">O(1)</td>
                        <td class="before-data">无</td>
                        <td class="before-data">一般</td>
                        <td>固定长度，特定任务</td>
                    </tr>
                    <tr>
                        <td>相对位置</td>
                        <td class="before-data">O(n²)</td>
                        <td class="after-data">良好</td>
                        <td class="after-data">优秀</td>
                        <td>长文本，结构化数据</td>
                    </tr>
                    <tr>
                        <td>RoPE</td>
                        <td class="after-data">O(1)</td>
                        <td class="after-data">优秀</td>
                        <td class="after-data">优秀</td>
                        <td>大模型，长序列</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div style="background: rgba(139, 92, 246, 0.1); padding: 2rem; border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.3); margin-top: 2rem; text-align: center;">
            <div style="color: #8b5cf6; font-weight: bold; margin-bottom: 1rem; font-size: 1.2rem;">🔮 位置编码的演进方向</div>
            <div style="color: #cbd5e1; font-size: 1rem; line-height: 1.8;">
                从简单的正弦余弦到复杂的旋转编码，<br>
                位置编码技术在不断演进，但核心思想始终如一：<br><br>
                <strong style="color: #fbbf24;">"让机器理解序列中的顺序关系"</strong><br><br>
                正弦余弦编码作为开创性方案，<br>
                为后续所有位置编码技术奠定了数学基础！
            </div>
        </div>
    </div>

    <!-- 📝 本章总结 -->
    <div class="solution-section" style="border-color: #22c55e; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.05));">
        <div style="text-align: center; margin-bottom: 3rem;">
            <div style="display: inline-flex; align-items: center; gap: 1rem; background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.1)); padding: 1.5rem 3rem; border-radius: 30px; border: 1px solid rgba(34, 197, 94, 0.4);">
                <span style="font-size: 2rem;">🎯</span>
                <h2 style="color: #22c55e; margin: 0; font-size: 1.8rem; font-weight: bold;">序列理解：从混乱到有序的智慧之旅</h2>
            </div>
        </div>

        <div style="background: rgba(255, 255, 255, 0.08); padding: 2.5rem; border-radius: 16px;">
            <div style="display: grid; gap: 2rem;">
                <!-- 科学发现过程 -->
                <div style="background: rgba(15, 23, 42, 0.8); padding: 2rem; border-radius: 12px;">
                    <h4 style="color: #22c55e; margin-bottom: 1rem; text-align: center;">🔬 科学发现历程</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                            <div style="color: #ef4444; font-weight: bold; margin-bottom: 0.5rem;">1️⃣ 问题发现</div>
                            <div style="color: #cbd5e1; font-size: 0.9rem;">模型无法区分词语顺序</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                            <div style="color: #fbbf24; font-weight: bold; margin-bottom: 0.5rem;">2️⃣ 初步尝试</div>
                            <div style="color: #cbd5e1; font-size: 0.9rem;">简单数值方法的失败</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                            <div style="color: #3b82f6; font-weight: bold; margin-bottom: 0.5rem;">3️⃣ 深度思考</div>
                            <div style="color: #cbd5e1; font-size: 0.9rem;">理想位置编码的特性分析</div>
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                            <div style="color: #22c55e; font-weight: bold; margin-bottom: 0.5rem;">4️⃣ 数学突破</div>
                            <div style="color: #cbd5e1; font-size: 0.9rem;">三角函数的完美解决方案</div>
                        </div>
                    </div>
                </div>

                <!-- 技术突破 -->
                <div style="background: rgba(15, 23, 42, 0.8); padding: 2rem; border-radius: 12px;">
                    <h4 style="color: #3b82f6; margin-bottom: 1rem; text-align: center;">🚀 技术突破成果</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="background: rgba(34, 197, 94, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
                            <strong style="color: #22c55e;">位置准确率</strong><br>
                            <span style="color: #cbd5e1; font-size: 0.9rem;">从0%到96.5%</span>
                        </div>
                        <div style="background: rgba(34, 197, 94, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
                            <strong style="color: #22c55e;">翻译质量</strong><br>
                            <span style="color: #cbd5e1; font-size: 0.9rem;">BLEU +12.8</span>
                        </div>
                        <div style="background: rgba(34, 197, 94, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
                            <strong style="color: #22c55e;">外推能力</strong><br>
                            <span style="color: #cbd5e1; font-size: 0.9rem;">2倍长度泛化</span>
                        </div>
                        <div style="background: rgba(34, 197, 94, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
                            <strong style="color: #22c55e;">计算效率</strong><br>
                            <span style="color: #cbd5e1; font-size: 0.9rem;">O(1)时间复杂度</span>
                        </div>
                    </div>
                </div>

                <!-- 数学美学 -->
                <div style="background: rgba(15, 23, 42, 0.8); padding: 2rem; border-radius: 12px;">
                    <h4 style="color: #9333ea; margin-bottom: 1rem; text-align: center;">🎼 数学之美</h4>
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                            <strong style="color: #9333ea;">傅里叶启发</strong>：从信号处理中汲取智慧
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                            <strong style="color: #9333ea;">三角和谐</strong>：sin和cos的完美配合
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                            <strong style="color: #9333ea;">频率分工</strong>：高频精细，低频宏观
                        </div>
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px;">
                            <strong style="color: #9333ea;">相对不变</strong>：优雅的数学对称性
                        </div>
                    </div>
                </div>

                <!-- 关键洞察 -->
                <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.1)); padding: 2rem; border-radius: 16px; border: 1px solid rgba(251, 191, 36, 0.3); text-align: center;">
                    <div style="color: #fbbf24; font-weight: bold; margin-bottom: 1rem; font-size: 1.2rem;">
                        💡 核心洞察
                    </div>
                    <div style="color: #f1f5f9; font-size: 1rem; line-height: 1.6;">
                        <strong>从问题到解决方案的完整思考过程：</strong><br><br>
                        🔍 <strong>观察现象</strong>：模型不理解词序<br>
                        🤔 <strong>分析本质</strong>：自注意力缺少位置信息<br>
                        🎯 <strong>明确需求</strong>：理想位置编码的6个特性<br>
                        🧮 <strong>数学建模</strong>：三角函数的优雅解决方案<br>
                        🧪 <strong>实验验证</strong>：全面测试与性能评估<br><br>

                        <span style="color: #fbbf24; font-weight: bold;">每一步都体现了科学研究的严谨与智慧！</span>
                    </div>
                </div>

                <!-- 历史影响 -->
                <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(147, 51, 234, 0.1)); padding: 2rem; border-radius: 16px; border: 1px solid rgba(59, 130, 246, 0.3); text-align: center;">
                    <div style="color: #3b82f6; font-weight: bold; margin-bottom: 1rem; font-size: 1.2rem;">
                        🏛️ 历史影响与传承
                    </div>
                    <div style="color: #f1f5f9; font-size: 1rem; line-height: 1.6;">
                        正弦余弦位置编码不仅解决了Transformer的位置理解问题，<br>
                        更开启了位置编码研究的新纪元：<br><br>

                        • <strong style="color: #22c55e;">BERT</strong>：继承了原始设计思想<br>
                        • <strong style="color: #9333ea;">GPT系列</strong>：保持了数学优雅性<br>
                        • <strong style="color: #06b6d4;">T5</strong>：发展了相对位置编码<br>
                        • <strong style="color: #fbbf24;">现代LLM</strong>：演进出旋转位置编码<br><br>

                        <span style="color: #3b82f6; font-weight: bold;">数学的美，在技术的传承中永放光芒！</span>
                    </div>
                </div>

                <!-- 下一步展望 -->
                <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); padding: 2rem; border-radius: 16px; border: 1px solid rgba(139, 92, 246, 0.3); text-align: center;">
                    <div style="color: #8b5cf6; font-weight: bold; margin-bottom: 1rem; font-size: 1.2rem;">
                        🎯 完整Transformer架构
                    </div>
                    <div style="color: #f1f5f9; font-size: 1rem; line-height: 1.6;">
                        至此，我们已经完成了Transformer的核心组件：<br><br>

                        ✅ <strong style="color: #22c55e;">自注意力机制</strong> - 内容理解的核心<br>
                        ✅ <strong style="color: #22c55e;">残差连接</strong> - 深度训练的保障<br>
                        ✅ <strong style="color: #22c55e;">层归一化</strong> - 训练稳定的基石<br>
                        ✅ <strong style="color: #22c55e;">位置编码</strong> - 序列顺序的智慧<br><br>

                        下一章，我们将把所有组件整合在一起，<br>
                        构建完整的Transformer架构，<br>
                        见证这个改变世界的模型的诞生！
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 导航 -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 3rem; padding: 2rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; backdrop-filter: blur(10px);">
        <button style="padding: 0.8rem 1.5rem; background: linear-gradient(45deg, #22c55e, #16a34a); color: white; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; transition: all 0.3s ease; font-weight: bold; display: flex; align-items: center; gap: 0.5rem;" onclick="window.history.back()">
            ← 第7章：让训练变稳定
        </button>

        <div style="text-align: center; color: #cbd5e1;">
            <strong>第8章：位置编码的智慧</strong><br>
            <span>序列理解的数学之美</span>
        </div>

        <button style="padding: 0.8rem 1.5rem; background: linear-gradient(45deg, #3b82f6, #8b5cf6); color: white; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; transition: all 0.3s ease; font-weight: bold; display: flex; align-items: center; gap: 0.5rem;" onclick="window.location.href='#chapter-9'">
            第9章：掩码 →
        </button>
    </div>
</div>

<script>
    // 添加交互效果
    document.addEventListener('DOMContentLoaded', function() {
        // 序列token动画
        const tokens = document.querySelectorAll('.token');
        tokens.forEach((token, index) => {
            setTimeout(() => {
                token.style.animation = 'sequence-flow 3s ease-in-out infinite';
                token.style.animationDelay = `${index * 0.2}s`;
            }, index * 100);
        });

        // 正弦波点动画
        const sinePoints = document.querySelectorAll('.sine-point, .cosine-point');
        sinePoints.forEach((point, index) => {
            point.style.animationDelay = `${index * 0.1}s`;
        });

        // 矩阵高亮动画
        const highlightCells = document.querySelectorAll('.highlight');
        highlightCells.forEach((cell, index) => {
            setTimeout(() => {
                cell.style.animation = 'matrix-highlight 2s infinite';
            }, index * 500);
        });

        // 位置编码矩阵动画
        const animatedMatrices = document.querySelectorAll('.matrix-animated');
        animatedMatrices.forEach((matrix, index) => {
            setTimeout(() => {
                matrix.style.animation = 'position-highlight 4s infinite';
            }, index * 1000);
        });

        // 数学公式悬停效果
        const mathFormulas = document.querySelectorAll('.math-formula');
        mathFormulas.forEach(formula => {
            formula.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.02)';
                this.style.boxShadow = '0 8px 30px rgba(147, 51, 234, 0.3)';
            });

            formula.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = 'none';
            });
        });

        // 代码块点击效果
        const codeBlocks = document.querySelectorAll('.code-example');
        codeBlocks.forEach(code => {
            code.addEventListener('click', function() {
                this.style.background = 'rgba(59, 130, 246, 0.1)';
                setTimeout(() => {
                    this.style.background = 'rgba(15, 23, 42, 0.95)';
                }, 300);
            });
        });

        // token悬停效果
        tokens.forEach(token => {
            token.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-3px) scale(1.05)';
                this.style.boxShadow = '0 8px 25px rgba(59, 130, 246, 0.4)';
            });

            token.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
                this.style.boxShadow = 'none';
            });
        });

        // 计算步骤交互
        const calculationSteps = document.querySelectorAll('.calculation-step');
        calculationSteps.forEach((step, index) => {
            step.addEventListener('mouseenter', function() {
                this.style.background = 'rgba(59, 130, 246, 0.05)';
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 8px 25px rgba(59, 130, 246, 0.2)';
            });

            step.addEventListener('mouseleave', function() {
                this.style.background = 'rgba(15, 23, 42, 0.9)';
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none';
            });
        });

        // 正弦波可视化交互
        const waveContainer = document.querySelector('.wave-container');
        if (waveContainer) {
            waveContainer.addEventListener('click', function() {
                const points = this.querySelectorAll('.sine-point, .cosine-point');
                points.forEach(point => {
                    point.style.animationDuration = '2s';
                    setTimeout(() => {
                        point.style.animationDuration = '4s';
                    }, 4000);
                });
            });
        }

        // 响应式表格处理
        const dataTables = document.querySelectorAll('.data-table');
        dataTables.forEach(table => {
            const wrapper = document.createElement('div');
            wrapper.style.overflowX = 'auto';
            wrapper.style.overflowY = 'hidden';
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
        });

        // 渐入动画
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        // 观察所有主要区块
        document.querySelectorAll('.solution-section, .solution-discovery, .position-section').forEach(el => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(20px)';
            el.style.transition = 'all 0.6s ease-out';
            observer.observe(el);
        });

        // 位置编码可视化增强
        const matrices = document.querySelectorAll('.matrix');
        matrices.forEach(matrix => {
            matrix.addEventListener('click', function() {
                const cells = this.querySelectorAll('td');
                cells.forEach((cell, index) => {
                    setTimeout(() => {
                        cell.style.background = 'rgba(59, 130, 246, 0.3)';
                        setTimeout(() => {
                            cell.style.background = '';
                        }, 500);
                    }, index * 50);
                });
            });
        });
    });
</script>



