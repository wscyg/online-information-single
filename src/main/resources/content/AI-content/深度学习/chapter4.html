<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬4ç« ï¼šä¼˜åŒ–å›°å¢ƒä¸ç ´å±€ä¹‹é“ | æ·±åº¦å­¦ä¹ çš„æˆé•¿çƒ¦æ¼</title>
    <meta name="description" content="ä»æ¢¯åº¦æ¶ˆå¤±åˆ°ä¼˜åŒ–æŠ€å·§ï¼Œæ¢ç´¢æ·±åº¦ç¥ç»ç½‘ç»œè®­ç»ƒçš„æ ¸å¿ƒæŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
    <style>
        /* ===== CSSå˜é‡å®šä¹‰ ===== */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-dark: #0f172a;
            --bg-section: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --accent-red: #ef4444;
            --accent-green: #22c55e;
            --accent-blue: #06b6d4;
            --accent-yellow: #fbbf24;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --accent-orange: #f97316;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.3);
            --animation-duration: 0.3s;
            --content-max-width: 1200px;
        }

        /* äº®è‰²ä¸»é¢˜ */
        [data-theme="light"] {
            --bg-dark: #ffffff;
            --bg-section: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        /* ===== å…¨å±€æ ·å¼ ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: background-color var(--animation-duration) ease;
        }

        /* ===== å¸ƒå±€ç»„ä»¶ ===== */
        .container {
            max-width: var(--content-max-width);
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* ===== å¯¼èˆªæ  ===== */
        .nav-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .nav-header.hidden {
            transform: translateY(-100%);
        }

        .nav-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
        }

        .nav-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-title h1 {
            font-size: 1.25rem;
            font-weight: 600;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn-control {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all var(--animation-duration) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .btn-control:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .nav-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.1);
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* ===== ä¾§è¾¹å¯¼èˆª ===== */
        .sidebar {
            position: fixed;
            left: -300px;
            top: 60px;
            bottom: 0;
            width: 300px;
            background: var(--bg-section);
            border-right: 1px solid var(--border-color);
            padding: 2rem;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 999;
        }

        .sidebar.open {
            transform: translateX(300px);
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 998;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .toc-item {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 0.5rem;
            transition: all var(--animation-duration) ease;
            margin-bottom: 0.25rem;
        }

        .toc-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            transform: translateX(4px);
        }

        .toc-item.active {
            background: var(--primary-gradient);
            color: white;
        }

        /* ===== ä¸»å†…å®¹åŒº ===== */
        main {
            margin-top: 80px;
            padding-bottom: 4rem;
        }

        /* ===== ç« èŠ‚å¡ç‰‡ ===== */
        .chapter-hero {
            background: var(--primary-gradient);
            padding: 4rem 0;
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
        }

        .chapter-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 10s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(180deg); }
        }

        .chapter-hero-content {
            position: relative;
            z-index: 2;
            text-align: center;
            color: white;
        }

        .chapter-hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: fadeInUp 0.8s ease;
        }

        .chapter-hero p {
            font-size: 1.25rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
            animation: fadeInUp 0.8s ease 0.2s both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== å†…å®¹åŒºå— ===== */
        .section-card {
            background: var(--bg-section);
            border-radius: 1rem;
            padding: 2.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            transition: transform var(--animation-duration) ease;
        }

        .section-card:hover {
            transform: translateY(-2px);
        }

        /* ===== å­¦ä¹ å¾ªç¯æŒ‡ç¤ºå™¨ ===== */
        .learning-loop {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 3rem;
            padding: 1.5rem;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 1rem;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .loop-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 0.5rem;
            transition: all var(--animation-duration) ease;
            position: relative;
        }

        .loop-step.active {
            background: rgba(139, 92, 246, 0.2);
            transform: scale(1.1);
        }

        .loop-step .icon {
            font-size: 2rem;
        }

        .loop-step .label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .loop-connector {
            position: absolute;
            top: 50%;
            right: -2rem;
            width: 2rem;
            height: 2px;
            background: rgba(139, 92, 246, 0.3);
        }

        /* ===== æ•…äº‹å¡ç‰‡ ===== */
        .story-card {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.1));
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px solid rgba(251, 191, 36, 0.2);
            position: relative;
            overflow: hidden;
        }

        .story-card::before {
            content: 'ğŸ“–';
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 5rem;
            opacity: 0.1;
            transform: rotate(15deg);
        }

        /* ===== å¯¹è¯æ¡† ===== */
        .dialogue-box {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid var(--accent-purple);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 0.5rem 0.5rem 0;
            position: relative;
        }

        .dialogue-box .speaker {
            font-weight: bold;
            color: var(--accent-purple);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dialogue-box .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        /* ===== æ¦‚å¿µç½‘æ ¼ ===== */
        .concept-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .concept-card {
            padding: 1.5rem;
            border-radius: 0.75rem;
            transition: all var(--animation-duration) ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .concept-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            transform: scaleX(0);
            transition: transform var(--animation-duration) ease;
        }

        .concept-card:hover::before {
            transform: scaleX(1);
        }

        .concept-card.why {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .concept-card.what {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .concept-card.how {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .concept-card.pitfall {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        /* ===== æ•°å­¦å®¹å™¨ ===== */
        .math-container {
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
            position: relative;
        }

        .math-formula {
            text-align: center;
            font-size: 1.2rem;
            margin: 1rem 0;
            overflow-x: auto;
            font-family: 'Times New Roman', serif;
        }

        /* æ•°å­¦åˆ†æ•°æ ·å¼ */
        .math-fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: middle;
            margin: 0 0.3em;
            font-family: 'Times New Roman', serif;
        }

        .math-numerator {
            border-bottom: 2px solid currentColor;
            padding: 0 0.5em 0.2em 0.5em;
        }

        .math-denominator {
            padding: 0.2em 0.5em 0 0.5em;
        }

        .math-sqrt {
            position: relative;
            padding-left: 1em;
            margin-left: 0.2em;
        }

        .math-sqrt::before {
            content: 'âˆš';
            position: absolute;
            left: 0;
            top: -0.1em;
            font-size: 1.2em;
        }

        .math-sqrt::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0.8em;
            right: 0;
            border-top: 2px solid currentColor;
        }

        /* ===== æ•°å­¦è§£é‡Š ===== */
        .math-explanation {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        /* ===== æ€è€ƒç›’å­ ===== */
        .think-box {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(124, 58, 237, 0.1));
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
            position: relative;
        }

        .think-box::before {
            content: 'ğŸ¤”';
            position: absolute;
            top: -15px;
            left: 30px;
            font-size: 2rem;
            background: var(--bg-section);
            padding: 0 10px;
        }

        /* ===== ä»£ç å®¹å™¨ ===== */
        .code-container {
            margin: 2rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .code-header {
            background: #1a1a2e;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .code-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .code-header-right {
            display: flex;
            gap: 0.5rem;
        }

        .code-tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all var(--animation-duration) ease;
        }

        .code-tab.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .code-action {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all var(--animation-duration) ease;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .code-action:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .code-content {
            background: #0d1117;
            overflow-x: auto;
            position: relative;
        }

        .code-content pre {
            margin: 0;
            padding: 1.5rem;
        }

        .code-content code {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .code-output {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            display: none;
        }

        .code-output.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== ä»£ç å¯¹æ¯”æ ·å¼ ===== */
        .code-comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            padding: 1.5rem;
            position: relative;
        }

        .code-comparison-grid::before {
            content: 'VS';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent-purple);
            background: var(--bg-section);
            padding: 0.5rem 1rem;
            border-radius: 50%;
            border: 3px solid var(--accent-purple);
            z-index: 10;
        }

        .code-highlight-add {
            background: rgba(34, 197, 94, 0.3) !important;
            color: var(--accent-green) !important;
            font-weight: bold;
            position: relative;
            display: inline-block;
            padding: 0 4px;
            margin: 0 -4px;
            border-radius: 4px;
        }

        .code-highlight-change {
            background: rgba(251, 191, 36, 0.3) !important;
            color: var(--accent-yellow) !important;
            font-weight: bold;
            position: relative;
            padding: 0 4px;
            margin: 0 -4px;
            border-radius: 4px;
        }

        .code-highlight-key {
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid var(--accent-purple);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* ===== å¯è§†åŒ–å®¹å™¨ ===== */
        .visualization-container {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
            position: relative;
        }

        .viz-controls {
            display: flex;
            gap: 2rem;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .viz-control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .viz-control-group label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        input[type="range"] {
            width: 150px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary-gradient);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider-value {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-family: monospace;
            min-width: 50px;
            text-align: center;
        }

        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
        }

        /* ===== æµ‹éªŒç»„ä»¶ ===== */
        .quiz-container {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
        }

        .quiz-question {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .quiz-options {
            display: grid;
            gap: 1rem;
        }

        .quiz-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 0.5rem;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all var(--animation-duration) ease;
            position: relative;
            overflow: hidden;
            text-align: left;
        }

        .quiz-option:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .quiz-option.selected {
            border-color: var(--accent-blue);
        }

        .quiz-option.correct {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--accent-green);
        }

        .quiz-option.incorrect {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--accent-red);
        }

        .quiz-feedback {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 0.5rem;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .quiz-feedback.show {
            display: block;
        }

        .quiz-feedback.correct {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: var(--accent-green);
        }

        .quiz-feedback.incorrect {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--accent-red);
        }

        /* ===== çŸ©é˜µå¯è§†åŒ– ===== */
        .matrix-visualization {
            display: grid;
            gap: 2rem;
            margin: 2rem 0;
        }

        .matrix-container {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .matrix-title {
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        .matrix-grid {
            display: grid;
            gap: 2px;
            font-family: monospace;
            font-size: 0.875rem;
            max-width: fit-content;
            margin: 0 auto;
        }

        .matrix-cell {
            padding: 0.5rem;
            text-align: center;
            border-radius: 0.25rem;
            min-width: 60px;
            transition: all var(--animation-duration) ease;
        }

        .matrix-cell.header {
            font-weight: bold;
            background: rgba(139, 92, 246, 0.2);
        }

        .matrix-cell.value {
            background: rgba(255, 255, 255, 0.05);
        }

        .matrix-cell.highlight {
            background: rgba(251, 191, 36, 0.3);
            transform: scale(1.1);
        }

        /* ===== æ­¥éª¤æŒ‡ç¤ºå™¨ ===== */
        .step-indicator {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin: 2rem 0;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            z-index: 0;
        }

        .step-item {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .step-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--bg-section);
            border: 3px solid var(--accent-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0 auto 0.5rem;
            transition: all 0.3s ease;
        }

        .step-item.active .step-circle {
            background: var(--accent-purple);
            color: white;
            transform: scale(1.1);
        }

        .step-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* ===== åŠ¨ä½œæ¸…å• ===== */
        .action-checklist {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin: 0.5rem 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            transition: all var(--animation-duration) ease;
        }

        .checklist-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(4px);
        }

        .checklist-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--accent-yellow);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all var(--animation-duration) ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checklist-checkbox.checked {
            background: var(--accent-yellow);
        }

        .checklist-checkbox.checked::after {
            content: 'âœ“';
            color: var(--bg-dark);
            font-weight: bold;
        }

        /* ===== æŒ‰é’®æ ·å¼ ===== */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--animation-duration) ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* ===== æç¤ºæ¡† ===== */
        .tip {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin: 1.5rem 0;
        }

        .tip-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .tip-content {
            flex: 1;
        }

        .tip.info {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .tip.warning {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .tip.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .tip.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        /* ===== å“åº”å¼è®¾è®¡ ===== */
        @media (max-width: 1024px) {
            .chapter-hero h1 {
                font-size: 2.5rem;
            }

            .concept-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .nav-title h1 {
                font-size: 1rem;
            }

            .section-card {
                padding: 1.5rem;
            }

            .chapter-hero {
                padding: 3rem 0;
            }

            .chapter-hero h1 {
                font-size: 2rem;
            }

            .chapter-hero p {
                font-size: 1rem;
            }

            .learning-loop {
                flex-direction: column;
                gap: 1rem;
            }

            .loop-connector {
                display: none;
            }

            .viz-controls {
                flex-direction: column;
                align-items: stretch;
            }

            input[type="range"] {
                width: 100%;
            }

            .matrix-grid {
                font-size: 0.75rem;
            }

            .matrix-cell {
                min-width: 45px;
                padding: 0.25rem;
            }

            .code-comparison-grid {
                grid-template-columns: 1fr;
                gap: 3rem;
            }

            .code-comparison-grid::before {
                display: none;
            }

            .step-indicator {
                flex-direction: column;
                gap: 2rem;
            }

            .step-indicator::before {
                display: none;
            }
        }

        /* ===== å·¥å…·ç±» ===== */
        .text-center {
            text-align: center;
        }

        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mt-4 { margin-top: 2rem; }

        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .mb-4 { margin-bottom: 2rem; }

        /* ===== åŠ è½½åŠ¨ç”» ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-purple);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== è‡ªå®šä¹‰å¯è§†åŒ–åŠ¨ç”» ===== */
        @keyframes gradient-flow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .gradient-animation {
            position: relative;
            overflow: hidden;
        }

        .gradient-animation::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: gradient-flow 3s linear infinite;
        }
    </style>
</head>
<body>

<!-- å¯¼èˆªæ  -->
<nav class="nav-header" role="navigation" aria-label="ä¸»å¯¼èˆª">
    <div class="container">
        <div class="nav-content">
            <div class="nav-title">
                <button id="toggle-sidebar" class="btn-control" aria-label="åˆ‡æ¢ä¾§è¾¹æ ">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <h1>ç¬¬4ç« ï¼šä¼˜åŒ–å›°å¢ƒä¸ç ´å±€ä¹‹é“</h1>
            </div>
            <div class="nav-controls">
                <button id="toggle-animations" class="btn-control" aria-label="åˆ‡æ¢åŠ¨ç”»">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M10 8l6 4-6 4V8z"></path>
                    </svg>
                </button>
                <button id="toggle-theme" class="btn-control" aria-label="åˆ‡æ¢ä¸»é¢˜">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>
        <div class="nav-progress">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
    </div>
</nav>

<!-- ä¾§è¾¹æ  -->
<aside class="sidebar" id="sidebar">
    <h3 style="margin-bottom: 1.5rem; color: var(--accent-purple);">ç›®å½•å¯¼èˆª</h3>
    <nav>
        <a href="#intro" class="toc-item active">æ·±å¤œçš„æŒ«è´¥</a>
        <a href="#discovery" class="toc-item">å‘ç°é—®é¢˜ï¼šæ¢¯åº¦çš„è¯¡å¼‚è¡Œä¸º</a>
        <a href="#analysis" class="toc-item">æ·±å…¥åˆ†æï¼šé“¾å¼æ³•åˆ™çš„ç´¯ç§¯æ•ˆåº”</a>
        <a href="#vanishing" class="toc-item">æ¢¯åº¦æ¶ˆå¤±ï¼šä¸ºä»€ä¹ˆä¼šå‘ç”Ÿ</a>
        <a href="#exploding" class="toc-item">æ¢¯åº¦çˆ†ç‚¸ï¼šå¦ä¸€ä¸ªæç«¯</a>
        <a href="#math-proof" class="toc-item">æ•°å­¦æ¨å¯¼ï¼šä¸¥è°¨çš„è¯æ˜</a>
        <a href="#initialization" class="toc-item">è§£å†³æ–¹æ¡ˆ1ï¼šåˆå§‹åŒ–çš„è‰ºæœ¯</a>
        <a href="#batchnorm" class="toc-item">è§£å†³æ–¹æ¡ˆ2ï¼šæ‰¹é‡å½’ä¸€åŒ–</a>
        <a href="#optimizers" class="toc-item">è§£å†³æ–¹æ¡ˆ3ï¼šä¼˜åŒ–å™¨çš„è¿›åŒ–</a>
        <a href="#practice" class="toc-item">ç»¼åˆå®æˆ˜ï¼šæ„å»ºç¨³å®šç½‘ç»œ</a>
        <a href="#summary" class="toc-item">æ€»ç»“ä¸å±•æœ›</a>
    </nav>
</aside>

<!-- ä¾§è¾¹æ é®ç½© -->
<div class="sidebar-overlay" id="sidebar-overlay"></div>

<!-- ä¸»å†…å®¹ -->
<main>
    <!-- ç« èŠ‚æ ‡é¢˜ -->
    <section class="chapter-hero">
        <div class="container">
            <div class="chapter-hero-content">
                <h1>ä¼˜åŒ–å›°å¢ƒï¼šæ¢¯åº¦æ¶ˆå¤±ã€çˆ†ç‚¸ä¸æ”¶æ•›</h1>
                <p>å½“æˆ‘ä»¬å»ºé€ é€šå¤©å¡”æ—¶ï¼Œæ¯å¢åŠ ä¸€å±‚ï¼Œå›°éš¾å°±ç¿»å€...</p>
                <div class="mt-4">
                    <span style="background: rgba(255, 255, 255, 0.2); padding: 0.5rem 1rem; border-radius: 20px; margin: 0 0.5rem;">
                        ğŸ”¥ æ·±åº¦æŒ‘æˆ˜
                    </span>
                    <span style="background: rgba(255, 255, 255, 0.2); padding: 0.5rem 1rem; border-radius: 20px; margin: 0 0.5rem;">
                        â±ï¸ 120åˆ†é’Ÿ
                    </span>
                    <span style="background: rgba(255, 255, 255, 0.2); padding: 0.5rem 1rem; border-radius: 20px; margin: 0 0.5rem;">
                        ğŸ¯ æ ¸å¿ƒçªç ´
                    </span>
                </div>
            </div>
        </div>
    </section>

    <div class="container">
        <!-- å­¦ä¹ ç›®æ ‡ -->
        <section class="section-card">
            <h2 style="color: var(--accent-purple); margin-bottom: 1.5rem;">ğŸ“š æœ¬ç« å­¦ä¹ ç›®æ ‡</h2>
            <div class="concept-grid">
                <div class="concept-card what">
                    <h3 style="color: var(--accent-green); margin-bottom: 0.5rem;">âœ“ ç†è§£æ¢¯åº¦é—®é¢˜</h3>
                    <p>æ·±å…¥ç†è§£æ¢¯åº¦æ¶ˆå¤±å’Œçˆ†ç‚¸çš„æœ¬è´¨åŸå› </p>
                </div>
                <div class="concept-card how">
                    <h3 style="color: var(--accent-blue); margin-bottom: 0.5rem;">âœ“ æŒæ¡æ•°å­¦åŸç†</h3>
                    <p>é€šè¿‡é“¾å¼æ³•åˆ™æ¨å¯¼ï¼Œçœ‹æ¸…é—®é¢˜çš„æ•°å­¦æœ¬è´¨</p>
                </div>
                <div class="concept-card why">
                    <h3 style="color: var(--accent-red); margin-bottom: 0.5rem;">âœ“ å­¦ä¼šè°ƒè¯•æŠ€å·§</h3>
                    <p>æŒæ¡è¯Šæ–­å’Œè§£å†³æ·±åº¦ç½‘ç»œè®­ç»ƒé—®é¢˜çš„æ–¹æ³•</p>
                </div>
                <div class="concept-card pitfall">
                    <h3 style="color: var(--accent-yellow); margin-bottom: 0.5rem;">âœ“ åº”ç”¨æœ€ä½³å®è·µ</h3>
                    <p>å­¦ä¼šç»¼åˆè¿ç”¨å¤šç§æŠ€æœ¯æ„å»ºç¨³å®šçš„æ·±åº¦ç½‘ç»œ</p>
                </div>
            </div>
        </section>

        <!-- åºç« ï¼šæ·±å¤œçš„æŒ«è´¥ -->
        <section id="intro" class="section-card">
            <div class="story-card">
                <h2 style="color: var(--accent-yellow); margin-bottom: 1.5rem;">ğŸŒƒ æ·±å¤œå®éªŒå®¤çš„ç»æœ›</h2>

                <p style="font-size: 1.1rem; line-height: 1.8; margin-bottom: 2rem;">
                    å‡Œæ™¨2:47ï¼Œè®¡ç®—æœºç§‘å­¦æ¥¼5å±‚çš„å®éªŒå®¤é‡Œï¼Œåªæœ‰é”®ç›˜æ•²å‡»å£°å’Œé£æ‰‡çš„å—¡å—¡å£°ã€‚
                </p>

                <div class="dialogue-box">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">ğŸ§‘â€ğŸ’»</div>
                        å°æï¼ˆç ”ç©¶ç”Ÿï¼‰ï¼š
                    </div>
                    <div>"ä¸å¯èƒ½ï¼ä¸ºä»€ä¹ˆæˆ‘çš„30å±‚ç½‘ç»œæ¯”3å±‚çš„è¿˜å·®ï¼Ÿæˆ‘æ˜æ˜æŒ‰ç…§è®ºæ–‡å®ç°çš„..."</div>
                </div>

                <p style="margin-top: 1.5rem;">
                    å±å¹•ä¸Šï¼Œè®­ç»ƒæ—¥å¿—æ— æƒ…åœ°æ˜¾ç¤ºç€ï¼š
                </p>

                <div style="background: #000; color: #0f0; font-family: monospace; padding: 1.5rem; border-radius: 0.5rem; margin: 1rem 0;">
                    Epoch 1/100 - Loss: 2.3026 - Accuracy: 10.0%<br>
                    Epoch 10/100 - Loss: 2.3026 - Accuracy: 10.0%<br>
                    Epoch 20/100 - Loss: 2.3026 - Accuracy: 10.0%<br>
                    ...<br>
                    Epoch 50/100 - Loss: 2.3026 - Accuracy: 10.0%<br>
                    <span style="color: #f00;">WARNING: Loss unchanged for 50 epochs!</span>
                </div>

                <div class="dialogue-box">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">ğŸ‘¨â€ğŸ”¬</div>
                        å®¤å‹å°å¼ ï¼ˆå‡‘è¿‡æ¥ï¼‰ï¼š
                    </div>
                    <div>"2.3026...è¿™ä¸æ˜¯log(10)å—ï¼Ÿä½ çš„ç½‘ç»œæ ¹æœ¬æ²¡åœ¨å­¦ä¹ ï¼Œå®ƒåœ¨éšæœºçŒœï¼"</div>
                </div>

                <div class="think-box">
                    <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">ğŸ’­ æ€è€ƒä¸€ä¸‹</h3>
                    <p>ä¸ºä»€ä¹ˆæŸå¤±å‡½æ•°æ°å¥½æ˜¯2.3026ï¼Ÿè¿™ä¸ªæ•°å­—èƒŒåéšè—ç€ä»€ä¹ˆç§˜å¯†ï¼Ÿ</p>
                    <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                        æç¤ºï¼šå¯¹äº10åˆ†ç±»é—®é¢˜ï¼Œå¦‚æœæ¨¡å‹è¾“å‡ºå‡åŒ€åˆ†å¸ƒï¼ˆæ¯ç±»æ¦‚ç‡0.1ï¼‰ï¼Œäº¤å‰ç†µæŸå¤±æ˜¯å¤šå°‘ï¼Ÿ
                    </p>
                </div>

                <div class="dialogue-box mt-3">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #ef4444, #dc2626);">ğŸ˜¤</div>
                        å°æï¼ˆæ„¤æ€’åœ°ï¼‰ï¼š
                    </div>
                    <div>"æˆ‘æ£€æŸ¥äº†ä»£ç åéï¼Œæ²¡æœ‰bugï¼éš¾é“æ·±åº¦å­¦ä¹ å°±æ˜¯ä¸ªè°è¨€ï¼Ÿ"</div>
                </div>

                <div class="tip info">
                    <span class="tip-icon">ğŸ’¡</span>
                    <div class="tip-content">
                        <strong>å…³é”®æ´å¯Ÿï¼š</strong><br>
                        å½“æŸå¤±å‡½æ•°ä¿æŒåœ¨ -log(1/ç±»åˆ«æ•°) æ—¶ï¼Œè¯´æ˜æ¨¡å‹åœ¨è¾“å‡ºå‡åŒ€åˆ†å¸ƒï¼Œå®Œå…¨æ²¡æœ‰å­¦åˆ°ä»»ä½•æ¨¡å¼ã€‚è¿™é€šå¸¸æ„å‘³ç€æ¢¯åº¦åœ¨ä¼ æ’­è¿‡ç¨‹ä¸­å‡ºäº†é—®é¢˜ã€‚
                    </div>
                </div>
            </div>
        </section>

        <!-- ç¬¬ä¸€æ­¥ï¼šå‘ç°é—®é¢˜ -->
        <section id="discovery" class="section-card">
            <h2 style="color: var(--accent-red); margin-bottom: 1.5rem;">ğŸ” Step 1ï¼šæŠ½ä¸å‰¥èŒ§ï¼Œå‘ç°é—®é¢˜</h2>

            <div class="learning-loop">
                <div class="loop-step active">
                    <div class="icon">ğŸ”</div>
                    <div class="label">å‘ç°å¼‚å¸¸</div>
                    <div class="loop-connector"></div>
                </div>
                <div class="loop-step">
                    <div class="icon">ğŸ“Š</div>
                    <div class="label">æ”¶é›†æ•°æ®</div>
                    <div class="loop-connector"></div>
                </div>
                <div class="loop-step">
                    <div class="icon">ğŸ§®</div>
                    <div class="label">åˆ†æåŸå› </div>
                    <div class="loop-connector"></div>
                </div>
                <div class="loop-step">
                    <div class="icon">ğŸ’¡</div>
                    <div class="label">æ‰¾åˆ°è§£å†³æ–¹æ¡ˆ</div>
                </div>
            </div>

            <div class="story-card">
                <h3 style="color: var(--accent-orange); margin-bottom: 1rem;">ç¬¬ä¸€æ­¥ï¼šæ‰“å°æ¢¯åº¦çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ</h3>

                <div class="dialogue-box">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">ğŸ§™â€â™‚ï¸</div>
                        å¯¼å¸ˆï¼ˆæ¨é—¨è¿›æ¥ï¼‰ï¼š
                    </div>
                    <div>"åˆ«æ€¥ç€å¦å®šæ·±åº¦å­¦ä¹ ã€‚ä½ æ£€æŸ¥è¿‡æ¯ä¸€å±‚çš„æ¢¯åº¦å—ï¼Ÿ"</div>
                </div>

                <p style="margin-top: 1.5rem;">å°ææç„¶å¤§æ‚Ÿï¼Œç«‹å³ä¿®æ”¹ä»£ç ï¼Œæ·»åŠ æ¢¯åº¦ç›‘æ§ï¼š</p>

                <div class="code-container">
                    <div class="code-header">
                        <div class="code-header-left">
                            <span style="color: var(--text-secondary);">gradient_monitor.py - æ¢¯åº¦ç›‘æ§å·¥å…·</span>
                        </div>
                        <div class="code-header-right">
                            <button class="code-action" onclick="runCode(this, 'gradient-output')">
                                â–¶ è¿è¡Œä»£ç 
                            </button>
                        </div>
                    </div>
                    <div class="code-content">
                        <pre><code class="language-python">import torch
import torch.nn as nn
import numpy as np
import matplotlib.pyplot as plt

class GradientMonitor:
    """æ¢¯åº¦ç›‘æ§å·¥å…·ï¼Œç”¨äºè¯Šæ–­æ·±åº¦ç½‘ç»œè®­ç»ƒé—®é¢˜"""

    def __init__(self):
        self.gradients = {}
        self.activations = {}

    def hook_layers(self, model):
        """ä¸ºæ¯ä¸€å±‚æ·»åŠ é’©å­å‡½æ•°"""
        def forward_hook(module, input, output):
            # è®°å½•æ¿€æ´»å€¼
            self.activations[module] = output.detach()

        def backward_hook(module, grad_input, grad_output):
            # è®°å½•æ¢¯åº¦
            if hasattr(module, 'weight'):
                self.gradients[module] = module.weight.grad.clone()

        for name, module in model.named_modules():
            if isinstance(module, nn.Linear) or isinstance(module, nn.Conv2d):
                module.register_forward_hook(forward_hook)
                module.register_backward_hook(backward_hook)

    def analyze_gradients(self):
        """åˆ†ææ¢¯åº¦åˆ†å¸ƒ"""
        results = []

        for i, (module, grad) in enumerate(self.gradients.items()):
            if grad is not None:
                grad_norm = grad.norm().item()
                grad_mean = grad.mean().item()
                grad_std = grad.std().item()

                results.append({
                    'layer': i + 1,
                    'norm': grad_norm,
                    'mean': grad_mean,
                    'std': grad_std
                })

        return results

# åˆ›å»ºä¸€ä¸ªæœ‰é—®é¢˜çš„æ·±åº¦ç½‘ç»œ
class ProblematicDeepNetwork(nn.Module):
    """ä¸€ä¸ª30å±‚çš„æ·±åº¦ç½‘ç»œï¼ˆæœ‰é—®é¢˜çš„ç‰ˆæœ¬ï¼‰"""
    def __init__(self, num_layers=30):
        super().__init__()
        self.layers = nn.ModuleList()

        # æ„å»ºæ·±åº¦ç½‘ç»œ
        for i in range(num_layers):
            self.layers.append(nn.Linear(100, 100))
            self.layers.append(nn.Sigmoid())  # ä½¿ç”¨Sigmoidæ¿€æ´»ï¼ˆé—®é¢˜æ‰€åœ¨ï¼ï¼‰

    def forward(self, x):
        for layer in self.layers:
            x = layer(x)
        return x

# æµ‹è¯•æ¢¯åº¦
print("ğŸ” å¼€å§‹æ¢¯åº¦åˆ†æ...")
model = ProblematicDeepNetwork(30)
monitor = GradientMonitor()
monitor.hook_layers(model)

# å‰å‘ä¼ æ’­
x = torch.randn(32, 100, requires_grad=True)
y_true = torch.randint(0, 10, (32,))
output = model(x)

# è®¡ç®—æŸå¤±
loss = nn.CrossEntropyLoss()(output[:, :10], y_true)
print(f"\nğŸ“Š æŸå¤±å€¼: {loss.item():.4f}")

# åå‘ä¼ æ’­
loss.backward()

# åˆ†æç»“æœ
results = monitor.analyze_gradients()

print("\nğŸ”¬ æ¢¯åº¦åˆ†æç»“æœ:")
print("-" * 60)
print(f"{'å±‚æ•°':>6} | {'æ¢¯åº¦èŒƒæ•°':>12} | {'æ¢¯åº¦å‡å€¼':>12} | {'æ¢¯åº¦æ ‡å‡†å·®':>12}")
print("-" * 60)

for r in results[:5]:  # æ˜¾ç¤ºå‰5å±‚
    print(f"{r['layer']:>6} | {r['norm']:>12.2e} | {r['mean']:>12.2e} | {r['std']:>12.2e}")
print("...")
for r in results[-5:]:  # æ˜¾ç¤ºå5å±‚
    print(f"{r['layer']:>6} | {r['norm']:>12.2e} | {r['mean']:>12.2e} | {r['std']:>12.2e}")</code></pre>
                    </div>
                    <div id="gradient-output" class="code-output">
                        <pre>ğŸ” å¼€å§‹æ¢¯åº¦åˆ†æ...

ğŸ“Š æŸå¤±å€¼: 2.3026

ğŸ”¬ æ¢¯åº¦åˆ†æç»“æœ:
------------------------------------------------------------
  å±‚æ•° |     æ¢¯åº¦èŒƒæ•° |     æ¢¯åº¦å‡å€¼ |   æ¢¯åº¦æ ‡å‡†å·®
------------------------------------------------------------
     1 |     3.45e-15 |     1.23e-17 |     3.45e-17
     2 |     2.31e-12 |     5.67e-14 |     2.31e-14
     3 |     8.92e-09 |     4.56e-11 |     8.92e-11
     4 |     1.23e-07 |     7.89e-09 |     1.23e-09
     5 |     4.56e-06 |     2.34e-08 |     4.56e-08
...
    26 |     2.34e-02 |     1.23e-04 |     2.34e-04
    27 |     1.56e-01 |     7.89e-03 |     1.56e-03
    28 |     4.23e-01 |     2.34e-02 |     4.23e-02
    29 |     5.67e-01 |     4.56e-02 |     5.67e-02
    30 |     7.23e-01 |     6.78e-02 |     7.23e-02</pre>
                    </div>
                </div>

                <div class="think-box mt-3">
                    <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">ğŸ˜± éœ‡æƒŠçš„å‘ç°</h3>
                    <p>çœ‹åˆ°è¿™ä¸ªç»“æœï¼Œä½ å‘ç°äº†ä»€ä¹ˆï¼Ÿ</p>
                    <ul style="margin-left: 2rem; margin-top: 1rem;">
                        <li>ç¬¬1å±‚çš„æ¢¯åº¦å‡ ä¹ä¸º0ï¼ˆ10^-15ï¼‰</li>
                        <li>ç¬¬30å±‚çš„æ¢¯åº¦æ­£å¸¸ï¼ˆ10^-1ï¼‰</li>
                        <li>æ¢¯åº¦ä»åå¾€å‰æ€¥å‰§å‡å°ï¼Œç›¸å·®16ä¸ªæ•°é‡çº§ï¼</li>
                    </ul>
                    <p style="margin-top: 1rem; color: var(--accent-red); font-weight: bold;">
                        è¿™å°±æ˜¯ä¼ è¯´ä¸­çš„"æ¢¯åº¦æ¶ˆå¤±"ï¼
                    </p>
                </div>
            </div>

            <!-- å¯è§†åŒ–æ¢¯åº¦æµ -->
            <div class="visualization-container">
                <h3 style="color: var(--accent-yellow); margin-bottom: 1.5rem;">ğŸ“Š å¯è§†åŒ–ï¼šæ¢¯åº¦åœ¨ç½‘ç»œä¸­çš„è¡°å‡</h3>

                <div class="viz-controls">
                    <button class="btn btn-primary" onclick="visualizeGradientFlow()">
                        ğŸ¨ ç»˜åˆ¶æ¢¯åº¦æµ
                    </button>
                    <button class="btn btn-secondary" onclick="animateGradientFlow()">
                        â–¶ï¸ æ’­æ”¾åŠ¨ç”»
                    </button>
                </div>

                <canvas id="gradient-flow-viz" width="800" height="400"></canvas>

                <div class="tip error mt-3">
                    <span class="tip-icon">âš ï¸</span>
                    <div class="tip-content">
                        <strong>è§‚å¯Ÿè¦ç‚¹ï¼š</strong><br>
                        â€¢ Yè½´ä½¿ç”¨å¯¹æ•°åˆ»åº¦ï¼Œå› ä¸ºæ¢¯åº¦å·®å¼‚å¤ªå¤§<br>
                        â€¢ æ¢¯åº¦åœ¨å‰å‡ å±‚å‡ ä¹æ¶ˆå¤±ä¸º0<br>
                        â€¢ è¿™æ„å‘³ç€å‰é¢çš„å±‚å‡ ä¹æ— æ³•æ›´æ–°ï¼
                    </div>
                </div>
            </div>
        </section>

        <!-- ç¬¬äºŒæ­¥ï¼šåˆ†æåŸå›  -->
        <section id="analysis" class="section-card">
            <h2 style="color: var(--accent-purple); margin-bottom: 1.5rem;">ğŸ§® Step 2ï¼šæ·±å…¥åˆ†æï¼Œç†è§£æœ¬è´¨</h2>

            <div class="story-card">
                <h3 style="color: var(--accent-blue); margin-bottom: 1rem;">ä¸ºä»€ä¹ˆæ¢¯åº¦ä¼šæ¶ˆå¤±ï¼Ÿè®©æˆ‘ä»¬ç”¨æ•°å­¦æ¥ç†è§£</h3>

                <div class="dialogue-box">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">ğŸ§™â€â™‚ï¸</div>
                        å¯¼å¸ˆï¼š
                    </div>
                    <div>"è¿˜è®°å¾—é“¾å¼æ³•åˆ™å—ï¼Ÿåœ¨æ·±åº¦ç½‘ç»œä¸­ï¼Œæ¢¯åº¦è¦ç»è¿‡å¾ˆå¤šå±‚çš„ä¼ é€’..."</div>
                </div>
            </div>

            <!-- æ•°å­¦æ¨å¯¼ï¼šç®€åŒ–ç‰ˆ -->
            <div class="math-container">
                <h3 style="color: var(--accent-green); margin-bottom: 1.5rem;">ğŸ“ é“¾å¼æ³•åˆ™ï¼šæ¢¯åº¦æ˜¯å¦‚ä½•ä¼ æ’­çš„</h3>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 0.5rem; margin-bottom: 2rem;">
                    <h4 style="color: var(--accent-blue); margin-bottom: 1rem;">ä»ç®€å•ä¾‹å­å¼€å§‹ï¼š3å±‚ç½‘ç»œ</h4>

                    <div class="step-indicator">
                        <div class="step-item active">
                            <div class="step-circle">1</div>
                            <div class="step-label">å‰å‘ä¼ æ’­</div>
                        </div>
                        <div class="step-item">
                            <div class="step-circle">2</div>
                            <div class="step-label">è®¡ç®—æŸå¤±</div>
                        </div>
                        <div class="step-item">
                            <div class="step-circle">3</div>
                            <div class="step-label">åå‘ä¼ æ’­</div>
                        </div>
                        <div class="step-item">
                            <div class="step-circle">4</div>
                            <div class="step-label">å‘ç°é—®é¢˜</div>
                        </div>
                    </div>

                    <div class="math-formula" style="margin-top: 2rem;">
                        <div style="margin-bottom: 1rem;">å‰å‘ä¼ æ’­è¿‡ç¨‹ï¼š</div>
                        <div style="text-align: left; padding-left: 2rem; font-family: 'Courier New', monospace;">
                            z<sub>1</sub> = W<sub>1</sub>x + b<sub>1</sub><br>
                            a<sub>1</sub> = Ïƒ(z<sub>1</sub>)  <span style="color: var(--accent-yellow);">â† Sigmoidæ¿€æ´»</span><br><br>
                            z<sub>2</sub> = W<sub>2</sub>a<sub>1</sub> + b<sub>2</sub><br>
                            a<sub>2</sub> = Ïƒ(z<sub>2</sub>)<br><br>
                            z<sub>3</sub> = W<sub>3</sub>a<sub>2</sub> + b<sub>3</sub><br>
                            Å· = Ïƒ(z<sub>3</sub>)
                        </div>
                    </div>

                    <div class="math-explanation">
                        <strong>ç¬¦å·è¯´æ˜ï¼š</strong><br>
                        â€¢ z æ˜¯çº¿æ€§å˜æ¢çš„ç»“æœï¼ˆåŠ æƒæ±‚å’Œï¼‰<br>
                        â€¢ a æ˜¯æ¿€æ´»åçš„è¾“å‡º<br>
                        â€¢ Ïƒ æ˜¯Sigmoidæ¿€æ´»å‡½æ•°<br>
                        â€¢ W æ˜¯æƒé‡çŸ©é˜µï¼Œb æ˜¯åç½®
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 0.5rem;">
                    <h4 style="color: var(--accent-red); margin-bottom: 1rem;">åå‘ä¼ æ’­ï¼šè®¡ç®—ç¬¬1å±‚æƒé‡çš„æ¢¯åº¦</h4>

                    <div class="math-formula" style="font-size: 1.3rem;">
                        <div class="math-fraction">
                            <div class="math-numerator">âˆ‚L</div>
                            <div class="math-denominator">âˆ‚Wâ‚</div>
                        </div>
                        =
                        <div class="math-fraction">
                            <div class="math-numerator">âˆ‚L</div>
                            <div class="math-denominator">âˆ‚Å·</div>
                        </div>
                        Ã—
                        <div class="math-fraction">
                            <div class="math-numerator">âˆ‚Å·</div>
                            <div class="math-denominator">âˆ‚zâ‚ƒ</div>
                        </div>
                        Ã—
                        <div class="math-fraction">
                            <div class="math-numerator">âˆ‚zâ‚ƒ</div>
                            <div class="math-denominator">âˆ‚aâ‚‚</div>
                        </div>
                        Ã—
                        <span style="color: var(--accent-red);">
                        <div class="math-fraction">
                            <div class="math-numerator">âˆ‚aâ‚‚</div>
                            <div class="math-denominator">âˆ‚zâ‚‚</div>
                        </div>
                        </span>
                        Ã—
                        <div class="math-fraction">
                            <div class="math-numerator">âˆ‚zâ‚‚</div>
                            <div class="math-denominator">âˆ‚aâ‚</div>
                        </div>
                        Ã—
                        <span style="color: var(--accent-red);">
                        <div class="math-fraction">
                            <div class="math-numerator">âˆ‚aâ‚</div>
                            <div class="math-denominator">âˆ‚zâ‚</div>
                        </div>
                        </span>
                        Ã—
                        <div class="math-fraction">
                            <div class="math-numerator">âˆ‚zâ‚</div>
                            <div class="math-denominator">âˆ‚Wâ‚</div>
                        </div>
                    </div>

                    <div class="math-explanation" style="margin-top: 2rem;">
                        <strong>å…³é”®æ´å¯Ÿï¼š</strong><br>
                        çº¢è‰²éƒ¨åˆ†
                        <span style="display: inline-flex; align-items: center;">
                            <span class="math-fraction">
                                <span class="math-numerator">âˆ‚a</span>
                                <span class="math-denominator">âˆ‚z</span>
                            </span>
                            = Ïƒ'(z)
                        </span>
                        æ˜¯Sigmoidçš„å¯¼æ•°ï¼
                    </div>
                </div>
            </div>

            <!-- Sigmoidé—®é¢˜å¯è§†åŒ– -->
            <div class="visualization-container">
                <h3 style="color: var(--accent-yellow); margin-bottom: 1.5rem;">ğŸ“Š Sigmoidå‡½æ•°çš„è‡´å‘½ç¼ºé™·</h3>

                <div class="viz-controls">
                    <div class="viz-control-group">
                        <label>è¾“å…¥èŒƒå›´ï¼š</label>
                        <div class="slider-container">
                            <input type="range" id="sigmoid-range" min="1" max="10" value="5" step="1">
                            <span class="slider-value" id="sigmoid-range-value">Â±5</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="updateSigmoidPlot()">
                        æ›´æ–°å›¾è¡¨
                    </button>
                </div>

                <canvas id="sigmoid-viz" width="800" height="400"></canvas>

                <div class="tip error mt-3">
                    <span class="tip-icon">ğŸ’€</span>
                    <div class="tip-content">
                        <strong>è‡´å‘½é—®é¢˜ï¼š</strong><br>
                        â€¢ Sigmoidå¯¼æ•°çš„æœ€å¤§å€¼åªæœ‰0.25ï¼<br>
                        â€¢ å½“|x| > 5æ—¶ï¼Œå¯¼æ•°æ¥è¿‘0ï¼ˆé¥±å’Œç°è±¡ï¼‰<br>
                        â€¢ 30å±‚ç½‘ç»œï¼š0.25Â³â° â‰ˆ 8.67 Ã— 10â»Â¹â¹
                    </div>
                </div>
            </div>

            <!-- æ·»åŠ åœ¨"é“¾å¼æ³•åˆ™"æ•°å­¦æ¨å¯¼ä¹‹åï¼Œ"Sigmoidé—®é¢˜å¯è§†åŒ–"ä¹‹å‰ -->

            <!-- è¿‡æ¸¡1ï¼šä»3å±‚åˆ°æ·±å±‚ -->
            <div class="think-box mt-4">
                <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">ğŸ¤” ä»3å±‚åˆ°30å±‚ï¼šé—®é¢˜åœ¨å“ªé‡Œï¼Ÿ</h3>
                <p>3å±‚ç½‘ç»œçœ‹èµ·æ¥è¿˜å¥½ï¼Œä½†å¦‚æœæ˜¯30å±‚å‘¢ï¼Ÿè®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ¨å¯¼...</p>
            </div>

            <div class="math-container mt-3">
                <h4 style="color: var(--accent-yellow); margin-bottom: 1.5rem;">ğŸ“ˆ æ¢¯åº¦ä¼ æ’­çš„æ•°å­¦æœ¬è´¨</h4>

                <div class="step-indicator">
                    <div class="step-item active">
                        <div class="step-circle">1</div>
                        <div class="step-label">ç†è§£å¯¼æ•°é“¾</div>
                    </div>
                    <div class="step-item">
                        <div class="step-circle">2</div>
                        <div class="step-label">å‘ç°è§„å¾‹</div>
                    </div>
                    <div class="step-item">
                        <div class="step-circle">3</div>
                        <div class="step-label">è®¡ç®—ç´¯ç§¯</div>
                    </div>
                    <div class="step-item">
                        <div class="step-circle">4</div>
                        <div class="step-label">å‘ç°é—®é¢˜</div>
                    </div>
                </div>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 0.5rem; margin-top: 2rem;">
                    <h5 style="color: var(--accent-green);">Step 1: ç†è§£æ¯ä¸€å±‚çš„è´¡çŒ®</h5>

                    <p>å›é¡¾åˆšæ‰çš„é“¾å¼æ³•åˆ™ï¼Œæ³¨æ„åˆ°çº¢è‰²éƒ¨åˆ† <span style="color: var(--accent-red);">âˆ‚a/âˆ‚z = Ïƒ'(z)</span></p>

                    <div class="math-formula">
                        å¯¹äºLå±‚ç½‘ç»œï¼Œç¬¬1å±‚æƒé‡çš„æ¢¯åº¦åŒ…å«Lä¸ªè¿™æ ·çš„é¡¹ï¼š<br><br>

                        <div style="text-align: center; font-size: 1.2rem;">
                            âˆ‚L/âˆ‚Wâ‚ = ... Ã— Ïƒ'(z_L) Ã— ... Ã— Ïƒ'(zâ‚ƒ) Ã— Ïƒ'(zâ‚‚) Ã— Ïƒ'(zâ‚) Ã— ...
                        </div>
                    </div>

                    <div class="math-explanation">
                        <strong>å…³é”®æ´å¯Ÿï¼š</strong>æ¯ç»è¿‡ä¸€å±‚ï¼Œæ¢¯åº¦éƒ½è¦ä¹˜ä»¥è¯¥å±‚æ¿€æ´»å‡½æ•°çš„å¯¼æ•°ï¼
                    </div>
                </div>
            </div>

            <!-- è¿‡æ¸¡2ï¼šSigmoidå¯¼æ•°çš„ç‰¹æ€§ -->
            <div class="concept-grid mt-4">
                <div class="concept-card what">
                    <h4 style="color: var(--accent-green); margin-bottom: 0.5rem;">Sigmoidå¯¼æ•°çš„æ€§è´¨</h4>
                    <p>
                        Ïƒ'(x) = Ïƒ(x)(1-Ïƒ(x))<br>
                        â€¢ å½“x=0æ—¶æœ€å¤§ï¼š0.25<br>
                        â€¢ å½“|x|>5æ—¶ï¼šæ¥è¿‘0<br>
                        â€¢ å§‹ç»ˆåœ¨[0, 0.25]èŒƒå›´å†…
                    </p>
                </div>

                <div class="concept-card why">
                    <h4 style="color: var(--accent-red); margin-bottom: 0.5rem;">ä¸ºä»€ä¹ˆè¿™æ˜¯é—®é¢˜ï¼Ÿ</h4>
                    <p>
                        æ¯å±‚éƒ½ä¹˜ä»¥â‰¤0.25çš„æ•°ï¼š<br>
                        â€¢ 10å±‚ï¼š0.25Â¹â° â‰ˆ 10â»â¶<br>
                        â€¢ 20å±‚ï¼š0.25Â²â° â‰ˆ 10â»Â¹Â²<br>
                        â€¢ 30å±‚ï¼š0.25Â³â° â‰ˆ 10â»Â¹â¸
                    </p>
                </div>
            </div>

            <!-- è¿‡æ¸¡3ï¼šç›´è§‚çš„ç±»æ¯” -->
            <div class="story-card mt-4">
                <h3 style="color: var(--accent-orange); margin-bottom: 1rem;">ğŸ“ ä¸€ä¸ªç”ŸåŠ¨çš„ç±»æ¯”ï¼šä¼ è¯æ¸¸æˆ</h3>

                <div class="dialogue-box">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">ğŸ§™â€â™‚ï¸</div>
                        å¯¼å¸ˆï¼š
                    </div>
                    <div>"æƒ³è±¡30ä¸ªäººç«™æˆä¸€æ’ç©ä¼ è¯æ¸¸æˆã€‚æ¯ä¸ªäººåªèƒ½æŠŠå¬åˆ°éŸ³é‡çš„25%ä¼ ç»™ä¸‹ä¸€ä¸ªäºº..."</div>
                </div>

                <div style="background: rgba(251, 191, 36, 0.1); padding: 1.5rem; border-radius: 0.5rem; margin-top: 1rem;">
                    <p><strong>ç¬¬1ä¸ªäººï¼š</strong>å¤§å£°å–Š "æ›´æ–°æƒé‡ï¼"ï¼ˆéŸ³é‡=1.0ï¼‰</p>
                    <p><strong>ç¬¬10ä¸ªäººï¼š</strong>å‹‰å¼ºå¬åˆ° "æ›´...é‡..."ï¼ˆéŸ³é‡=0.000001ï¼‰</p>
                    <p><strong>ç¬¬20ä¸ªäººï¼š</strong>ä»€ä¹ˆéƒ½å¬ä¸åˆ°äº†ï¼ˆéŸ³é‡=0.000000000001ï¼‰</p>
                    <p><strong>ç¬¬30ä¸ªäººï¼š</strong>ğŸ˜µ å®Œå…¨é™éŸ³ï¼ˆéŸ³é‡â‰ˆ0ï¼‰</p>
                </div>
            </div>

            <!-- è¿‡æ¸¡4ï¼šé€æ­¥å±•ç¤ºé—®é¢˜ -->
            <div class="visualization-container mt-4">
                <h3 style="color: var(--accent-red); margin-bottom: 1.5rem;">ğŸ” è®©æˆ‘ä»¬é€å±‚çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ</h3>

                <div class="code-container">
                    <div class="code-header">
                        <div class="code-header-left">
                            <span style="color: var(--text-secondary);">step_by_step_analysis.py - é€æ­¥åˆ†ææ¢¯åº¦è¡°å‡</span>
                        </div>
                    </div>
                    <div class="code-content">
            <pre><code class="language-python"># è®©æˆ‘ä»¬ä¸€æ­¥æ­¥çœ‹æ¢¯åº¦æ˜¯å¦‚ä½•è¡°å‡çš„
import numpy as np

def analyze_gradient_decay():
    """é€å±‚åˆ†ææ¢¯åº¦è¡°å‡è¿‡ç¨‹"""

    print("ğŸ”¬ Sigmoidæ¢¯åº¦è¡°å‡åˆ†æ")
    print("=" * 50)

    # Sigmoidå¯¼æ•°çš„å…¸å‹å€¼
    sigmoid_derivative_avg = 0.2  # å®é™…å¹³å‡å€¼
    sigmoid_derivative_max = 0.25  # ç†è®ºæœ€å¤§å€¼

    # é€å±‚è®¡ç®—
    gradient = 1.0  # ä»è¾“å‡ºå±‚å¼€å§‹

    key_layers = [1, 3, 5, 10, 20, 30]

    for layer in range(1, 31):
        # ä½¿ç”¨å¹³å‡å€¼è®¡ç®—
        gradient *= sigmoid_derivative_avg

        if layer in key_layers:
            print(f"\nç¬¬{layer}å±‚å:")
            print(f"  æ¢¯åº¦å¤§å°: {gradient:.2e}")
            print(f"  ç›¸å¯¹äºåˆå§‹: {gradient:.2%}")

            # å½¢è±¡åŒ–å±•ç¤º
            bar_length = int(max(0, 50 + np.log10(gradient) * 5))
            bar = "â–ˆ" * bar_length
            print(f"  å¯è§†åŒ–: [{bar:<50}]")

            if gradient < 1e-10:
                print("  âš ï¸ è­¦å‘Šï¼šæ¢¯åº¦å·²ç»å°åˆ°è®¡ç®—æœºéš¾ä»¥å‡†ç¡®è¡¨ç¤ºï¼")

# è¿è¡Œåˆ†æ
analyze_gradient_decay()</code></pre>
                    </div>
                </div>
            </div>

            <!-- ç°åœ¨è‡ªç„¶è¿‡æ¸¡åˆ°"è‡´å‘½é—®é¢˜" -->
            <div class="tip error mt-4">
                <span class="tip-icon">ğŸ’€</span>
                <div class="tip-content">
                    <strong>ç°åœ¨ä½ æ˜ç™½äº†å—ï¼Ÿ</strong><br>
                    è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¯´Sigmoidæœ‰"è‡´å‘½é—®é¢˜"ï¼š<br>
                    â€¢ Sigmoidå¯¼æ•°çš„æœ€å¤§å€¼åªæœ‰0.25ï¼<br>
                    â€¢ å½“|x| > 5æ—¶ï¼Œå¯¼æ•°æ¥è¿‘0ï¼ˆé¥±å’Œç°è±¡ï¼‰<br>
                    â€¢ 30å±‚ç½‘ç»œï¼š0.25Â³â° â‰ˆ 8.67 Ã— 10â»Â¹â¹<br>
                    <br>
                    æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬é€šè¿‡å¯è§†åŒ–å’Œå…·ä½“è®¡ç®—æ¥æ·±å…¥ç†è§£è¿™ä¸ªé—®é¢˜...
                </div>
            </div>

            <!-- å…·ä½“è®¡ç®—ç¤ºä¾‹ -->
            <div class="math-container mt-3">
                <h3 style="color: var(--accent-red); margin-bottom: 1.5rem;">ğŸ”¢ å…·ä½“è®¡ç®—ï¼š30å±‚ç½‘ç»œçš„æ¢¯åº¦æ¶ˆå¤±</h3>

                <div class="code-container">
                    <div class="code-header">
                        <div class="code-header-left">
                            <span style="color: var(--text-secondary);">gradient_calculation.py - æ¢¯åº¦ç´¯ç§¯è®¡ç®—</span>
                        </div>
                        <div class="code-header-right">
                            <button class="code-action" onclick="runCode(this, 'calc-output')">
                                â–¶ è¿è¡Œè®¡ç®—
                            </button>
                        </div>
                    </div>
                    <div class="code-content">
                        <pre><code class="language-python">import numpy as np
import matplotlib.pyplot as plt

def sigmoid_derivative(x):
    """Sigmoidå‡½æ•°çš„å¯¼æ•°"""
    s = 1 / (1 + np.exp(-x))
    return s * (1 - s)

def calculate_gradient_flow(num_layers=30):
    """è®¡ç®—æ¢¯åº¦åœ¨æ·±åº¦ç½‘ç»œä¸­çš„è¡°å‡"""

    # å‡è®¾æ¯å±‚çš„æ¿€æ´»å€¼åœ¨åˆç†èŒƒå›´å†…
    # Sigmoidå¯¼æ•°çš„å¹³å‡å€¼çº¦ä¸º0.2
    avg_sigmoid_derivative = 0.2

    # å‡è®¾æƒé‡çŸ©é˜µçš„è°±èŒƒæ•°çº¦ä¸º1
    weight_norm = 1.0

    # è®¡ç®—æ¯å±‚çš„æ¢¯åº¦è¡°å‡
    gradient_scale = []
    current_gradient = 1.0  # ä»è¾“å‡ºå±‚å¼€å§‹ï¼Œæ¢¯åº¦ä¸º1

    for layer in range(num_layers):
        # æ¢¯åº¦è¦ä¹˜ä»¥æ¿€æ´»å‡½æ•°å¯¼æ•°å’Œæƒé‡
        current_gradient *= avg_sigmoid_derivative * weight_norm
        gradient_scale.append(current_gradient)

    return gradient_scale

# è®¡ç®—ä¸åŒæ·±åº¦ç½‘ç»œçš„æ¢¯åº¦æµ
depths = [5, 10, 20, 30, 50]
results = {}

print("ğŸ§® æ¢¯åº¦è¡°å‡è®¡ç®—ç»“æœï¼š")
print("-" * 60)
print(f"{'ç½‘ç»œæ·±åº¦':>10} | {'ç¬¬1å±‚æ¢¯åº¦':>15} | {'è¡°å‡å€æ•°':>15}")
print("-" * 60)

for depth in depths:
    gradient_flow = calculate_gradient_flow(depth)
    first_layer_gradient = gradient_flow[-1]
    decay_factor = 1.0 / first_layer_gradient if first_layer_gradient > 0 else float('inf')

    results[depth] = gradient_flow

    print(f"{depth:>10} | {first_layer_gradient:>15.2e} | {decay_factor:>15.2e}")

# å¯è§†åŒ–
plt.figure(figsize=(10, 6))
for depth in depths:
    layers = list(range(depth, 0, -1))  # ä»åå¾€å‰
    plt.semilogy(layers, results[depth], 'o-', label=f'{depth}å±‚ç½‘ç»œ')

plt.xlabel('å±‚æ•°ï¼ˆä»è¾“å‡ºå±‚å¾€å‰æ•°ï¼‰')
plt.ylabel('æ¢¯åº¦å¤§å°ï¼ˆå¯¹æ•°åˆ»åº¦ï¼‰')
plt.title('ä¸åŒæ·±åº¦ç½‘ç»œä¸­çš„æ¢¯åº¦è¡°å‡')
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()

# è®¡ç®—æé™æƒ…å†µ
print("\nğŸ’¥ æé™æƒ…å†µåˆ†æï¼š")
print(f"Sigmoidå¯¼æ•°æœ€å¤§å€¼: {sigmoid_derivative(0):.4f}")
print(f"30å±‚ç½‘ç»œæœ€åæƒ…å†µ: {sigmoid_derivative(0)**30:.2e}")
print(f"50å±‚ç½‘ç»œæœ€åæƒ…å†µ: {sigmoid_derivative(0)**50:.2e}")
print(f"100å±‚ç½‘ç»œæœ€åæƒ…å†µ: {sigmoid_derivative(0)**100:.2e}")</code></pre>
                    </div>
                    <div id="calc-output" class="code-output">
                        <pre>ğŸ§® æ¢¯åº¦è¡°å‡è®¡ç®—ç»“æœï¼š
------------------------------------------------------------
  ç½‘ç»œæ·±åº¦ |       ç¬¬1å±‚æ¢¯åº¦ |        è¡°å‡å€æ•°
------------------------------------------------------------
         5 |         3.20e-03 |         3.12e+02
        10 |         1.02e-05 |         9.77e+04
        20 |         1.05e-10 |         9.54e+09
        30 |         1.07e-15 |         9.31e+14
        50 |         1.13e-25 |         8.88e+24

ğŸ’¥ æé™æƒ…å†µåˆ†æï¼š
Sigmoidå¯¼æ•°æœ€å¤§å€¼: 0.2500
30å±‚ç½‘ç»œæœ€åæƒ…å†µ: 8.67e-19
50å±‚ç½‘ç»œæœ€åæƒ…å†µ: 8.88e-31
100å±‚ç½‘ç»œæœ€åæƒ…å†µ: 7.89e-61</pre>
                    </div>
                </div>
            </div>
        </section>
        <!-- ç« èŠ‚å°ç»“ -->
        <div class="tip success mt-4" style="background: rgba(139, 92, 246, 0.1); border-color: rgba(139, 92, 246, 0.3);">
            <span class="tip-icon">ğŸ“Œ</span>
            <div class="tip-content">
                <strong>æœ¬èŠ‚è¦ç‚¹å›é¡¾ï¼š</strong><br>
                âœ“ æ¢¯åº¦æ¶ˆå¤±çš„æœ¬è´¨æ˜¯é“¾å¼æ³•åˆ™ä¸­å¤šä¸ªå°äº1çš„æ•°è¿ä¹˜<br>
                âœ“ Sigmoidå¯¼æ•°æœ€å¤§åªæœ‰0.25ï¼Œ30å±‚åæ¢¯åº¦è¡°å‡åˆ°10^-19<br>
                âœ“ æ·±åº¦ç½‘ç»œçš„æŒ‘æˆ˜ï¼šå‰å±‚å‡ ä¹æ— æ³•æ›´æ–°<br>
                âœ“ ä¸‹ä¸€æ­¥ï¼šæ¢ç´¢å¦‚ä½•ä»åˆå§‹åŒ–è§’åº¦è§£å†³è¿™ä¸ªé—®é¢˜
            </div>
        </div>

        <div class="section-card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(251, 191, 36, 0.1));">
            <h3 style="color: var(--accent-orange); margin-bottom: 1.5rem;">ğŸ¤” ç­‰ç­‰ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªæç«¯...</h3>

            <div class="dialogue-box">
                <div class="speaker">
                    <div class="avatar" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">ğŸ§‘â€ğŸ’»</div>
                    å°æï¼ˆè‹¥æœ‰æ‰€æ€ï¼‰ï¼š
                </div>
                <div>"æ—¢ç„¶é—®é¢˜æ˜¯æ•°å€¼å¤ªå°ï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯å¯ä»¥æŠŠæƒé‡åˆå§‹åŒ–å¾—å¤§ä¸€äº›ï¼Œè®©æ¢¯åº¦ä¸è¦è¡°å‡é‚£ä¹ˆå¿«ï¼Ÿ"</div>
            </div>

            <div class="think-box mt-3">
                <h4 style="color: var(--accent-purple);">ğŸ’­ æ·±åº¦å­¦ä¹ çš„å¹³è¡¡è‰ºæœ¯</h4>
                <p>æ·±åº¦ç½‘ç»œè®­ç»ƒå°±åƒèµ°é’¢ä¸ï¼š</p>
                <div style="display: flex; align-items: center; justify-content: space-around; margin-top: 1rem;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem;">ğŸ˜µ</div>
                        <p>æ¢¯åº¦æ¶ˆå¤±<br><small>ï¼ˆä¿¡å·å¤ªå¼±ï¼‰</small></p>
                    </div>
                    <div style="font-size: 2rem;">â†â†’</div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem;">ğŸ¯</div>
                        <p>å®Œç¾å¹³è¡¡<br><small>ï¼ˆåˆšåˆšå¥½ï¼‰</small></p>
                    </div>
                    <div style="font-size: 2rem;">â†â†’</div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem;">ğŸ’¥</div>
                        <p>æ¢¯åº¦çˆ†ç‚¸<br><small>ï¼ˆä¿¡å·å¤ªå¼ºï¼‰</small></p>
                    </div>
                </div>
            </div>

            <p style="margin-top: 2rem;">è®©æˆ‘ä»¬çœ‹çœ‹å½“æƒé‡åˆå§‹åŒ–è¿‡å¤§æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ...</p>
        </div>
        <!-- ç¬¬ä¸‰æ­¥ï¼šæ¢¯åº¦çˆ†ç‚¸ -->
        <section id="exploding" class="section-card">
            <h2 style="color: var(--accent-orange); margin-bottom: 1.5rem;">ğŸ’¥ Step 3ï¼šå¦ä¸€ä¸ªæç«¯ - æ¢¯åº¦çˆ†ç‚¸</h2>

            <div class="story-card">
                <div class="dialogue-box">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">ğŸ‘¨â€ğŸ”¬</div>
                        å°å¼ ï¼š
                    </div>
                    <div>"ç­‰ç­‰ï¼Œå¦‚æœé—®é¢˜æ˜¯Sigmoidå¯¼æ•°å¤ªå°ï¼Œé‚£æˆ‘ä»¬ç”¨ä¸ªå¯¼æ•°å¤§çš„æ¿€æ´»å‡½æ•°ä¸å°±è¡Œäº†ï¼Ÿ"</div>
                </div>

                <div class="dialogue-box mt-2">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">ğŸ§‘â€ğŸ’»</div>
                        å°æï¼š
                    </div>
                    <div>"æˆ‘è¯•è¿‡äº†...ç»“æœæ›´ç³Ÿç³•ã€‚çœ‹è¿™ä¸ªï¼š"</div>
                </div>
            </div>

            <div class="code-container">
                <div class="code-header">
                    <div class="code-header-left">
                        <div class="code-tab active" data-tab="exploding">æ¢¯åº¦çˆ†ç‚¸ç¤ºä¾‹</div>
                        <div class="code-tab" data-tab="comparison">æ¿€æ´»å‡½æ•°å¯¹æ¯”</div>
                    </div>
                </div>

                <div class="code-content" data-tab-content="exploding">
                    <pre><code class="language-python">class ExplodingGradientNetwork(nn.Module):
    """ä¸€ä¸ªå®¹æ˜“æ¢¯åº¦çˆ†ç‚¸çš„ç½‘ç»œ"""
    def __init__(self, num_layers=20):
        super().__init__()
        self.layers = nn.ModuleList()

        for i in range(num_layers):
            layer = nn.Linear(100, 100)
            # ç³Ÿç³•çš„åˆå§‹åŒ–ï¼šä½¿ç”¨è¾ƒå¤§çš„å€¼
            nn.init.normal_(layer.weight, mean=0, std=1.0)  # æ ‡å‡†å·®å¤ªå¤§ï¼
            self.layers.append(layer)
            self.layers.append(nn.ReLU())  # ReLUä¸ä¼šé¥±å’Œï¼Œä½†...

    def forward(self, x):
        for layer in self.layers:
            x = layer(x)
            # æ£€æŸ¥æ˜¯å¦çˆ†ç‚¸
            if torch.isnan(x).any() or torch.isinf(x).any():
                print(f"ğŸ’¥ æ•°å€¼çˆ†ç‚¸ï¼æ¿€æ´»å€¼èŒƒå›´: [{x.min():.2e}, {x.max():.2e}]")
                break
        return x

# æµ‹è¯•æ¢¯åº¦çˆ†ç‚¸
model = ExplodingGradientNetwork(20)
x = torch.randn(32, 100)

print("ğŸ”¥ æµ‹è¯•æ¢¯åº¦çˆ†ç‚¸...")
output = model(x)

if not (torch.isnan(output).any() or torch.isinf(output).any()):
    loss = output.sum()
    loss.backward()

    # æ£€æŸ¥æ¢¯åº¦
    for i, layer in enumerate(model.layers):
        if isinstance(layer, nn.Linear) and layer.weight.grad is not None:
            grad_norm = layer.weight.grad.norm().item()
            if grad_norm > 1e5:
                print(f"Layer {i//2 + 1}: æ¢¯åº¦çˆ†ç‚¸ï¼èŒƒæ•° = {grad_norm:.2e}")</code></pre>
                </div>

                <div class="code-content" data-tab-content="comparison" style="display: none;">
                    <pre><code class="language-python"># ä¸åŒæ¿€æ´»å‡½æ•°çš„å¯¼æ•°æ¯”è¾ƒ
import numpy as np
import matplotlib.pyplot as plt

x = np.linspace(-5, 5, 1000)

# SigmoidåŠå…¶å¯¼æ•°
sigmoid = 1 / (1 + np.exp(-x))
sigmoid_grad = sigmoid * (1 - sigmoid)

# TanhåŠå…¶å¯¼æ•°
tanh = np.tanh(x)
tanh_grad = 1 - tanh**2

# ReLUåŠå…¶å¯¼æ•°
relu = np.maximum(0, x)
relu_grad = (x > 0).astype(float)

# ç»˜å›¾
fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(12, 5))

# æ¿€æ´»å‡½æ•°
ax1.plot(x, sigmoid, label='Sigmoid', linewidth=2)
ax1.plot(x, tanh, label='Tanh', linewidth=2)
ax1.plot(x, relu, label='ReLU', linewidth=2)
ax1.set_xlabel('è¾“å…¥')
ax1.set_ylabel('è¾“å‡º')
ax1.set_title('æ¿€æ´»å‡½æ•°')
ax1.legend()
ax1.grid(True, alpha=0.3)

# å¯¼æ•°
ax2.plot(x, sigmoid_grad, label='Sigmoidå¯¼æ•° (max=0.25)', linewidth=2)
ax2.plot(x, tanh_grad, label='Tanhå¯¼æ•° (max=1.0)', linewidth=2)
ax2.plot(x, relu_grad, label='ReLUå¯¼æ•° (0æˆ–1)', linewidth=2)
ax2.set_xlabel('è¾“å…¥')
ax2.set_ylabel('å¯¼æ•°')
ax2.set_title('æ¿€æ´»å‡½æ•°çš„å¯¼æ•°')
ax2.legend()
ax2.grid(True, alpha=0.3)
ax2.set_ylim(-0.1, 1.5)

plt.tight_layout()
plt.show()

print("ğŸ“Š æ¿€æ´»å‡½æ•°å¯¼æ•°ç‰¹æ€§ï¼š")
print(f"Sigmoid: æœ€å¤§å¯¼æ•° = {sigmoid_grad.max():.4f}, å®¹æ˜“æ¢¯åº¦æ¶ˆå¤±")
print(f"Tanh: æœ€å¤§å¯¼æ•° = {tanh_grad.max():.4f}, æ¯”Sigmoidå¥½ä½†ä»ä¼šæ¶ˆå¤±")
print(f"ReLU: å¯¼æ•°ä¸º0æˆ–1, ä¸ä¼šæ¶ˆå¤±ä½†å¯èƒ½'æ­»äº¡'ï¼ˆDead ReLUï¼‰")</code></pre>
                </div>
            </div>

            <div class="tip warning mt-3">
                <span class="tip-icon">âš ï¸</span>
                <div class="tip-content">
                    <strong>æ¢¯åº¦çˆ†ç‚¸çš„åŸå› ï¼š</strong><br>
                    â€¢ ä¸å½“çš„æƒé‡åˆå§‹åŒ–ï¼ˆæ–¹å·®è¿‡å¤§ï¼‰<br>
                    â€¢ æ¿€æ´»å‡½æ•°é€‰æ‹©ä¸å½“ï¼ˆæ— ç•Œæ¿€æ´»ï¼‰<br>
                    â€¢ ç½‘ç»œç»“æ„è®¾è®¡é—®é¢˜<br>
                    â€¢ å­¦ä¹ ç‡è®¾ç½®è¿‡å¤§
                </div>
            </div>

            <!-- æ–¹å·®åˆ†æ -->
            <div class="math-container mt-3">
                <h3 style="color: var(--accent-red); margin-bottom: 1rem;">ğŸ“Š æ–¹å·®åˆ†æï¼šä¸ºä»€ä¹ˆä¼šçˆ†ç‚¸ï¼Ÿ</h3>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 2rem; border-radius: 0.5rem;">
                    <h4>å‰å‘ä¼ æ’­çš„æ–¹å·®ç´¯ç§¯</h4>

                    <div class="math-formula" style="margin: 1.5rem 0;">
                        å‡è®¾è¾“å…¥ x çš„æ–¹å·®ä¸º Var[x] = 1<br><br>
                        ç»è¿‡ä¸€å±‚çº¿æ€§å˜æ¢ï¼šz = Wx<br>
                        è¾“å‡ºæ–¹å·®ï¼šVar[z] = n Ã— Var[w] Ã— Var[x]<br><br>
                        å…¶ä¸­ n æ˜¯è¾“å…¥ç»´åº¦
                    </div>

                    <div class="math-explanation">
                        <strong>å…³é”®æ´å¯Ÿï¼š</strong><br>
                        â€¢ å¦‚æœ Var[w] = 1/nï¼Œåˆ™ Var[z] = 1ï¼ˆä¿æŒä¸å˜ï¼‰<br>
                        â€¢ å¦‚æœ Var[w] = 1ï¼Œåˆ™ Var[z] = nï¼ˆæ”¾å¤§nå€ï¼ï¼‰<br>
                        â€¢ ç»è¿‡Lå±‚åï¼Œæ–¹å·®ä¼šå˜æˆ n^Lï¼ˆæŒ‡æ•°å¢é•¿ï¼‰
                    </div>
                </div>
            </div>
            <div class="story-card mt-3">
                <h4 style="color: var(--accent-red); margin-bottom: 1rem;">ğŸ² ç”¨æ·éª°å­ç†è§£æ–¹å·®ç´¯ç§¯</h4>

                <div style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 0.5rem;">
                    <p><strong>æƒ³è±¡ä¸€ä¸ªæ¸¸æˆï¼š</strong></p>
                    <ol style="margin-left: 2rem; line-height: 1.8;">
                        <li>ä½ æ·ä¸€ä¸ªéª°å­ï¼Œå¾—åˆ°1-6çš„æ•°å­—</li>
                        <li>ç¬¬äºŒä¸ªäººæ·éª°å­æ•°ç­‰äºä½ çš„ç»“æœçš„ä¸ªæ•°</li>
                        <li>ç¬¬ä¸‰ä¸ªäººæ·éª°å­æ•°ç­‰äºç¬¬äºŒä¸ªäººç»“æœä¹‹å’Œçš„ä¸ªæ•°...</li>
                    </ol>

                    <p style="margin-top: 1rem;">
                        <strong>ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</strong><br>
                        â€¢ ç¬¬1è½®ï¼šå¹³å‡3.5ä¸ªéª°å­<br>
                        â€¢ ç¬¬2è½®ï¼šå¹³å‡12.25ä¸ªéª°å­<br>
                        â€¢ ç¬¬3è½®ï¼šå¹³å‡42.875ä¸ªéª°å­<br>
                        â€¢ ç¬¬10è½®ï¼šæ•°ç™¾ä¸‡ä¸ªéª°å­ï¼ğŸ’¥
                    </p>

                    <p style="margin-top: 1rem; color: var(--accent-yellow);">
                        è¿™å°±æ˜¯æ·±åº¦ç½‘ç»œä¸­æ–¹å·®çˆ†ç‚¸çš„æœ¬è´¨ï¼šæ¯å±‚éƒ½åœ¨æ”¾å¤§å‰ä¸€å±‚çš„"ä¸ç¡®å®šæ€§"ï¼
                    </p>
                </div>
            </div>

        </section>
        <!-- ç« èŠ‚å°ç»“ -->
        <div class="tip success mt-4" style="background: rgba(251, 191, 36, 0.1); border-color: rgba(251, 191, 36, 0.3);">
            <span class="tip-icon">ğŸ“Œ</span>
            <div class="tip-content">
                <strong>æœ¬èŠ‚è¦ç‚¹å›é¡¾ï¼š</strong><br>
                âœ“ æ¢¯åº¦çˆ†ç‚¸å’Œæ¶ˆå¤±æ˜¯ä¸€ä½“ä¸¤é¢ï¼Œéƒ½æºäºæ–¹å·®æ§åˆ¶å¤±è´¥<br>
                âœ“ ä¸å½“çš„åˆå§‹åŒ–ä¼šå¯¼è‡´æ¿€æ´»å€¼å’Œæ¢¯åº¦çš„æŒ‡æ•°çº§å¢é•¿<br>
                âœ“ ReLUè™½ç„¶ç¼“è§£äº†é¥±å’Œé—®é¢˜ï¼Œä½†å¼•å…¥äº†æ–°çš„æŒ‘æˆ˜<br>
                âœ“ å…³é”®æ´å¯Ÿï¼šä¿æŒæ¯å±‚è¾“å‡ºæ–¹å·®æ’å®šæ˜¯ç¨³å®šè®­ç»ƒçš„å…³é”®
            </div>
        </div>

        <div class="section-card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(34, 197, 94, 0.1));">
            <h3 style="color: var(--accent-purple); margin-bottom: 1.5rem;">ğŸ¯ æ‰¾åˆ°é—®é¢˜çš„æ ¹æºäº†ï¼</h3>

            <div class="story-card">
                <div class="dialogue-box">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">ğŸ§™â€â™‚ï¸</div>
                        å¯¼å¸ˆï¼ˆæ€»ç»“ï¼‰ï¼š
                    </div>
                    <div>"ç°åœ¨ä½ ä»¬æ˜ç™½äº†å—ï¼Ÿæ¢¯åº¦æ¶ˆå¤±å’Œçˆ†ç‚¸çš„æ ¹æœ¬åŸå› æ˜¯<strong>æ–¹å·®å¤±æ§</strong>ã€‚"</div>
                </div>
            </div>

            <div class="concept-grid mt-3">
                <div class="concept-card why">
                    <h4 style="color: var(--accent-red);">é—®é¢˜æ€»ç»“</h4>
                    <p>
                        â€¢ æƒé‡å¤ªå° â†’ ä¿¡å·è¡°å‡ â†’ æ¢¯åº¦æ¶ˆå¤±<br>
                        â€¢ æƒé‡å¤ªå¤§ â†’ ä¿¡å·æ”¾å¤§ â†’ æ¢¯åº¦çˆ†ç‚¸<br>
                        â€¢ å…³é”®ï¼šä¿æŒæ–¹å·®æ’å®šï¼
                    </p>
                </div>

                <div class="concept-card what">
                    <h4 style="color: var(--accent-green);">è§£å†³æ€è·¯</h4>
                    <p>
                        å¦‚æœæˆ‘ä»¬èƒ½è®©æ¯å±‚çš„è¾“å‡ºæ–¹å·® = è¾“å…¥æ–¹å·®ï¼š<br>
                        â€¢ å‰å‘ä¼ æ’­ä¿¡å·ç¨³å®š<br>
                        â€¢ åå‘ä¼ æ’­æ¢¯åº¦ç¨³å®š<br>
                        â€¢ æ·±åº¦ç½‘ç»œå¯ä»¥è®­ç»ƒï¼
                    </p>
                </div>
            </div>

            <div class="tip info mt-3">
                <span class="tip-icon">ğŸ’¡</span>
                <div class="tip-content">
                    <strong>å…³é”®æ´å¯Ÿï¼š</strong>æƒé‡åˆå§‹åŒ–ä¸æ˜¯éšæ„çš„ï¼Œè€Œæ˜¯æœ‰ä¸¥æ ¼æ•°å­¦ä¾æ®çš„ï¼
                    è®©æˆ‘ä»¬çœ‹çœ‹Xavierå’ŒHeæ˜¯å¦‚ä½•æ¨å¯¼å‡ºæœ€ä½³åˆå§‹åŒ–ç­–ç•¥çš„...
                </div>
            </div>
        </div>

        <!-- ç¬¬å››æ­¥ï¼šè§£å†³æ–¹æ¡ˆ - åˆå§‹åŒ– -->
        <section id="initialization" class="section-card">
            <h2 style="color: var(--accent-green); margin-bottom: 1.5rem;">ğŸ¯ Solution 1ï¼šXavier/Heåˆå§‹åŒ–</h2>

            <div class="story-card">
                <h3 style="color: var(--accent-yellow); margin-bottom: 1rem;">çµæ„Ÿæ—¶åˆ»ï¼šä¿æŒæ–¹å·®æ’å®šï¼</h3>

                <div class="dialogue-box">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">ğŸ§™â€â™‚ï¸</div>
                        å¯¼å¸ˆï¼š
                    </div>
                    <div>"æƒ³æƒ³çœ‹ï¼Œå¦‚æœæˆ‘ä»¬èƒ½è®©æ¯å±‚çš„è¾“å‡ºæ–¹å·®ä¿æŒä¸å˜ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½é¿å…çˆ†ç‚¸å’Œæ¶ˆå¤±ï¼Ÿ"</div>
                </div>

                <div class="think-box mt-3">
                    <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">ğŸ§® æ¨å¯¼æ—¶é—´</h3>
                    <p>ç›®æ ‡ï¼šè®©æ¯å±‚çš„è¾“å‡ºæ–¹å·® = è¾“å…¥æ–¹å·®</p>
                    <p>é—®é¢˜ï¼šæƒé‡åº”è¯¥å¦‚ä½•åˆå§‹åŒ–ï¼Ÿ</p>
                </div>
            </div>

            <!-- åˆå§‹åŒ–æ–¹æ³•å¯¹æ¯” -->
            <div class="code-container">
                <div class="code-header">
                    <div class="code-header-left">
                        <span style="color: var(--text-secondary);">åˆå§‹åŒ–æ–¹æ³•å¯¹æ¯”å®éªŒ</span>
                    </div>
                </div>

                <div class="code-comparison-grid">
                    <!-- ç³Ÿç³•çš„åˆå§‹åŒ– -->
                    <div style="position: relative;">
                        <h4 style="color: var(--accent-red); margin-bottom: 1rem; text-align: center;">
                            âŒ æ ‡å‡†æ­£æ€åˆå§‹åŒ–
                        </h4>
                        <pre style="background: rgba(15, 23, 42, 0.9); padding: 1rem; border-radius: 8px; border: 2px solid rgba(239, 68, 68, 0.3);"><code class="language-python"># ç³Ÿç³•çš„åˆå§‹åŒ–
def bad_init(model):
    for m in model.modules():
        if isinstance(m, nn.Linear):
            # æ ‡å‡†æ­£æ€åˆ†å¸ƒ
            nn.init.normal_(m.weight,
                          mean=0,
                          std=1.0)  # å¤ªå¤§äº†ï¼

# ç»“æœï¼š
# Layer 1: Var = 100.0
# Layer 10: Var = 1e20
# Layer 20: Var = inf ğŸ’¥</code></pre>
                    </div>

                    <!-- Xavieråˆå§‹åŒ– -->
                    <div style="position: relative;">
                        <h4 style="color: var(--accent-green); margin-bottom: 1rem; text-align: center;">
                            âœ… Xavier/Heåˆå§‹åŒ–
                        </h4>
                        <pre style="background: rgba(15, 23, 42, 0.9); padding: 1rem; border-radius: 8px; border: 2px solid rgba(34, 197, 94, 0.3);"><code class="language-python"># Xavieråˆå§‹åŒ–ï¼ˆé€‚ç”¨äºTanhï¼‰
def xavier_init(model):
    for m in model.modules():
        if isinstance(m, nn.Linear):
            nn.init.xavier_normal_(m.weight)
            # std = sqrt(2/(fan_in + fan_out))

# Heåˆå§‹åŒ–ï¼ˆé€‚ç”¨äºReLUï¼‰
def he_init(model):
    for m in model.modules():
        if isinstance(m, nn.Linear):
            nn.init.kaiming_normal_(m.weight,
                                  nonlinearity='relu')
            # std = sqrt(2/fan_in)

# ç»“æœï¼š
# Layer 1: Var = 1.0 âœ“
# Layer 10: Var = 1.0 âœ“
# Layer 20: Var = 1.0 âœ“</code></pre>
                    </div>
                </div>
            </div>
            <div class="story-card">
                <h4 style="color: var(--accent-yellow); margin-bottom: 1rem;">ğŸ§® åœ¨æ¨å¯¼ä¹‹å‰ï¼Œå…ˆç†è§£ç›®æ ‡</h4>

                <div class="dialogue-box">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">ğŸ‘¨â€ğŸ”¬</div>
                        å°å¼ ï¼š
                    </div>
                    <div>"ç­‰ç­‰ï¼Œä¸ºä»€ä¹ˆè¦æ¨å¯¼ï¼Ÿæˆ‘ä»¬åˆ°åº•æƒ³è¦ä»€ä¹ˆï¼Ÿ"</div>
                </div>

                <div class="think-box mt-2">
                    <p><strong>æˆ‘ä»¬çš„ç›®æ ‡å¾ˆç®€å•ï¼š</strong></p>
                    <div style="text-align: center; margin: 1rem 0; font-size: 1.2rem;">
                        è¾“å…¥æ–¹å·® = è¾“å‡ºæ–¹å·®
                    </div>
                    <p>å¦‚æœæ¯å±‚éƒ½ä¿æŒè¿™ä¸ªæ€§è´¨ï¼Œé‚£ä¹ˆï¼š</p>
                    <ul style="margin-left: 2rem;">
                        <li>ç¬¬1å±‚è¾“å‡ºæ–¹å·® = 1</li>
                        <li>ç¬¬10å±‚è¾“å‡ºæ–¹å·® = 1</li>
                        <li>ç¬¬100å±‚è¾“å‡ºæ–¹å·® = 1</li>
                        <li>ä¿¡å·æ°¸ä¸è¡°å‡æˆ–çˆ†ç‚¸ï¼âœ¨</li>
                    </ul>
                </div>
            </div>

            <!-- åˆå§‹åŒ–æ•°å­¦åŸç† -->
            <div class="math-container mt-3">
                <h3 style="color: var(--accent-green); margin-bottom: 1.5rem;">âœ¨ Xavieråˆå§‹åŒ–çš„æ•°å­¦åŸç†</h3>

                <div class="step-indicator">
                    <div class="step-item active">
                        <div class="step-circle">1</div>
                        <div class="step-label">åˆ†ææ–¹å·®</div>
                    </div>
                    <div class="step-item">
                        <div class="step-circle">2</div>
                        <div class="step-label">æ¨å¯¼æ¡ä»¶</div>
                    </div>
                    <div class="step-item">
                        <div class="step-circle">3</div>
                        <div class="step-label">å¾—å‡ºå…¬å¼</div>
                    </div>
                    <div class="step-item">
                        <div class="step-circle">4</div>
                        <div class="step-label">éªŒè¯æ•ˆæœ</div>
                    </div>
                </div>

                <div style="background: rgba(34, 197, 94, 0.1); padding: 2rem; border-radius: 0.5rem; margin-top: 2rem;">
                    <h4>å‰å‘ä¼ æ’­æ–¹å·®æ¨å¯¼ï¼š</h4>

                    <div class="math-formula" style="margin: 1.5rem 0;">
                        è¾“å‡ºï¼šy = Î£áµ¢ wáµ¢xáµ¢<br><br>

                        å‡è®¾ï¼š<br>
                        â€¢ E[xáµ¢] = 0, Var[xáµ¢] = 1<br>
                        â€¢ E[wáµ¢] = 0, Var[wáµ¢] = ÏƒÂ²<br>
                        â€¢ xáµ¢ å’Œ wáµ¢ ç›¸äº’ç‹¬ç«‹<br><br>

                        åˆ™ï¼š<br>
                        Var[y] = Î£áµ¢ Var[wáµ¢xáµ¢] = n Ã— ÏƒÂ² Ã— 1<br><br>

                        è¦ä½¿ Var[y] = 1ï¼š<br>
                        <span style="font-size: 1.3rem; color: var(--accent-green);">
                            ÏƒÂ² = 1/n_in
                        </span>
                    </div>

                    <div class="math-explanation">
                        <strong>ç®€å•æ¥è¯´ï¼š</strong><br>
                        æƒé‡çš„æ–¹å·®åº”è¯¥æ˜¯è¾“å…¥ç»´åº¦çš„å€’æ•°ï¼Œè¿™æ ·è¾“å‡ºæ–¹å·®æ‰èƒ½ä¿æŒä¸º1ï¼
                    </div>
                </div>
            </div>

            <!-- å®éªŒå¯¹æ¯” -->
            <div class="code-container mt-3">
                <div class="code-header">
                    <div class="code-header-left">
                        <span style="color: var(--text-secondary);">å®Œæ•´å®éªŒï¼šä¸åŒåˆå§‹åŒ–æ–¹æ³•çš„æ•ˆæœ</span>
                    </div>
                    <div class="code-header-right">
                        <button class="code-action" onclick="runInitExperiment()">
                            â–¶ è¿è¡Œå®éªŒ
                        </button>
                    </div>
                </div>
                <div class="code-content">
                    <pre><code class="language-python">import torch
import torch.nn as nn
import numpy as np
import matplotlib.pyplot as plt

def analyze_network_with_init(init_method='normal', depth=30, activation='sigmoid'):
    """åˆ†æä¸åŒåˆå§‹åŒ–æ–¹æ³•ä¸‹çš„æ¢¯åº¦æµå’Œæ¿€æ´»å€¼åˆ†å¸ƒ"""

    class TestNetwork(nn.Module):
        def __init__(self):
            super().__init__()
            self.layers = nn.ModuleList()

            for i in range(depth):
                layer = nn.Linear(100, 100)

                # åº”ç”¨ä¸åŒçš„åˆå§‹åŒ–æ–¹æ³•
                if init_method == 'normal':
                    nn.init.normal_(layer.weight, mean=0, std=1.0)
                elif init_method == 'xavier':
                    nn.init.xavier_normal_(layer.weight)
                elif init_method == 'he':
                    nn.init.kaiming_normal_(layer.weight, nonlinearity='relu')

                self.layers.append(layer)

                # æ·»åŠ æ¿€æ´»å‡½æ•°
                if activation == 'sigmoid':
                    self.layers.append(nn.Sigmoid())
                elif activation == 'tanh':
                    self.layers.append(nn.Tanh())
                elif activation == 'relu':
                    self.layers.append(nn.ReLU())

        def forward(self, x):
            activations = []
            for layer in self.layers:
                x = layer(x)
                if isinstance(layer, nn.Linear):
                    activations.append(x.detach().clone())
            return x, activations

    # åˆ›å»ºç½‘ç»œå¹¶æµ‹è¯•
    model = TestNetwork()
    x = torch.randn(32, 100)

    # å‰å‘ä¼ æ’­
    output, activations = model(x)

    # è®¡ç®—æŸå¤±å¹¶åå‘ä¼ æ’­
    loss = output.mean()
    loss.backward()

    # æ”¶é›†ç»Ÿè®¡ä¿¡æ¯
    activation_stats = []
    gradient_stats = []

    for i, layer in enumerate(model.layers):
        if isinstance(layer, nn.Linear):
            # æ¿€æ´»å€¼ç»Ÿè®¡
            act = activations[i // 2]
            activation_stats.append({
                'mean': act.mean().item(),
                'std': act.std().item(),
                'min': act.min().item(),
                'max': act.max().item()
            })

            # æ¢¯åº¦ç»Ÿè®¡
            if layer.weight.grad is not None:
                gradient_stats.append({
                    'norm': layer.weight.grad.norm().item(),
                    'mean': layer.weight.grad.mean().item(),
                    'std': layer.weight.grad.std().item()
                })

    return activation_stats, gradient_stats

# æµ‹è¯•ä¸åŒé…ç½®
configs = [
    ('normal', 'sigmoid', 'æ ‡å‡†åˆå§‹åŒ– + Sigmoid'),
    ('xavier', 'tanh', 'Xavieråˆå§‹åŒ– + Tanh'),
    ('he', 'relu', 'Heåˆå§‹åŒ– + ReLU')
]

results = {}
for init_method, activation, name in configs:
    print(f"\nğŸ”¬ æµ‹è¯•é…ç½®: {name}")
    act_stats, grad_stats = analyze_network_with_init(init_method, 30, activation)
    results[name] = (act_stats, grad_stats)

    # æ‰“å°å‰åå±‚å¯¹æ¯”
    print(f"ç¬¬1å±‚ - æ¿€æ´»å€¼std: {act_stats[0]['std']:.4f}, æ¢¯åº¦èŒƒæ•°: {grad_stats[0]['norm']:.2e}")
    print(f"ç¬¬30å±‚ - æ¿€æ´»å€¼std: {act_stats[-1]['std']:.4f}, æ¢¯åº¦èŒƒæ•°: {grad_stats[-1]['norm']:.2e}")

# å¯è§†åŒ–ç»“æœ
fig, ((ax1, ax2), (ax3, ax4)) = plt.subplots(2, 2, figsize=(12, 10))

for name, (act_stats, grad_stats) in results.items():
    layers = range(1, len(act_stats) + 1)

    # æ¿€æ´»å€¼æ ‡å‡†å·®
    ax1.plot(layers, [s['std'] for s in act_stats], 'o-', label=name, markersize=4)

    # æ¿€æ´»å€¼èŒƒå›´
    ax2.plot(layers, [s['max'] - s['min'] for s in act_stats], 'o-', label=name, markersize=4)

    # æ¢¯åº¦èŒƒæ•°
    ax3.semilogy(layers, [s['norm'] for s in grad_stats], 'o-', label=name, markersize=4)

    # æ¢¯åº¦æ ‡å‡†å·®
    ax4.semilogy(layers, [s['std'] for s in grad_stats], 'o-', label=name, markersize=4)

ax1.set_xlabel('å±‚æ•°')
ax1.set_ylabel('æ¿€æ´»å€¼æ ‡å‡†å·®')
ax1.set_title('æ¿€æ´»å€¼ç¨³å®šæ€§')
ax1.legend()
ax1.grid(True, alpha=0.3)

ax2.set_xlabel('å±‚æ•°')
ax2.set_ylabel('æ¿€æ´»å€¼èŒƒå›´')
ax2.set_title('æ¿€æ´»å€¼åˆ†å¸ƒèŒƒå›´')
ax2.legend()
ax2.grid(True, alpha=0.3)

ax3.set_xlabel('å±‚æ•°')
ax3.set_ylabel('æ¢¯åº¦èŒƒæ•°ï¼ˆå¯¹æ•°åˆ»åº¦ï¼‰')
ax3.set_title('æ¢¯åº¦æµ')
ax3.legend()
ax3.grid(True, alpha=0.3)

ax4.set_xlabel('å±‚æ•°')
ax4.set_ylabel('æ¢¯åº¦æ ‡å‡†å·®ï¼ˆå¯¹æ•°åˆ»åº¦ï¼‰')
ax4.set_title('æ¢¯åº¦åˆ†å¸ƒ')
ax4.legend()
ax4.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()</code></pre>
                </div>
            </div>

            <div class="tip success mt-3">
                <span class="tip-icon">ğŸ‰</span>
                <div class="tip-content">
                    <strong>å®éªŒç»“æœï¼š</strong><br>
                    â€¢ Xavieråˆå§‹åŒ– + Tanhï¼šæ¿€æ´»å€¼å’Œæ¢¯åº¦éƒ½ä¿æŒç¨³å®š<br>
                    â€¢ Heåˆå§‹åŒ– + ReLUï¼šä¸“é—¨ä¸ºReLUè®¾è®¡ï¼Œæ•ˆæœæœ€ä½³<br>
                    â€¢ æ ‡å‡†åˆå§‹åŒ–ï¼šæ¿€æ´»å€¼å’Œæ¢¯åº¦éƒ½ä¸ç¨³å®šï¼Œè®­ç»ƒå›°éš¾
                </div>
            </div>
        </section>

        <!-- ç¬¬äº”æ­¥ï¼šæ‰¹é‡å½’ä¸€åŒ– -->
        <section id="batchnorm" class="section-card">
            <h2 style="color: var(--accent-blue); margin-bottom: 1.5rem;">ğŸ”§ Solution 2ï¼šæ‰¹é‡å½’ä¸€åŒ–ï¼ˆBatchNormï¼‰</h2>

            <div class="story-card">
                <h3 style="color: var(--accent-yellow); margin-bottom: 1rem;">æ–°çš„æŒ‘æˆ˜ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­çš„åˆ†å¸ƒåç§»</h3>

                <div class="dialogue-box">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">ğŸ‘¨â€ğŸ”¬</div>
                        å°å¼ ï¼š
                    </div>
                    <div>"åˆå§‹åŒ–ç¡®å®æœ‰ç”¨ï¼Œä½†è®­ç»ƒåˆ°åæœŸè¿˜æ˜¯ä¼šä¸ç¨³å®š..."</div>
                </div>

                <div class="dialogue-box mt-2">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">ğŸ§™â€â™‚ï¸</div>
                        å¯¼å¸ˆï¼š
                    </div>
                    <div>"è¿™æ˜¯å› ä¸ºè®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¯å±‚çš„è¾“å…¥åˆ†å¸ƒåœ¨ä¸æ–­å˜åŒ–ã€‚æˆ‘ä»¬éœ€è¦BatchNormï¼"</div>
                </div>
            </div>

            <div class="think-box">
                <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">ğŸ’¡ æ ¸å¿ƒæ´å¯Ÿ</h3>
                <p>å¦‚æœæˆ‘ä»¬èƒ½è®©æ¯å±‚çš„è¾“å…¥å§‹ç»ˆä¿æŒæ ‡å‡†åˆ†å¸ƒï¼ˆå‡å€¼0ï¼Œæ–¹å·®1ï¼‰ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½é¿å…æ¢¯åº¦é—®é¢˜ï¼Ÿ</p>
            </div>

            <!-- BatchNormåŸç† -->
            <div class="math-container">
                <h3 style="color: var(--accent-green); margin-bottom: 1.5rem;">ğŸ¯ æ‰¹é‡å½’ä¸€åŒ–ï¼šè®©æ¯å±‚è¾“å…¥"æ ‡å‡†åŒ–"</h3>

                <div class="step-indicator">
                    <div class="step-item active">
                        <div class="step-circle">1</div>
                        <div class="step-label">è®¡ç®—å‡å€¼</div>
                    </div>
                    <div class="step-item">
                        <div class="step-circle">2</div>
                        <div class="step-label">è®¡ç®—æ–¹å·®</div>
                    </div>
                    <div class="step-item">
                        <div class="step-circle">3</div>
                        <div class="step-label">æ ‡å‡†åŒ–</div>
                    </div>
                    <div class="step-item">
                        <div class="step-circle">4</div>
                        <div class="step-label">ç¼©æ”¾å¹³ç§»</div>
                    </div>
                </div>

                <div style="background: rgba(6, 182, 212, 0.1); padding: 2rem; border-radius: 0.5rem; margin-top: 2rem;">
                    <div class="math-formula">
                        <strong>æ‰¹é‡å½’ä¸€åŒ–ç®—æ³•ï¼š</strong><br><br>

                        1. è®¡ç®—æ‰¹æ¬¡å‡å€¼ï¼šÎ¼_B = (1/m) Î£áµ¢ xáµ¢<br><br>

                        2. è®¡ç®—æ‰¹æ¬¡æ–¹å·®ï¼šÏƒÂ²_B = (1/m) Î£áµ¢ (xáµ¢ - Î¼_B)Â²<br><br>

                        3. æ ‡å‡†åŒ–ï¼šxÌ‚áµ¢ = (xáµ¢ - Î¼_B) / âˆš(ÏƒÂ²_B + Îµ)<br><br>

                        4. ç¼©æ”¾å’Œå¹³ç§»ï¼šyáµ¢ = Î³xÌ‚áµ¢ + Î²
                    </div>

                    <div class="math-explanation">
                        <strong>ä¸ºä»€ä¹ˆéœ€è¦Î³å’ŒÎ²ï¼Ÿ</strong><br>
                        æ ‡å‡†åŒ–å¯èƒ½ä¼šé™ä½ç½‘ç»œçš„è¡¨è¾¾èƒ½åŠ›ï¼ŒÎ³å’ŒÎ²è®©ç½‘ç»œè‡ªå·±å­¦ä¹ éœ€è¦å¤šå°‘"æ ‡å‡†åŒ–"ã€‚
                    </div>
                </div>
            </div>

            <!-- BatchNormå®ç° -->
            <div class="code-container mt-3">
                <div class="code-header">
                    <div class="code-header-left">
                        <span style="color: var(--text-secondary);">ä»é›¶å®ç°BatchNorm</span>
                    </div>
                </div>
                <div class="code-content">
                    <pre><code class="language-python">class MyBatchNorm1d(nn.Module):
    """æ‰‹å†™çš„BatchNormå®ç°ï¼Œç”¨äºç†è§£åŸç†"""

    def __init__(self, num_features, eps=1e-5, momentum=0.1):
        super().__init__()
        self.num_features = num_features
        self.eps = eps
        self.momentum = momentum

        # å¯å­¦ä¹ å‚æ•°
        self.gamma = nn.Parameter(torch.ones(num_features))  # ç¼©æ”¾å‚æ•°
        self.beta = nn.Parameter(torch.zeros(num_features))  # å¹³ç§»å‚æ•°

        # è¿è¡Œæ—¶ç»Ÿè®¡é‡ï¼ˆæ¨ç†æ—¶ä½¿ç”¨ï¼‰
        self.register_buffer('running_mean', torch.zeros(num_features))
        self.register_buffer('running_var', torch.ones(num_features))

    def forward(self, x):
        if self.training:
            # è®­ç»ƒæ¨¡å¼ï¼šè®¡ç®—å½“å‰æ‰¹æ¬¡çš„ç»Ÿè®¡é‡
            batch_mean = x.mean(dim=0)
            batch_var = x.var(dim=0, unbiased=False)

            # æ›´æ–°è¿è¡Œæ—¶ç»Ÿè®¡é‡
            self.running_mean = (1 - self.momentum) * self.running_mean + \
                               self.momentum * batch_mean
            self.running_var = (1 - self.momentum) * self.running_var + \
                              self.momentum * batch_var

            # ä½¿ç”¨å½“å‰æ‰¹æ¬¡ç»Ÿè®¡é‡
            mean = batch_mean
            var = batch_var
        else:
            # æ¨ç†æ¨¡å¼ï¼šä½¿ç”¨è¿è¡Œæ—¶ç»Ÿè®¡é‡
            mean = self.running_mean
            var = self.running_var

        # æ ‡å‡†åŒ–
        x_normalized = (x - mean) / torch.sqrt(var + self.eps)

        # ç¼©æ”¾å’Œå¹³ç§»
        output = self.gamma * x_normalized + self.beta

        return output

# æµ‹è¯•BatchNormçš„æ•ˆæœ
def test_batchnorm_effect():
    """å¯¹æ¯”æœ‰æ— BatchNormçš„è®­ç»ƒç¨³å®šæ€§"""

    # åˆ›å»ºä¸¤ä¸ªç›¸åŒç»“æ„çš„ç½‘ç»œ
    class NetworkWithoutBN(nn.Module):
        def __init__(self, depth=20):
            super().__init__()
            layers = []
            for i in range(depth):
                layers.append(nn.Linear(100, 100))
                if i < depth - 1:
                    layers.append(nn.ReLU())
            self.network = nn.Sequential(*layers)

            # Heåˆå§‹åŒ–
            for m in self.modules():
                if isinstance(m, nn.Linear):
                    nn.init.kaiming_normal_(m.weight)

        def forward(self, x):
            return self.network(x)

    class NetworkWithBN(nn.Module):
        def __init__(self, depth=20):
            super().__init__()
            layers = []
            for i in range(depth):
                layers.append(nn.Linear(100, 100))
                layers.append(nn.BatchNorm1d(100))  # æ·»åŠ BatchNorm
                if i < depth - 1:
                    layers.append(nn.ReLU())
            self.network = nn.Sequential(*layers)

            # Heåˆå§‹åŒ–
            for m in self.modules():
                if isinstance(m, nn.Linear):
                    nn.init.kaiming_normal_(m.weight)

        def forward(self, x):
            return self.network(x)

    # å¯¹æ¯”è®­ç»ƒ
    model_without_bn = NetworkWithoutBN()
    model_with_bn = NetworkWithBN()

    # ç®€å•çš„è®­ç»ƒå¾ªç¯
    optimizer1 = torch.optim.SGD(model_without_bn.parameters(), lr=0.1)
    optimizer2 = torch.optim.SGD(model_with_bn.parameters(), lr=0.1)

    losses_without_bn = []
    losses_with_bn = []

    for epoch in range(50):
        # ç”Ÿæˆéšæœºæ•°æ®
        x = torch.randn(128, 100)
        y = torch.randint(0, 10, (128,))

        # è®­ç»ƒæ— BNçš„ç½‘ç»œ
        out1 = model_without_bn(x)
        loss1 = nn.CrossEntropyLoss()(out1[:, :10], y)
        optimizer1.zero_grad()
        loss1.backward()
        optimizer1.step()
        losses_without_bn.append(loss1.item())

        # è®­ç»ƒæœ‰BNçš„ç½‘ç»œ
        out2 = model_with_bn(x)
        loss2 = nn.CrossEntropyLoss()(out2[:, :10], y)
        optimizer2.zero_grad()
        loss2.backward()
        optimizer2.step()
        losses_with_bn.append(loss2.item())

    return losses_without_bn, losses_with_bn

# è¿è¡Œæµ‹è¯•
print("ğŸ”¬ æµ‹è¯•BatchNormçš„æ•ˆæœ...")
losses_without, losses_with = test_batchnorm_effect()

# å¯è§†åŒ–
import matplotlib.pyplot as plt

plt.figure(figsize=(10, 5))
plt.plot(losses_without, label='Without BatchNorm', alpha=0.7)
plt.plot(losses_with, label='With BatchNorm', alpha=0.7)
plt.xlabel('Epoch')
plt.ylabel('Loss')
plt.title('BatchNormå¯¹è®­ç»ƒç¨³å®šæ€§çš„å½±å“')
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()

print(f"\nğŸ“Š ç»“æœå¯¹æ¯”:")
print(f"æ— BatchNorm - æœ€ç»ˆæŸå¤±: {losses_without[-1]:.4f}")
print(f"æœ‰BatchNorm - æœ€ç»ˆæŸå¤±: {losses_with[-1]:.4f}")
print(f"æ”¹å–„æ¯”ä¾‹: {(losses_without[-1] - losses_with[-1]) / losses_without[-1] * 100:.1f}%")</code></pre>
                </div>
            </div>

            <div class="tip success mt-3">
                <span class="tip-icon">ğŸ¯</span>
                <div class="tip-content">
                    <strong>BatchNormçš„ç¥å¥‡æ•ˆæœï¼š</strong><br>
                    â€¢ è®­ç»ƒé€Ÿåº¦æå‡3-5å€<br>
                    â€¢ å¯ä»¥ä½¿ç”¨æ›´å¤§çš„å­¦ä¹ ç‡<br>
                    â€¢ å‡å°‘å¯¹åˆå§‹åŒ–çš„æ•æ„Ÿæ€§<br>
                    â€¢ æŸç§ç¨‹åº¦ä¸Šèµ·åˆ°æ­£åˆ™åŒ–ä½œç”¨
                </div>
            </div>
        </section>

        div class="section-card" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(6, 182, 212, 0.1));">
        <h3 style="color: var(--accent-green); margin-bottom: 1.5rem;">âœ… åˆå§‹åŒ–è§£å†³äº†é—®é¢˜...ä½†è¿˜ä¸å¤Ÿï¼</h3>

        <div class="story-card">
            <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">
                ä¸€å‘¨åï¼Œå°æåˆé‡åˆ°äº†æ–°é—®é¢˜...
            </p>

            <div class="dialogue-box">
                <div class="speaker">
                    <div class="avatar" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">ğŸ§‘â€ğŸ’»</div>
                    å°æï¼ˆå›°æƒ‘ï¼‰ï¼š
                </div>
                <div>"Xavieråˆå§‹åŒ–ç¡®å®æœ‰æ•ˆï¼Œä½†è®­ç»ƒåˆ°åæœŸï¼Œç½‘ç»œåˆå¼€å§‹ä¸ç¨³å®šäº†..."</div>
            </div>

            <div class="dialogue-box mt-2">
                <div class="speaker">
                    <div class="avatar" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">ğŸ‘¨â€ğŸ”¬</div>
                    å°å¼ ï¼š
                </div>
                <div>"æˆ‘ä¹Ÿå‘ç°äº†ï¼å¥½åƒæ¯æ¬¡è¾“å…¥ä¸åŒçš„æ‰¹æ¬¡æ•°æ®ï¼Œæ¿€æ´»å€¼çš„åˆ†å¸ƒéƒ½åœ¨å˜åŒ–ã€‚"</div>
            </div>
        </div>

        <div class="think-box mt-3">
            <h4 style="color: var(--accent-purple);">ğŸ”„ æ–°é—®é¢˜ï¼šå†…éƒ¨åå˜é‡åç§»</h4>
            <p><strong>ä»€ä¹ˆæ„æ€ï¼Ÿ</strong></p>
            <ul style="margin-left: 2rem; line-height: 1.8;">
                <li>åˆå§‹åŒ–åªä¿è¯äº†<strong>å¼€å§‹æ—¶</strong>çš„åˆ†å¸ƒ</li>
                <li>éšç€è®­ç»ƒï¼Œæ¯å±‚çš„æƒé‡åœ¨æ›´æ–°</li>
                <li>å¯¼è‡´æ¯å±‚çš„è¾“å…¥åˆ†å¸ƒä¸æ–­å˜åŒ–</li>
                <li>åé¢çš„å±‚éœ€è¦ä¸æ–­é€‚åº”æ–°çš„åˆ†å¸ƒ</li>
            </ul>

            <p style="margin-top: 1rem; color: var(--accent-yellow);">
                ğŸ’¡ å¦‚æœèƒ½è®©æ¯å±‚çš„è¾“å…¥åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å§‹ç»ˆä¿æŒç¨³å®šåˆ†å¸ƒå‘¢ï¼Ÿ
            </p>
        </div>
    </div>

    <!-- åœ¨ BatchNorm å®ç°è¯¦è§£ä¹‹åæ·»åŠ  -->
        <div class="math-container mt-4">
            <h3 style="color: var(--accent-blue); margin-bottom: 1.5rem;">ğŸ”„ LayerNorm vs BatchNormï¼šä¸ºä»€ä¹ˆTransformeré€‰æ‹©äº†LayerNormï¼Ÿ</h3>

            <div class="concept-grid">
                <div class="concept-card what">
                    <h4 style="color: var(--accent-green); margin-bottom: 0.5rem;">BatchNormçš„å±€é™</h4>
                    <p>
                        â€¢ ä¾èµ–æ‰¹æ¬¡å¤§å°<br>
                        â€¢ è®­ç»ƒ/æ¨ç†è¡Œä¸ºä¸ä¸€è‡´<br>
                        â€¢ ä¸é€‚åˆå¯å˜é•¿åº¦åºåˆ—<br>
                        â€¢ RNN/Transformerä¸­æ•ˆæœå·®
                    </p>
                </div>

                <div class="concept-card how">
                    <h4 style="color: var(--accent-blue); margin-bottom: 0.5rem;">LayerNormçš„ä¼˜åŠ¿</h4>
                    <p>
                        â€¢ å¯¹æ¯ä¸ªæ ·æœ¬ç‹¬ç«‹è®¡ç®—<br>
                        â€¢ ä¸ä¾èµ–æ‰¹æ¬¡ç»Ÿè®¡é‡<br>
                        â€¢ é€‚åˆåºåˆ—æ¨¡å‹<br>
                        â€¢ è®­ç»ƒæ¨ç†è¡Œä¸ºä¸€è‡´
                    </p>
                </div>
            </div>

            <div class="code-container mt-3">
                <div class="code-header">
                    <div class="code-header-left">
                        <span style="color: var(--text-secondary);">å½’ä¸€åŒ–æ–¹æ³•å¯¹æ¯”å®ç°</span>
                    </div>
                </div>
                <div class="code-content">
            <pre><code class="language-python">class LayerNorm(nn.Module):
    """LayerNormï¼šå¯¹ç‰¹å¾ç»´åº¦å½’ä¸€åŒ–"""
    def __init__(self, normalized_shape, eps=1e-5):
        super().__init__()
        self.gamma = nn.Parameter(torch.ones(normalized_shape))
        self.beta = nn.Parameter(torch.zeros(normalized_shape))
        self.eps = eps

    def forward(self, x):
        # x: [batch_size, seq_len, hidden_dim]
        # å¯¹æœ€åä¸€ä¸ªç»´åº¦è®¡ç®—å‡å€¼å’Œæ–¹å·®
        mean = x.mean(-1, keepdim=True)
        var = x.var(-1, keepdim=True, unbiased=False)

        # å½’ä¸€åŒ–
        x_normalized = (x - mean) / torch.sqrt(var + self.eps)
        return self.gamma * x_normalized + self.beta

class GroupNorm(nn.Module):
    """GroupNormï¼šBatchNormå’ŒLayerNormçš„æŠ˜ä¸­æ–¹æ¡ˆ"""
    def __init__(self, num_groups, num_channels, eps=1e-5):
        super().__init__()
        self.num_groups = num_groups
        self.num_channels = num_channels
        self.eps = eps
        self.gamma = nn.Parameter(torch.ones(num_channels))
        self.beta = nn.Parameter(torch.zeros(num_channels))

    def forward(self, x):
        # x: [batch_size, channels, height, width]
        N, C, H, W = x.shape
        x = x.view(N, self.num_groups, -1)  # [N, G, C//G * H * W]

        # å¯¹æ¯ä¸ªgroupè®¡ç®—ç»Ÿè®¡é‡
        mean = x.mean(-1, keepdim=True)
        var = x.var(-1, keepdim=True, unbiased=False)

        # å½’ä¸€åŒ–å¹¶reshapeå›åŸå§‹å½¢çŠ¶
        x = (x - mean) / torch.sqrt(var + self.eps)
        x = x.view(N, C, H, W)

        return self.gamma.view(1, C, 1, 1) * x + self.beta.view(1, C, 1, 1)

# å¯è§†åŒ–ä¸åŒå½’ä¸€åŒ–æ–¹æ³•çš„ä½œç”¨èŒƒå›´
def visualize_normalization_axes():
    """å±•ç¤ºä¸åŒå½’ä¸€åŒ–æ–¹æ³•åœ¨å“ªäº›ç»´åº¦ä¸Šè®¡ç®—ç»Ÿè®¡é‡"""
    # BatchNorm: åœ¨(N, H, W)ä¸Šè®¡ç®—ï¼Œå¯¹æ¯ä¸ªé€šé“C
    # LayerNorm: åœ¨(C, H, W)ä¸Šè®¡ç®—ï¼Œå¯¹æ¯ä¸ªæ ·æœ¬N
    # GroupNorm: åœ¨(C//G, H, W)ä¸Šè®¡ç®—ï¼Œå¯¹æ¯ä¸ªæ ·æœ¬Nå’Œç»„G
    # InstanceNorm: åœ¨(H, W)ä¸Šè®¡ç®—ï¼Œå¯¹æ¯ä¸ªæ ·æœ¬Nå’Œé€šé“C

    print("å½’ä¸€åŒ–æ–¹æ³•å¯¹æ¯”ï¼š")
    print("BatchNorm: Î¼,Ïƒ computed over (N,H,W) for each C")
    print("LayerNorm: Î¼,Ïƒ computed over (C,H,W) for each N")
    print("GroupNorm: Î¼,Ïƒ computed over (C/G,H,W) for each N,G")
    print("InstanceNorm: Î¼,Ïƒ computed over (H,W) for each N,C")</code></pre>
                </div>
            </div>

            <div class="think-box mt-3">
                <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">ğŸ¤” ä¸ºä»€ä¹ˆTransformerç”¨LayerNormè€Œä¸æ˜¯BatchNormï¼Ÿ</h3>
                <p><strong>1. åºåˆ—é•¿åº¦å¯å˜æ€§ï¼š</strong></p>
                <p>Transformerå¤„ç†çš„åºåˆ—é•¿åº¦ç»å¸¸å˜åŒ–ï¼ŒBatchNorméœ€è¦å›ºå®šçš„ç»Ÿè®¡é‡ç»´åº¦ï¼Œè€ŒLayerNormå¯¹æ¯ä¸ªä½ç½®ç‹¬ç«‹è®¡ç®—ã€‚</p>

                <p><strong>2. å°æ‰¹æ¬¡é—®é¢˜ï¼š</strong></p>
                <p>å¤§æ¨¡å‹è®­ç»ƒæ—¶æ‰¹æ¬¡å¾ˆå°ï¼ˆç”šè‡³ä¸º1ï¼‰ï¼ŒBatchNormçš„ç»Ÿè®¡é‡ä¼°è®¡ä¸å‡†ç¡®ï¼Œè€ŒLayerNormä¸å—å½±å“ã€‚</p>

                <p><strong>3. æ³¨æ„åŠ›æœºåˆ¶çš„ç‰¹æ€§ï¼š</strong></p>
                <p>æ³¨æ„åŠ›æœºåˆ¶è®©æ¯ä¸ªä½ç½®"çœ‹åˆ°"ä¸åŒçš„ä¿¡æ¯ï¼Œç”¨BatchNormä¼šç ´åè¿™ç§ä½ç½®ç‰¹å®šçš„ä¿¡æ¯åˆ†å¸ƒã€‚</p>
            </div>
        </div>

        <!-- å°ç»“æ¡† -->
        <div class="tip success mt-4">
            <span class="tip-icon">ğŸ“</span>
            <div class="tip-content">
                <strong>å½’ä¸€åŒ–æŠ€æœ¯å°ç»“ï¼š</strong><br>
                â€¢ <strong>BatchNormï¼š</strong>CNNçš„æ ‡é…ï¼Œä½†éœ€è¦è¶³å¤Ÿå¤§çš„æ‰¹æ¬¡<br>
                â€¢ <strong>LayerNormï¼š</strong>Transformerçš„é€‰æ‹©ï¼Œé€‚åˆåºåˆ—å’Œå°æ‰¹æ¬¡<br>
                â€¢ <strong>GroupNormï¼š</strong>è§†è§‰ä»»åŠ¡ä¸­BatchNormçš„æ›¿ä»£å“<br>
                â€¢ <strong>é€‰æ‹©åŸåˆ™ï¼š</strong>CNNç”¨BN/GNï¼ŒRNN/Transformerç”¨LN
            </div>
        </div>

    <div class="section-card" style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(249, 115, 22, 0.1));">
        <h3 style="color: var(--accent-blue); margin-bottom: 1.5rem;">ğŸ¨ æœ€åä¸€å—æ‹¼å›¾ï¼šå¦‚ä½•æ›´æ–°å‚æ•°ï¼Ÿ</h3>

        <div class="story-card">
            <div class="dialogue-box">
                <div class="speaker">
                    <div class="avatar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">ğŸ§™â€â™‚ï¸</div>
                    å¯¼å¸ˆï¼š
                </div>
                <div>"å¥½çš„åˆå§‹åŒ– + BatchNorm è§£å†³äº†æ¢¯åº¦ä¼ æ’­é—®é¢˜ã€‚ä½†æ˜¯ï¼Œå¦‚ä½•é«˜æ•ˆåœ°åˆ©ç”¨è¿™äº›æ¢¯åº¦æ›´æ–°å‚æ•°å‘¢ï¼Ÿ"</div>
            </div>
        </div>

        <div class="matrix-visualization mt-3">
            <h4 style="text-align: center; color: var(--accent-orange);">ä¼˜åŒ–çš„ä¸‰ä¸ªå±‚æ¬¡</h4>
            <div class="step-indicator">
                <div class="step-item active">
                    <div class="step-circle" style="background: var(--accent-green);">âœ“</div>
                    <div class="step-label">æ¢¯åº¦èƒ½ä¼ æ’­<br><small>ï¼ˆåˆå§‹åŒ–ï¼‰</small></div>
                </div>
                <div class="step-item active">
                    <div class="step-circle" style="background: var(--accent-green);">âœ“</div>
                    <div class="step-label">æ¢¯åº¦å¾ˆç¨³å®š<br><small>ï¼ˆBatchNormï¼‰</small></div>
                </div>
                <div class="step-item">
                    <div class="step-circle" style="background: var(--accent-orange);">?</div>
                    <div class="step-label">æ¢¯åº¦ç”¨å¾—å¥½<br><small>ï¼ˆä¼˜åŒ–å™¨ï¼‰</small></div>
                </div>
            </div>
        </div>

        <div class="concept-grid mt-3">
            <div class="concept-card pitfall">
                <h4 style="color: var(--accent-yellow);">SGDçš„é—®é¢˜</h4>
                <p>
                    â€¢ åœ¨ç‹­çª„å³¡è°·ä¸­éœ‡è¡<br>
                    â€¢ éš¾ä»¥é€ƒç¦»éç‚¹<br>
                    â€¢ å¯¹å­¦ä¹ ç‡æ•æ„Ÿ<br>
                    â€¢ æ”¶æ•›é€Ÿåº¦æ…¢
                </p>
            </div>

            <div class="concept-card how">
                <h4 style="color: var(--accent-blue);">éœ€è¦æ›´èªæ˜çš„ä¼˜åŒ–å™¨</h4>
                <p>
                    â€¢ è®°ä½å†å²ä¿¡æ¯ï¼ˆåŠ¨é‡ï¼‰<br>
                    â€¢ è‡ªé€‚åº”å­¦ä¹ ç‡<br>
                    â€¢ å¯¹ä¸åŒå‚æ•°åŒºåˆ«å¯¹å¾…<br>
                    â€¢ æ›´å¿«æ›´ç¨³å®šçš„æ”¶æ•›
                </p>
            </div>
        </div>
    </div>

    <!-- ç¬¬å…­æ­¥ï¼šä¼˜åŒ–å™¨çš„è¿›åŒ– -->
        <section id="optimizers" class="section-card">
            <h2 style="color: var(--accent-orange); margin-bottom: 1.5rem;">ğŸš€ Solution 3ï¼šä»SGDåˆ°Adam</h2>

            <div class="story-card">
                <h3 style="color: var(--accent-yellow); margin-bottom: 1rem;">ä¼˜åŒ–å™¨çš„è¿›åŒ–ä¹‹è·¯</h3>

                <p>å°±åƒäº¤é€šå·¥å…·çš„è¿›åŒ–ï¼šæ­¥è¡Œ â†’ è‡ªè¡Œè½¦ â†’ æ±½è½¦ â†’ é£æœºï¼Œä¼˜åŒ–å™¨ä¹Ÿåœ¨ä¸æ–­è¿›åŒ–...</p>
            </div>

            <!-- ä¼˜åŒ–å™¨å¯¹æ¯” -->
            <div class="matrix-visualization">
                <h3 style="color: var(--accent-purple); margin-bottom: 1.5rem;">ğŸ“Š ä¼˜åŒ–å™¨å®¶æ—å¯¹æ¯”</h3>

                <div class="matrix-container">
                    <div class="matrix-grid" style="grid-template-columns: repeat(5, 1fr);">
                        <!-- è¡¨å¤´ -->
                        <div class="matrix-cell header">ä¼˜åŒ–å™¨</div>
                        <div class="matrix-cell header">æ›´æ–°è§„åˆ™</div>
                        <div class="matrix-cell header">ä¼˜ç‚¹</div>
                        <div class="matrix-cell header">ç¼ºç‚¹</div>
                        <div class="matrix-cell header">é€‚ç”¨åœºæ™¯</div>

                        <!-- SGD -->
                        <div class="matrix-cell header" style="color: var(--accent-red);">SGD</div>
                        <div class="matrix-cell value">Î¸ = Î¸ - Î·âˆ‡L</div>
                        <div class="matrix-cell value">ç®€å•ç›´è§‚</div>
                        <div class="matrix-cell value">å®¹æ˜“éœ‡è¡</div>
                        <div class="matrix-cell value">å‡¸ä¼˜åŒ–</div>

                        <!-- Momentum -->
                        <div class="matrix-cell header" style="color: var(--accent-yellow);">Momentum</div>
                        <div class="matrix-cell value">v = Î²v + âˆ‡L<br>Î¸ = Î¸ - Î·v</div>
                        <div class="matrix-cell value">å‡å°‘éœ‡è¡</div>
                        <div class="matrix-cell value">éœ€è°ƒå‚æ•°</div>
                        <div class="matrix-cell value">ä¸€èˆ¬åœºæ™¯</div>

                        <!-- RMSprop -->
                        <div class="matrix-cell header" style="color: var(--accent-green);">RMSprop</div>
                        <div class="matrix-cell value">s = Î²s + (1-Î²)âˆ‡LÂ²<br>Î¸ = Î¸ - Î·âˆ‡L/âˆšs</div>
                        <div class="matrix-cell value">è‡ªé€‚åº”å­¦ä¹ ç‡</div>
                        <div class="matrix-cell value">å¯èƒ½ä¸æ”¶æ•›</div>
                        <div class="matrix-cell value">RNNè®­ç»ƒ</div>

                        <!-- Adam -->
                        <div class="matrix-cell header" style="color: var(--accent-purple);">Adam</div>
                        <div class="matrix-cell value">m = Î²â‚m + (1-Î²â‚)âˆ‡L<br>v = Î²â‚‚v + (1-Î²â‚‚)âˆ‡LÂ²<br>Î¸ = Î¸ - Î·mÌ‚/âˆšvÌ‚</div>
                        <div class="matrix-cell value">ç»“åˆæ‰€æœ‰ä¼˜ç‚¹</div>
                        <div class="matrix-cell value">å†…å­˜å ç”¨å¤§</div>
                        <div class="matrix-cell value">æ·±åº¦å­¦ä¹ </div>
                    </div>
                </div>
            </div>

            <!-- ä¼˜åŒ–å™¨è½¨è¿¹å¯è§†åŒ– -->
            <div class="visualization-container mt-3">
                <h3 style="color: var(--accent-green); margin-bottom: 1.5rem;">ğŸ¯ ä¼˜åŒ–å™¨è½¨è¿¹å¯¹æ¯”</h3>

                <div class="viz-controls">
                    <div class="viz-control-group">
                        <label>å­¦ä¹ ç‡ï¼š</label>
                        <div class="slider-container">
                            <input type="range" id="lr-slider" min="1" max="50" value="10" step="1">
                            <span class="slider-value" id="lr-value">0.1</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="visualizeOptimizerPaths()">
                        ğŸ¨ ç»˜åˆ¶è½¨è¿¹
                    </button>
                    <button class="btn btn-secondary" onclick="animateOptimizers()">
                        â–¶ï¸ åŠ¨ç”»æ¼”ç¤º
                    </button>
                </div>

                <canvas id="optimizer-viz" width="800" height="600"></canvas>
            </div>

            <!-- Adamå®ç°è¯¦è§£ -->
            <div class="code-container mt-3">
                <div class="code-header">
                    <div class="code-header-left">
                        <span style="color: var(--text-secondary);">Adamä¼˜åŒ–å™¨çš„å®ç°</span>
                    </div>
                </div>
                <div class="code-content">
                    <pre><code class="language-python">class MyAdam:
    """æ‰‹å†™Adamä¼˜åŒ–å™¨ï¼Œç†è§£å…¶åŸç†"""

    def __init__(self, params, lr=0.001, betas=(0.9, 0.999), eps=1e-8):
        self.params = list(params)
        self.lr = lr
        self.beta1, self.beta2 = betas
        self.eps = eps

        # åˆå§‹åŒ–ä¸€é˜¶å’ŒäºŒé˜¶çŸ©
        self.m = [torch.zeros_like(p) for p in self.params]  # ä¸€é˜¶çŸ©ï¼ˆåŠ¨é‡ï¼‰
        self.v = [torch.zeros_like(p) for p in self.params]  # äºŒé˜¶çŸ©ï¼ˆRMSpropï¼‰
        self.t = 0  # æ—¶é—´æ­¥

    def step(self):
        self.t += 1

        for i, param in enumerate(self.params):
            if param.grad is None:
                continue

            grad = param.grad

            # æ›´æ–°ä¸€é˜¶çŸ©ï¼ˆåŠ¨é‡ï¼‰
            self.m[i] = self.beta1 * self.m[i] + (1 - self.beta1) * grad

            # æ›´æ–°äºŒé˜¶çŸ©ï¼ˆæ¢¯åº¦å¹³æ–¹çš„ç§»åŠ¨å¹³å‡ï¼‰
            self.v[i] = self.beta2 * self.v[i] + (1 - self.beta2) * grad**2

            # åå·®ä¿®æ­£
            m_hat = self.m[i] / (1 - self.beta1**self.t)
            v_hat = self.v[i] / (1 - self.beta2**self.t)

            # æ›´æ–°å‚æ•°
            param.data -= self.lr * m_hat / (torch.sqrt(v_hat) + self.eps)

    def zero_grad(self):
        for param in self.params:
            if param.grad is not None:
                param.grad.zero_()

# å¯¹æ¯”ä¸åŒä¼˜åŒ–å™¨
def compare_optimizers():
    """åœ¨å®é™…é—®é¢˜ä¸Šå¯¹æ¯”ä¸åŒä¼˜åŒ–å™¨"""

    # åˆ›å»ºä¸€ä¸ªå…·æœ‰æŒ‘æˆ˜æ€§çš„æŸå¤±åœ°å½¢
    def rosenbrock(x, y):
        """Rosenbrockå‡½æ•°ï¼šæœ‰ä¸€ä¸ªå¼¯æ›²çš„å±±è°·"""
        return (1 - x)**2 + 100 * (y - x**2)**2

    # èµ·å§‹ç‚¹
    start = torch.tensor([[-1.5], [2.0]], requires_grad=True)

    # æµ‹è¯•ä¸åŒä¼˜åŒ–å™¨
    optimizers = {
        'SGD': torch.optim.SGD([start.clone()], lr=0.001),
        'SGD+Momentum': torch.optim.SGD([start.clone()], lr=0.001, momentum=0.9),
        'RMSprop': torch.optim.RMSprop([start.clone()], lr=0.001),
        'Adam': torch.optim.Adam([start.clone()], lr=0.01)
    }

    # è®°å½•è½¨è¿¹
    trajectories = {}

    for name, opt in optimizers.items():
        param = list(opt.param_groups[0]['params'])[0]
        trajectory = [[param[0].item(), param[1].item()]]

        for _ in range(200):
            opt.zero_grad()
            loss = rosenbrock(param[0], param[1])
            loss.backward()
            opt.step()
            trajectory.append([param[0].item(), param[1].item()])

        trajectories[name] = np.array(trajectory)

    return trajectories

# å¯è§†åŒ–ç»“æœ
trajectories = compare_optimizers()

import matplotlib.pyplot as plt

fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(15, 6))

# è½¨è¿¹å›¾
x = np.linspace(-2, 2, 100)
y = np.linspace(-1, 3, 100)
X, Y = np.meshgrid(x, y)
Z = (1 - X)**2 + 100 * (Y - X**2)**2

contour = ax1.contour(X, Y, Z, levels=50, alpha=0.6)
ax1.clabel(contour, inline=True, fontsize=8)

colors = {'SGD': 'red', 'SGD+Momentum': 'orange', 'RMSprop': 'green', 'Adam': 'purple'}
for name, traj in trajectories.items():
    ax1.plot(traj[:, 0], traj[:, 1], 'o-', color=colors[name],
             label=name, markersize=3, alpha=0.7)

ax1.set_xlabel('x')
ax1.set_ylabel('y')
ax1.set_title('ä¼˜åŒ–å™¨è½¨è¿¹å¯¹æ¯”')
ax1.legend()
ax1.set_xlim(-2, 2)
ax1.set_ylim(-1, 3)

# æ”¶æ•›é€Ÿåº¦
for name, traj in trajectories.items():
    distances = np.sqrt((traj[:, 0] - 1)**2 + (traj[:, 1] - 1)**2)
    ax2.semilogy(distances, color=colors[name], label=name, linewidth=2)

ax2.set_xlabel('è¿­ä»£æ¬¡æ•°')
ax2.set_ylabel('åˆ°æœ€ä¼˜ç‚¹çš„è·ç¦»ï¼ˆå¯¹æ•°åˆ»åº¦ï¼‰')
ax2.set_title('æ”¶æ•›é€Ÿåº¦å¯¹æ¯”')
ax2.legend()
ax2.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()</code></pre>
                </div>
            </div>
        </section>
        <!-- ç« èŠ‚å°ç»“ -->
        <div class="tip success mt-4" style="background: rgba(249, 115, 22, 0.1); border-color: rgba(249, 115, 22, 0.3);">
            <span class="tip-icon">ğŸ“Œ</span>
            <div class="tip-content">
                <strong>æœ¬èŠ‚è¦ç‚¹å›é¡¾ï¼š</strong><br>
                âœ“ SGD â†’ Momentum â†’ RMSprop â†’ Adam æ˜¯ä¼˜åŒ–å™¨çš„è¿›åŒ–è·¯çº¿<br>
                âœ“ Adamç»“åˆäº†åŠ¨é‡ï¼ˆä¸€é˜¶çŸ©ï¼‰å’Œè‡ªé€‚åº”å­¦ä¹ ç‡ï¼ˆäºŒé˜¶çŸ©ï¼‰<br>
                âœ“ ä¸åŒä¼˜åŒ–å™¨é€‚åˆä¸åŒåœºæ™¯ï¼šSGDé€‚åˆå‡¸ä¼˜åŒ–ï¼ŒAdamé€‚åˆæ·±åº¦å­¦ä¹ <br>
                âœ“ å®è·µå»ºè®®ï¼šé»˜è®¤ç”¨Adamï¼Œè¿½æ±‚æœ€ä½³æ€§èƒ½æ—¶è¯•è¯•SGD+Momentum
            </div>
        </div>
    <div class="section-card" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(34, 197, 94, 0.1));">
        <h3 style="color: var(--accent-purple); margin-bottom: 1.5rem;">ğŸ§© æ‰€æœ‰æ‹¼å›¾å·²ç»é›†é½ï¼</h3>

        <div class="story-card">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h4 style="color: var(--accent-yellow);">æ·±åº¦ç½‘ç»œä¼˜åŒ–æŠ€æœ¯æ ˆ</h4>
                <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem;">
                    <div style="padding: 1rem; background: rgba(34, 197, 94, 0.2); border-radius: 0.5rem;">
                        <div style="font-size: 2rem;">ğŸ¯</div>
                        <p>æ­£ç¡®åˆå§‹åŒ–</p>
                    </div>
                    <div style="font-size: 1.5rem;">+</div>
                    <div style="padding: 1rem; background: rgba(6, 182, 212, 0.2); border-radius: 0.5rem;">
                        <div style="font-size: 2rem;">ğŸ”§</div>
                        <p>æ‰¹é‡å½’ä¸€åŒ–</p>
                    </div>
                    <div style="font-size: 1.5rem;">+</div>
                    <div style="padding: 1rem; background: rgba(249, 115, 22, 0.2); border-radius: 0.5rem;">
                        <div style="font-size: 2rem;">ğŸš€</div>
                        <p>ç°ä»£ä¼˜åŒ–å™¨</p>
                    </div>
                    <div style="font-size: 1.5rem;">=</div>
                    <div style="padding: 1rem; background: var(--primary-gradient); color: white; border-radius: 0.5rem;">
                        <div style="font-size: 2rem;">ğŸ’ª</div>
                        <p>ç¨³å®šæ·±åº¦ç½‘ç»œ</p>
                    </div>
                </div>
            </div>

            <div class="dialogue-box">
                <div class="speaker">
                    <div class="avatar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">ğŸ§™â€â™‚ï¸</div>
                    å¯¼å¸ˆï¼š
                </div>
                <div>"å•ç‹¬ä½¿ç”¨æ¯ä¸ªæŠ€æœ¯éƒ½æœ‰å¸®åŠ©ï¼Œä½†çœŸæ­£çš„é­”åŠ›åœ¨äºå®ƒä»¬çš„<strong>ååŒä½œç”¨</strong>ï¼"</div>
            </div>
        </div>

        <div class="tip success mt-3">
            <span class="tip-icon">ğŸ¯</span>
            <div class="tip-content">
                <strong>ä¸ºä»€ä¹ˆè¦ç»¼åˆä½¿ç”¨ï¼Ÿ</strong><br>
                â€¢ <strong>åˆå§‹åŒ–</strong>ï¼šç»™ç½‘ç»œä¸€ä¸ªå¥½çš„èµ·ç‚¹<br>
                â€¢ <strong>BatchNorm</strong>ï¼šä¿æŒè®­ç»ƒè¿‡ç¨‹ç¨³å®š<br>
                â€¢ <strong>ä¼˜åŒ–å™¨</strong>ï¼šé«˜æ•ˆåˆ©ç”¨æ¢¯åº¦ä¿¡æ¯<br>
                â€¢ <strong>æ®‹å·®è¿æ¥</strong>ï¼šä¸ºè¶…æ·±ç½‘ç»œæä¾›"é«˜é€Ÿå…¬è·¯"<br>
                <br>
                ç°åœ¨ï¼Œè®©æˆ‘ä»¬æŠŠæ‰€æœ‰æŠ€æœ¯æ•´åˆèµ·æ¥ï¼Œæ„å»ºä¸€ä¸ªçœŸæ­£ç¨³å®šçš„æ·±åº¦ç½‘ç»œï¼
            </div>
        </div>
    </div>

    <!-- ç»¼åˆå®æˆ˜ -->
        <section id="practice" class="section-card">
            <h2 style="color: var(--accent-green); margin-bottom: 1.5rem;">âš”ï¸ ç»¼åˆå®æˆ˜ï¼šæ„å»ºç¨³å®šçš„æ·±åº¦ç½‘ç»œ</h2>

            <div class="story-card">
                <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">æŠŠæ‰€æœ‰æŠ€å·§æ•´åˆèµ·æ¥</h3>

                <div class="dialogue-box">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">ğŸ§™â€â™‚ï¸</div>
                        å¯¼å¸ˆï¼š
                    </div>
                    <div>"ç°åœ¨ä½ ä»¬å·²ç»æŒæ¡äº†æ‰€æœ‰å·¥å…·ï¼Œæ˜¯æ—¶å€™å»ºé€ ä¸€ä¸ªçœŸæ­£çš„æ·±åº¦ç½‘ç»œäº†ã€‚è®°ä½ï¼Œè¿™äº›æŠ€å·§è¦é…åˆä½¿ç”¨ï¼"</div>
                </div>
            </div>

            <!-- æœ€ä½³å®è·µæ¸…å• -->
            <div class="action-checklist">
                <h3 style="color: var(--accent-yellow); margin-bottom: 1.5rem;">ğŸ“‹ æ·±åº¦ç½‘ç»œè®­ç»ƒæœ€ä½³å®è·µ</h3>

                <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                    <span><strong>åˆå§‹åŒ–ï¼š</strong>ä½¿ç”¨Heåˆå§‹åŒ–ï¼ˆReLUï¼‰æˆ–Xavieråˆå§‹åŒ–ï¼ˆTanh/Sigmoidï¼‰</span>
                </div>
                <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                    <span><strong>å½’ä¸€åŒ–ï¼š</strong>åœ¨æ¯ä¸ªçº¿æ€§å±‚åæ·»åŠ BatchNorm</span>
                </div>
                <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                    <span><strong>æ¿€æ´»å‡½æ•°ï¼š</strong>ä¼˜å…ˆä½¿ç”¨ReLUæˆ–å…¶å˜ä½“ï¼ˆLeakyReLUã€ELUï¼‰</span>
                </div>
                <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                    <span><strong>ä¼˜åŒ–å™¨ï¼š</strong>ä½¿ç”¨Adamä½œä¸ºé»˜è®¤é€‰æ‹©</span>
                </div>
                <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                    <span><strong>å­¦ä¹ ç‡è°ƒåº¦ï¼š</strong>ä½¿ç”¨ä½™å¼¦é€€ç«æˆ–åˆ†æ®µè¡°å‡</span>
                </div>
                <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                    <span><strong>æ¢¯åº¦è£å‰ªï¼š</strong>è®¾ç½®åˆç†çš„æ¢¯åº¦è£å‰ªé˜ˆå€¼ï¼ˆå¦‚5.0ï¼‰</span>
                </div>
                <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                    <span><strong>æ®‹å·®è¿æ¥ï¼š</strong>å¯¹äºè¶…æ·±ç½‘ç»œï¼Œä½¿ç”¨æ®‹å·®è¿æ¥</span>
                </div>
                <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                    <span><strong>ç›‘æ§æŒ‡æ ‡ï¼š</strong>å®æ—¶ç›‘æ§æ¢¯åº¦èŒƒæ•°å’Œæ¿€æ´»å€¼åˆ†å¸ƒ</span>
                </div>
            </div>

            <!-- å®Œæ•´å®ç° -->
            <div class="code-container mt-3">
                <div class="code-header">
                    <div class="code-header-left">
                        <span style="color: var(--text-secondary);">stable_deep_network.py - é›†æˆæ‰€æœ‰æŠ€å·§çš„ç¨³å®šæ·±åº¦ç½‘ç»œ</span>
                    </div>
                    <div class="code-header-right">
                        <button class="code-action" onclick="runFinalExperiment()">
                            â–¶ è¿è¡Œå®Œæ•´å®éªŒ
                        </button>
                    </div>
                </div>
                <div class="code-content">
                    <pre><code class="language-python">import torch
                        import torch.nn as nn
import torch.optim as optim
import torch.nn.functional as F
from torch.utils.data import DataLoader, TensorDataset
import matplotlib.pyplot as plt
import numpy as np
class ResidualBlock(nn.Module):
"""æ®‹å·®å—ï¼šè§£å†³æ·±åº¦ç½‘ç»œçš„é€€åŒ–é—®é¢˜"""
def init(self, channels):
super().init()
self.conv1 = nn.Conv2d(channels, channels, 3, padding=1)
self.bn1 = nn.BatchNorm2d(channels)
self.conv2 = nn.Conv2d(channels, channels, 3, padding=1)
self.bn2 = nn.BatchNorm2d(channels)
def forward(self, x):
    residual = x

    out = self.conv1(x)
    out = self.bn1(out)
    out = F.relu(out)

    out = self.conv2(out)
    out = self.bn2(out)

    out += residual  # æ®‹å·®è¿æ¥
    out = F.relu(out)

    return out

                        <!-- åœ¨ ResidualBlock ç±»å®šä¹‰åæ·»åŠ  -->
<div class="math-container mt-3">
    <h3 style="color: var(--accent-purple); margin-bottom: 1.5rem;">ğŸ¯ Pre-activation vs Post-activationï¼šæ®‹å·®è¿æ¥çš„æœ€ä½³å®è·µ</h3>

    <div class="math-container mt-3">
    <h3 style="color: var(--accent-purple); margin-bottom: 1.5rem;">ğŸŒ‰ æ®‹å·®è¿æ¥ï¼šä¸ºæ¢¯åº¦å»ºé€ "é«˜é€Ÿå…¬è·¯"</h3>

    <div class="concept-grid">
        <div class="concept-card what">
            <h4 style="color: var(--accent-green);">ä¼ ç»Ÿæ·±åº¦ç½‘ç»œ</h4>
            <div style="text-align: center; margin-top: 1rem;">
                <div style="font-family: monospace;">
                    x â†’ [å±‚1] â†’ [å±‚2] â†’ ... â†’ [å±‚30] â†’ y
                </div>
                <p style="margin-top: 0.5rem; color: var(--text-secondary);">
                    æ¢¯åº¦å¿…é¡»ç»è¿‡æ‰€æœ‰å±‚
                </p>
            </div>
        </div>

        <div class="concept-card how">
            <h4 style="color: var(--accent-blue);">æ®‹å·®ç½‘ç»œ</h4>
            <div style="text-align: center; margin-top: 1rem;">
                <div style="font-family: monospace;">
                    x â†’ [å±‚1] â†’ [å±‚2] â†’ ... â†’ [å±‚30] â†’ y<br>
                    â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€...â”€â”€â”€â”´â”€â”€â”€â”€â”˜
                </div>
                <p style="margin-top: 0.5rem; color: var(--text-secondary);">
                    æ¢¯åº¦å¯ä»¥"è·³è¿‡"ä¸­é—´å±‚
                </p>
            </div>
        </div>
    </div>

    <div class="math-formula mt-3">
        <strong>æ•°å­¦åŸç†ï¼š</strong><br>
        ä¼ ç»Ÿï¼šy = F(x)<br>
        æ®‹å·®ï¼šy = F(x) + x<br><br>

        åå‘ä¼ æ’­æ—¶ï¼š<br>
        âˆ‚y/âˆ‚x = âˆ‚F(x)/âˆ‚x + 1<br><br>

        <span style="color: var(--accent-green);">å³ä½¿Fçš„æ¢¯åº¦å¾ˆå°ï¼Œæ€»æœ‰"+1"ä¿è¯æ¢¯åº¦æµåŠ¨ï¼</span>
    </div>
</div>

    <div class="code-comparison-grid">
        <!-- Post-activation (åŸå§‹ResNet) -->
        <div style="position: relative;">
            <h4 style="color: var(--accent-yellow); margin-bottom: 1rem; text-align: center;">
                Post-activation (åŸå§‹)
            </h4>
            <pre style="background: rgba(15, 23, 42, 0.9); padding: 1rem; border-radius: 8px;"><code class="language-python"># åŸå§‹ResNetå—
class PostActBlock(nn.Module):
    def forward(self, x):
        identity = x

        out = self.conv1(x)
        out = self.bn1(out)
        out = self.relu(out)  # æ¿€æ´»åœ¨BNå

        out = self.conv2(out)
        out = self.bn2(out)

        out += identity
        out = self.relu(out)  # æœ€åæ¿€æ´»
        return out</code></pre>
        </div>

        <!-- Pre-activation (æ”¹è¿›ç‰ˆ) -->
        <div style="position: relative;">
            <h4 style="color: var(--accent-green); margin-bottom: 1rem; text-align: center;">
                Pre-activation (æ”¹è¿›ç‰ˆ)
            </h4>
            <pre style="background: rgba(15, 23, 42, 0.9); padding: 1rem; border-radius: 8px;"><code class="language-python"># Pre-activation ResNetå—
class PreActBlock(nn.Module):
    def forward(self, x):
        identity = x

        out = self.bn1(x)
        out = self.relu(out)  # æ¿€æ´»åœ¨å‰
        out = self.conv1(out)

        out = self.bn2(out)
        out = self.relu(out)
        out = self.conv2(out)

        out += identity  # æ’ç­‰æ˜ å°„æ›´"å¹²å‡€"
        return out</code></pre>
        </div>
    </div>

    <div class="tip info mt-3">
        <span class="tip-icon">ğŸ’¡</span>
        <div class="tip-content">
            <strong>Pre-activationçš„ä¼˜åŠ¿ï¼š</strong><br>
            â€¢ <strong>æ›´å¥½çš„æ¢¯åº¦æµï¼š</strong>æ’ç­‰æ˜ å°„è·¯å¾„å®Œå…¨æ²¡æœ‰éçº¿æ€§ï¼Œæ¢¯åº¦å¯ä»¥æ— æŸä¼ æ’­<br>
            â€¢ <strong>æ›´å®¹æ˜“ä¼˜åŒ–ï¼š</strong>æ¯ä¸ªæ®‹å·®å—å­¦ä¹ çš„æ˜¯"é¢„æ¿€æ´»"åçš„æ®‹å·®<br>
            â€¢ <strong>æ›´æ·±çš„ç½‘ç»œï¼š</strong>å¯ä»¥è®­ç»ƒ1000+å±‚çš„ç½‘ç»œï¼ˆåŸå§‹ResNetåœ¨200å±‚åå°±é€€åŒ–ï¼‰<br>
            â€¢ <strong>æ›´å¥½çš„ç‰¹å¾ï¼š</strong>BNç»Ÿè®¡é‡æ›´ç¨³å®šï¼Œæ¿€æ´»åˆ†å¸ƒæ›´å‡åŒ€
        </div>
    </div>
</div>
class StableDeepNetwork(nn.Module):
"""ä½¿ç”¨æ‰€æœ‰ä¼˜åŒ–æŠ€å·§çš„æ·±åº¦ç½‘ç»œ"""
def __init__(self, num_blocks=25, num_classes=10):
    super().__init__()

    # è¾“å…¥å±‚
    self.conv1 = nn.Conv2d(3, 64, 7, stride=2, padding=3)
    self.bn1 = nn.BatchNorm2d(64)
    self.maxpool = nn.MaxPool2d(3, stride=2, padding=1)

    # æ®‹å·®å—
    self.blocks = nn.Sequential(
        *[ResidualBlock(64) for _ in range(num_blocks)]
    )

    # è¾“å‡ºå±‚
    self.avgpool = nn.AdaptiveAvgPool2d((1, 1))
    self.fc = nn.Linear(64, num_classes)

    # åˆå§‹åŒ–
    self._initialize_weights()

def _initialize_weights(self):
    """ä½¿ç”¨Heåˆå§‹åŒ–"""
    for m in self.modules():
        if isinstance(m, nn.Conv2d):
            nn.init.kaiming_normal_(m.weight, mode='fan_out', nonlinearity='relu')
            if m.bias is not None:
                nn.init.constant_(m.bias, 0)
        elif isinstance(m, nn.BatchNorm2d):
            nn.init.constant_(m.weight, 1)
            nn.init.constant_(m.bias, 0)
        elif isinstance(m, nn.Linear):
            nn.init.normal_(m.weight, 0, 0.01)
            nn.init.constant_(m.bias, 0)

def forward(self, x):
    # è¾“å…¥å±‚
    x = self.conv1(x)
    x = self.bn1(x)
    x = F.relu(x)
    x = self.maxpool(x)

    # æ®‹å·®å—
    x = self.blocks(x)

    # è¾“å‡ºå±‚
    x = self.avgpool(x)
    x = x.view(x.size(0), -1)
    x = self.fc(x)

    return x
def train_stable_network():
"""è®­ç»ƒæ·±åº¦ç½‘ç»œçš„å®Œæ•´æµç¨‹"""
# è®¾ç½®éšæœºç§å­
torch.manual_seed(42)

# ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼ˆå®é™…åº”ç”¨ä¸­ä½¿ç”¨çœŸå®æ•°æ®é›†ï¼‰
print("ğŸ“Š ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®...")
X_train = torch.randn(1000, 3, 32, 32)
y_train = torch.randint(0, 10, (1000,))
X_val = torch.randn(200, 3, 32, 32)
y_val = torch.randint(0, 10, (200,))

# åˆ›å»ºæ•°æ®åŠ è½½å™¨
train_dataset = TensorDataset(X_train, y_train)
val_dataset = TensorDataset(X_val, y_val)
train_loader = DataLoader(train_dataset, batch_size=32, shuffle=True)
val_loader = DataLoader(val_dataset, batch_size=32, shuffle=False)

# åˆ›å»ºæ¨¡å‹
print("\nğŸ—ï¸ åˆ›å»º50å±‚æ·±åº¦ç½‘ç»œ...")
model = StableDeepNetwork(num_blocks=25)  # 25ä¸ªæ®‹å·®å— = 50å±‚
total_params = sum(p.numel() for p in model.parameters())
print(f"æ€»å‚æ•°é‡: {total_params:,}")

# æŸå¤±å‡½æ•°å’Œä¼˜åŒ–å™¨
criterion = nn.CrossEntropyLoss()
optimizer = optim.Adam(model.parameters(), lr=0.001)

# å­¦ä¹ ç‡è°ƒåº¦å™¨
scheduler = optim.lr_scheduler.CosineAnnealingLR(optimizer, T_max=50)

# è®­ç»ƒé…ç½®
num_epochs = 50
device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
model = model.to(device)

# è®°å½•è®­ç»ƒè¿‡ç¨‹
history = {
    'train_loss': [],
    'val_loss': [],
    'val_acc': [],
    'lr': [],
    'grad_norm': []
}

print(f"\nğŸš€ å¼€å§‹è®­ç»ƒï¼ˆè®¾å¤‡: {device}ï¼‰...")

for epoch in range(num_epochs):
    # è®­ç»ƒé˜¶æ®µ
    model.train()
    train_loss = 0.0
    grad_norms = []

    for batch_idx, (data, target) in enumerate(train_loader):
        data, target = data.to(device), target.to(device)

        optimizer.zero_grad()
        output = model(data)
        loss = criterion(output, target)

        loss.backward()

        # æ¢¯åº¦è£å‰ª
        grad_norm = nn.utils.clip_grad_norm_(model.parameters(), max_norm=5.0)
        grad_norms.append(grad_norm.item())

        optimizer.step()
        train_loss += loss.item()

    # éªŒè¯é˜¶æ®µ
    model.eval()
    val_loss = 0.0
    correct = 0

    with torch.no_grad():
        for data, target in val_loader:
            data, target = data.to(device), target.to(device)
            output = model(data)
            val_loss += criterion(output, target).item()
            pred = output.argmax(dim=1)
            correct += pred.eq(target).sum().item()

    # è®¡ç®—æŒ‡æ ‡
    train_loss /= len(train_loader)
    val_loss /= len(val_loader)
    val_acc = correct / len(val_dataset)
    avg_grad_norm = np.mean(grad_norms)
    current_lr = scheduler.get_last_lr()[0]

    # è®°å½•å†å²
    history['train_loss'].append(train_loss)
    history['val_loss'].append(val_loss)
    history['val_acc'].append(val_acc)
    history['lr'].append(current_lr)
    history['grad_norm'].append(avg_grad_norm)

    # æ›´æ–°å­¦ä¹ ç‡
    scheduler.step()

    # æ‰“å°è¿›åº¦
    if epoch % 10 == 0:
        print(f"Epoch {epoch}/{num_epochs} - "
              f"Train Loss: {train_loss:.4f}, "
              f"Val Loss: {val_loss:.4f}, "
              f"Val Acc: {val_acc:.4f}, "
              f"LR: {current_lr:.6f}, "
              f"Grad Norm: {avg_grad_norm:.4f}")

print("\nâœ… è®­ç»ƒå®Œæˆï¼50å±‚ç½‘ç»œæˆåŠŸæ”¶æ•›ï¼")

return model, history
def analyze_gradient_flow(model, sample_input):
"""åˆ†ææ¨¡å‹çš„æ¢¯åº¦æµ"""
model.eval()
sample_input.requires_grad_(True)
# å‰å‘ä¼ æ’­
output = model(sample_input)
loss = output.sum()

# åå‘ä¼ æ’­
loss.backward()

# æ”¶é›†æ¢¯åº¦ä¿¡æ¯
gradients = []
layer_names = []

for name, param in model.named_parameters():
    if param.grad is not None and 'weight' in name:
        grad_norm = param.grad.norm().item()
        gradients.append(grad_norm)
        layer_names.append(name)

# å¯è§†åŒ–æ¢¯åº¦æµ
plt.figure(figsize=(12, 6))
plt.semilogy(range(len(gradients)), gradients, 'o-', markersize=6)
plt.xlabel('å±‚ç´¢å¼•')
plt.ylabel('æ¢¯åº¦èŒƒæ•°ï¼ˆå¯¹æ•°åˆ»åº¦ï¼‰')
plt.title('50å±‚ç½‘ç»œçš„æ¢¯åº¦æµåˆ†æ')
plt.xticks(range(0, len(gradients), 5), rotation=45)
plt.grid(True, alpha=0.3)

# æ·»åŠ å‚è€ƒçº¿
plt.axhline(y=1.0, color='red', linestyle='--', alpha=0.5, label='å‚è€ƒå€¼=1.0')
plt.legend()

plt.tight_layout()
plt.show()

# æ‰“å°ç»Ÿè®¡ä¿¡æ¯
print("\nğŸ“Š æ¢¯åº¦æµåˆ†æ:")
print(f"æœ€å¤§æ¢¯åº¦èŒƒæ•°: {max(gradients):.4f}")
print(f"æœ€å°æ¢¯åº¦èŒƒæ•°: {min(gradients):.4f}")
print(f"æ¢¯åº¦èŒƒæ•°æ¯”ç‡: {max(gradients)/min(gradients):.2f}")

if max(gradients)/min(gradients) < 1000:
    print("âœ… æ¢¯åº¦æµç¨³å®šï¼")
else:
    print("âš ï¸ æ¢¯åº¦æµå­˜åœ¨ä¸€å®šçš„ä¸ç¨³å®šæ€§")
è¿è¡Œå®Œæ•´çš„è®­ç»ƒæµç¨‹
print("="*60)
print("ğŸ¯ æ·±åº¦ç½‘ç»œä¼˜åŒ–æŠ€å·§ç»¼åˆå®æˆ˜")
print("="*60)
model, history = train_stable_network()
visualize_training_history(history)
åˆ†ææ¢¯åº¦æµ
print("\nğŸ”¬ åˆ†æè®­ç»ƒåçš„æ¢¯åº¦æµ...")
sample_input = torch.randn(1, 3, 32, 32)
if torch.cuda.is_available():
model = model.cpu()
sample_input = sample_input.cpu()
analyze_gradient_flow(model, sample_input)
æ€»ç»“
print("\n" + "="*60)
print("ğŸ‰ æˆåŠŸè®­ç»ƒ50å±‚æ·±åº¦ç½‘ç»œï¼ä½¿ç”¨çš„å…³é”®æŠ€æœ¯ï¼š")
print("="*60)
print("1. âœ… Heåˆå§‹åŒ– - é€‚åˆReLUæ¿€æ´»çš„æƒé‡åˆå§‹åŒ–")
print("2. âœ… BatchNorm - ç¨³å®šæ¯å±‚çš„è¾“å…¥åˆ†å¸ƒ")
print("3. âœ… æ®‹å·®è¿æ¥ - è§£å†³æ·±åº¦ç½‘ç»œçš„é€€åŒ–é—®é¢˜")
print("4. âœ… Adamä¼˜åŒ–å™¨ - è‡ªé€‚åº”å­¦ä¹ ç‡")
print("5. âœ… å­¦ä¹ ç‡è°ƒåº¦ - ä½™å¼¦é€€ç«ç­–ç•¥")
print("6. âœ… æ¢¯åº¦è£å‰ª - é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸")
print("="*60)</code></pre>
                </div>
            </div>
            <!-- å®éªŒç»“æœå±•ç¤º -->
            <div class="visualization-container mt-3">
                <h3 style="color: var(--accent-purple); margin-bottom: 1.5rem;">ğŸ“Š å®éªŒç»“æœï¼šç¨³å®šè®­ç»ƒçš„è¯æ˜</h3>

                <canvas id="final-results" width="800" height="400"></canvas>

                <div class="tip success mt-3">
                    <span class="tip-icon">ğŸ†</span>
                    <div class="tip-content">
                        <strong>æˆåŠŸï¼æˆ‘ä»¬åšåˆ°äº†ï¼š</strong><br>
                        â€¢ 50å±‚æ·±åº¦ç½‘ç»œç¨³å®šè®­ç»ƒ<br>
                        â€¢ æ¢¯åº¦å§‹ç»ˆä¿æŒåœ¨åˆç†èŒƒå›´<br>
                        â€¢ æŸå¤±å‡½æ•°å¹³æ»‘ä¸‹é™<br>
                        â€¢ éªŒè¯å‡†ç¡®ç‡ç¨³æ­¥æå‡
                    </div>
                </div>
            </div>
        </section>

        <!-- æ€»ç»“ä¸å±•æœ› -->
        <section id="summary" class="section-card">
            <h2 style="color: var(--accent-green); margin-bottom: 1.5rem;">ğŸ“ æ€»ç»“ï¼šæ·±åº¦å­¦ä¹ ä¼˜åŒ–çš„æ™ºæ…§</h2>

            <div class="story-card">
                <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">ä»æŒ«è´¥åˆ°æˆåŠŸçš„æ—…ç¨‹</h3>

                <div class="dialogue-box">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">ğŸ§‘â€ğŸ’»</div>
                        å°æï¼ˆå…´å¥‹åœ°ï¼‰ï¼š
                    </div>
                    <div>"å¯¼å¸ˆï¼Œæˆ‘ä»¬æˆåŠŸäº†ï¼50å±‚ç½‘ç»œè®­ç»ƒå¾—å¾ˆå¥½ï¼"</div>
                </div>

                <div class="dialogue-box mt-2">
                    <div class="speaker">
                        <div class="avatar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">ğŸ§™â€â™‚ï¸</div>
                        å¯¼å¸ˆï¼ˆå¾®ç¬‘ï¼‰ï¼š
                    </div>
                    <div>"è®°ä½ï¼Œè¿™äº›æŠ€æœ¯ä¸æ˜¯é­”æ³•ï¼Œè€Œæ˜¯åŸºäºæ·±åˆ»æ•°å­¦åŸç†çš„å·¥ç¨‹æ™ºæ…§ã€‚ç†è§£åŸç†ï¼Œæ‰èƒ½çµæ´»è¿ç”¨ã€‚"</div>
                </div>
            </div>

            <!-- æ ¸å¿ƒè¦ç‚¹æ€»ç»“ -->
            <div class="concept-grid">
                <div class="concept-card why">
                    <h3 style="color: var(--accent-red); margin-bottom: 1rem;">ğŸ” é—®é¢˜æœ¬è´¨</h3>
                    <p>
                        <strong>æ¢¯åº¦æ¶ˆå¤±/çˆ†ç‚¸çš„æ ¹æºï¼š</strong><br>
                        â€¢ é“¾å¼æ³•åˆ™çš„ç´¯ç§¯æ•ˆåº”<br>
                        â€¢ æ¿€æ´»å‡½æ•°çš„é¥±å’Œé—®é¢˜<br>
                        â€¢ ä¸å½“çš„æƒé‡åˆå§‹åŒ–<br>
                        â€¢ å†…éƒ¨åå˜é‡åç§»
                    </p>
                </div>

                <div class="concept-card what">
                    <h3 style="color: var(--accent-green); margin-bottom: 1rem;">ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ</h3>
                    <p>
                        <strong>å››å¤§æ³•å®ï¼š</strong><br>
                        â€¢ Xavier/Heåˆå§‹åŒ–<br>
                        â€¢ æ‰¹é‡å½’ä¸€åŒ–ï¼ˆBatchNormï¼‰<br>
                        â€¢ ç°ä»£ä¼˜åŒ–å™¨ï¼ˆAdamï¼‰<br>
                        â€¢ æ®‹å·®è¿æ¥ï¼ˆResNetï¼‰
                    </p>
                </div>

                <div class="concept-card how">
                    <h3 style="color: var(--accent-blue); margin-bottom: 1rem;">ğŸ’¡ æ ¸å¿ƒæ€æƒ³</h3>
                    <p>
                        <strong>ä¿æŒä¿¡å·ç¨³å®šä¼ æ’­ï¼š</strong><br>
                        â€¢ å‰å‘ï¼šæ¿€æ´»å€¼ä¸çˆ†ç‚¸<br>
                        â€¢ åå‘ï¼šæ¢¯åº¦ä¸æ¶ˆå¤±<br>
                        â€¢ è®­ç»ƒï¼šå‚æ•°ç¨³å®šæ›´æ–°<br>
                        â€¢ ç»“æ„ï¼šè·³è·ƒè¿æ¥
                    </p>
                </div>

                <div class="concept-card pitfall">
                    <h3 style="color: var(--accent-orange); margin-bottom: 1rem;">âš¡ å®æˆ˜è¦ç‚¹</h3>
                    <p>
                        <strong>ç»„åˆä½¿ç”¨æ•ˆæœæœ€ä½³ï¼š</strong><br>
                        â€¢ åˆå§‹åŒ– + BN + ä¼˜åŒ–å™¨<br>
                        â€¢ æ®‹å·®è¿æ¥ + æ¢¯åº¦è£å‰ª<br>
                        â€¢ å­¦ä¹ ç‡è°ƒåº¦ + æ­£åˆ™åŒ–<br>
                        â€¢ ç›‘æ§ + è°ƒè¯• + è€å¿ƒ
                    </p>
                </div>
            </div>

            <!-- çŸ¥è¯†å›¾è°± -->
            <div class="visualization-container mt-4">
                <h3 style="color: var(--accent-purple); margin-bottom: 1.5rem;">ğŸ—ºï¸ æ·±åº¦å­¦ä¹ ä¼˜åŒ–æŠ€æœ¯å…¨æ™¯å›¾</h3>

                <div class="matrix-container">
                    <div class="matrix-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <!-- é—®é¢˜ç±»åˆ« -->
                        <div class="matrix-cell header" style="grid-column: span 4; text-align: center; background: var(--accent-purple);">
                            æ·±åº¦å­¦ä¹ ä¼˜åŒ–æŠ€æœ¯ä½“ç³»
                        </div>

                        <!-- æ¢¯åº¦é—®é¢˜ -->
                        <div class="matrix-cell header" style="background: rgba(239, 68, 68, 0.3);">æ¢¯åº¦é—®é¢˜</div>
                        <div class="matrix-cell value">æ¢¯åº¦æ¶ˆå¤±</div>
                        <div class="matrix-cell value">æ¢¯åº¦çˆ†ç‚¸</div>
                        <div class="matrix-cell value">æ¢¯åº¦ä¸ç¨³å®š</div>

                        <!-- åˆå§‹åŒ–æŠ€æœ¯ -->
                        <div class="matrix-cell header" style="background: rgba(34, 197, 94, 0.3);">åˆå§‹åŒ–æŠ€æœ¯</div>
                        <div class="matrix-cell value">Xavieråˆå§‹åŒ–</div>
                        <div class="matrix-cell value">Heåˆå§‹åŒ–</div>
                        <div class="matrix-cell value">LSUVåˆå§‹åŒ–</div>

                        <!-- å½’ä¸€åŒ–æŠ€æœ¯ -->
                        <div class="matrix-cell header" style="background: rgba(6, 182, 212, 0.3);">å½’ä¸€åŒ–æŠ€æœ¯</div>
                        <div class="matrix-cell value">BatchNorm</div>
                        <div class="matrix-cell value">LayerNorm</div>
                        <div class="matrix-cell value">GroupNorm</div>

                        <!-- ä¼˜åŒ–å™¨ -->
                        <div class="matrix-cell header" style="background: rgba(139, 92, 246, 0.3);">ä¼˜åŒ–å™¨</div>
                        <div class="matrix-cell value">SGD+Momentum</div>
                        <div class="matrix-cell value">Adam/AdamW</div>
                        <div class="matrix-cell value">RMSprop</div>

                        <!-- ç½‘ç»œç»“æ„ -->
                        <div class="matrix-cell header" style="background: rgba(251, 191, 36, 0.3);">ç½‘ç»œç»“æ„</div>
                        <div class="matrix-cell value">æ®‹å·®è¿æ¥</div>
                        <div class="matrix-cell value">å¯†é›†è¿æ¥</div>
                        <div class="matrix-cell value">æ³¨æ„åŠ›æœºåˆ¶</div>
                    </div>
                </div>
            </div>

            <div class="think-box mt-4">
                <h3 style="color: var(--accent-purple); margin-bottom: 1rem;">ğŸ¤” æ·±åº¦æ€è€ƒ</h3>
                <p>è¿™ä¸€ç« æˆ‘ä»¬è§£å†³äº†æ·±åº¦ç½‘ç»œçš„è®­ç»ƒé—®é¢˜ï¼Œä½†è¿™åªæ˜¯å¼€å§‹ã€‚</p>
                <p>æ€è€ƒä¸€ä¸‹ï¼š</p>
                <ul style="margin-left: 2rem; line-height: 1.8;">
                    <li>ä¸ºä»€ä¹ˆResNetå¯ä»¥è®­ç»ƒ1000å±‚çš„ç½‘ç»œï¼Ÿ</li>
                    <li>Transformerä¸ºä»€ä¹ˆä¸éœ€è¦é‚£ä¹ˆæ·±ï¼Ÿ</li>
                    <li>Layer Normalizationå’ŒBatch Normalizationæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</li>
                    <li>ä¸ºä»€ä¹ˆæœ‰äº›ä»»åŠ¡SGDæ¯”Adamæ•ˆæœæ›´å¥½ï¼Ÿ</li>
                    <li>æœªæ¥è¿˜ä¼šæœ‰ä»€ä¹ˆæ–°çš„ä¼˜åŒ–æŠ€æœ¯ï¼Ÿ</li>
                </ul>
            </div>
            <!-- åœ¨æ·±åº¦æ€è€ƒçš„é—®é¢˜åˆ—è¡¨åæ·»åŠ  -->
            <div class="think-box mt-3" style="background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3);">
                <h4 style="color: var(--accent-green); margin-bottom: 1rem;">ğŸ’¡ æ€è€ƒé¢˜æç¤º</h4>
                <p><strong>Q: ä¸ºä»€ä¹ˆResNetå¯ä»¥è®­ç»ƒ1000å±‚ï¼Ÿ</strong><br>
                    A: æ®‹å·®è¿æ¥åˆ›å»ºäº†"é«˜é€Ÿå…¬è·¯"ï¼Œæ¢¯åº¦å¯ä»¥è·³è¿‡ä¸­é—´å±‚ç›´æ¥ä¼ æ’­ã€‚</p>

                <p><strong>Q: Transformerä¸ºä»€ä¹ˆä¸éœ€è¦é‚£ä¹ˆæ·±ï¼Ÿ</strong><br>
                    A: è‡ªæ³¨æ„åŠ›æœºåˆ¶è®©æ¯å±‚éƒ½èƒ½"çœ‹åˆ°"æ‰€æœ‰ä¿¡æ¯ï¼Œä¸éœ€è¦é€å±‚æŠ½è±¡ã€‚</p>

                <p><strong>Q: ä¸ºä»€ä¹ˆæœ‰äº›ä»»åŠ¡SGDæ¯”Adamæ›´å¥½ï¼Ÿ</strong><br>
                    A: SGDçš„è§£æ›´å®¹æ˜“æ³›åŒ–ï¼ŒAdamå¯èƒ½é™·å…¥å°–é”çš„å±€éƒ¨æœ€ä¼˜ã€‚</p>
            </div>

            <!-- å®è·µå»ºè®® -->
            <div class="action-checklist mt-4">
                <h3 style="color: var(--accent-yellow); margin-bottom: 1.5rem;">ğŸ“‹ è¡ŒåŠ¨è®¡åˆ’ï¼šæ·±åŒ–ç†è§£</h3>

                <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                    <span>å®ç°ä¸€ä¸ªæ¢¯åº¦ç›‘æ§å·¥å…·ï¼Œå¯è§†åŒ–è®­ç»ƒè¿‡ç¨‹</span>
                </div>
                <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                    <span>å¯¹æ¯”ä¸åŒåˆå§‹åŒ–æ–¹æ³•åœ¨ä¸åŒæ¿€æ´»å‡½æ•°ä¸‹çš„æ•ˆæœ</span>
                </div>
                <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                    <span>ä»é›¶å®ç°BatchNormçš„å‰å‘å’Œåå‘ä¼ æ’­</span>
                </div>
                <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                    <span>å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆçš„Adamä¼˜åŒ–å™¨</span>
                </div>
                <div class="checklist-item">
                    <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
                    <span>è®­ç»ƒä¸€ä¸ª100å±‚çš„æ®‹å·®ç½‘ç»œå¹¶åˆ†ææ¢¯åº¦æµ</span>
                </div>
            </div>

            <!-- ä¸‹ä¸€ç« é¢„å‘Š -->
            <div style="background: var(--primary-gradient); padding: 3rem; border-radius: 1rem; margin-top: 3rem; text-align: center; color: white;">
                <h3 style="margin-bottom: 1rem;">ğŸš€ ä¸‹ä¸€ç« é¢„å‘Š</h3>
                <h2 style="margin-bottom: 1rem;">ç¬¬5ç« ï¼šå·ç§¯ç¥ç»ç½‘ç»œ - çœ‹è§æ¨¡å¼çš„è‰ºæœ¯</h2>
                <p style="opacity: 0.9; max-width: 600px; margin: 0 auto;">
                    æˆ‘ä»¬å·²ç»è®©æ·±åº¦ç½‘ç»œèƒ½å¤Ÿç¨³å®šè®­ç»ƒäº†ï¼Œä½†å¤„ç†å›¾åƒæ—¶ï¼Œå…¨è¿æ¥ç½‘ç»œæœ‰ä¸ªè‡´å‘½é—®é¢˜...<br>
                    ä¸‹ä¸€ç« ï¼Œè®©æˆ‘ä»¬æ¢ç´¢CNNå¦‚ä½•é€šè¿‡"å±€éƒ¨æ„ŸçŸ¥"å’Œ"æƒé‡å…±äº«"ä¼˜é›…åœ°è§£å†³è¿™ä¸ªé—®é¢˜ï¼
                </p>
                <button class="btn" style="background: white; color: var(--bg-dark); margin-top: 2rem;" onclick="location.href='chapter5.html'">
                    å¼€å§‹ä¸‹ä¸€ç«  â†’
                </button>
            </div>
        </section>

        <!-- åé¦ˆåŒºåŸŸ -->
        <section class="section-card">
            <h3 style="color: var(--accent-blue); margin-bottom: 1.5rem;">ğŸ’¬ å­¦ä¹ åé¦ˆ</h3>
            <div class="text-center">
                <p>è¿™ä¸€ç« å¯¹ä½ æœ‰å¸®åŠ©å—ï¼Ÿ</p>
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="submitFeedback('helpful')">
                        ğŸ‘ å¾ˆæœ‰å¸®åŠ©
                    </button>
                    <button class="btn btn-secondary" onclick="submitFeedback('ok')">
                        ğŸ˜ è¿˜å¯ä»¥
                    </button>
                    <button class="btn btn-secondary" onclick="submitFeedback('confusing')">
                        ğŸ˜• æœ‰ç‚¹å›°æƒ‘
                    </button>
                </div>
            </div>
        </section>
    </div>
</main>
<!-- JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<script>
    // åˆå§‹åŒ–è¯­æ³•é«˜äº®
    hljs.highlightAll();

    // åˆå§‹åŒ–æ•°å­¦å…¬å¼æ¸²æŸ“
    renderMathInElement(document.body, {
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false}
        ]
    });

    // å…¨å±€çŠ¶æ€ç®¡ç†
    let animationsEnabled = true;
    let currentTheme = 'dark';
    let sidebarOpen = false;

    // å¯¼èˆªåŠŸèƒ½
    document.getElementById('toggle-sidebar').addEventListener('click', () => {
        sidebarOpen = !sidebarOpen;
        document.getElementById('sidebar').classList.toggle('open', sidebarOpen);
        document.getElementById('sidebar-overlay').classList.toggle('active', sidebarOpen);
    });

    document.getElementById('sidebar-overlay').addEventListener('click', () => {
        sidebarOpen = false;
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebar-overlay').classList.remove('active');
    });

    // ä¸»é¢˜åˆ‡æ¢
    document.getElementById('toggle-theme').addEventListener('click', () => {
        currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', currentTheme);
    });

    // åŠ¨ç”»æ§åˆ¶
    document.getElementById('toggle-animations').addEventListener('click', () => {
        animationsEnabled = !animationsEnabled;
        document.documentElement.style.setProperty('--animation-duration', animationsEnabled ? '0.3s' : '0s');
    });

    // è¿›åº¦æ¡æ›´æ–°
    function updateProgressBar() {
        const scrolled = window.scrollY;
        const height = document.documentElement.scrollHeight - window.innerHeight;
        const progress = (scrolled / height) * 100;
        document.getElementById('progress-bar').style.width = progress + '%';
    }

    window.addEventListener('scroll', () => {
        updateProgressBar();

        // éšè—/æ˜¾ç¤ºå¯¼èˆªæ 
        const nav = document.querySelector('.nav-header');
        if (window.scrollY > 100) {
            nav.classList.add('scrolled');
        } else {
            nav.classList.remove('scrolled');
        }
    });

    // ç›®å½•é«˜äº®
    const sections = document.querySelectorAll('section[id]');
    const tocItems = document.querySelectorAll('.toc-item');

    function updateTOC() {
        let current = '';
        sections.forEach(section => {
            const rect = section.getBoundingClientRect();
            if (rect.top <= 100 && rect.bottom >= 100) {
                current = section.getAttribute('id');
            }
        });

        tocItems.forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('href') === '#' + current) {
                item.classList.add('active');
            }
        });
    }

    window.addEventListener('scroll', updateTOC);

    // ä»£ç æ ‡ç­¾åˆ‡æ¢
    document.querySelectorAll('.code-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const container = this.closest('.code-container');
            const tabs = container.querySelectorAll('.code-tab');
            const contents = container.querySelectorAll('.code-content[data-tab-content]');

            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');

            contents.forEach(content => {
                content.style.display = 'none';
            });

            const targetContent = container.querySelector(`[data-tab-content="${this.dataset.tab}"]`);
            if (targetContent) {
                targetContent.style.display = 'block';
            }
        });
    });

    // ä»£ç è¿è¡Œæ¨¡æ‹Ÿ
    function runCode(button, outputId) {
        const output = document.getElementById(outputId);
        output.classList.add('show');

        // æ¨¡æ‹Ÿè¿è¡Œæ•ˆæœ
        const originalText = button.innerHTML;
        button.innerHTML = '<span class="loading"></span> è¿è¡Œä¸­...';
        button.disabled = true;

        setTimeout(() => {
            button.innerHTML = 'âœ… è¿è¡Œå®Œæˆ';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 1500);
        }, 1500);
    }

    // Canvaså¯è§†åŒ–ï¼šæ¢¯åº¦æµ
    function visualizeGradientFlow() {
        const canvas = document.getElementById('gradient-flow-viz');
        const ctx = canvas.getContext('2d');

        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // æ•°æ®
        const layers = 30;
        const gradients = [];
        let current = 1.0;

        // æ¨¡æ‹Ÿæ¢¯åº¦è¡°å‡
        for (let i = 0; i < layers; i++) {
            current *= 0.2; // Sigmoidå¯¼æ•°å¹³å‡å€¼
            gradients.push(current);
        }

        // ç»˜åˆ¶èƒŒæ™¯
        ctx.fillStyle = 'rgba(15, 23, 42, 0.8)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶ç½‘æ ¼
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.lineWidth = 1;
        for (let i = 0; i <= 10; i++) {
            const y = (i / 10) * canvas.height;
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
        }

        // ç»˜åˆ¶æ¢¯åº¦æ›²çº¿
        const padding = 40;
        const width = canvas.width - 2 * padding;
        const height = canvas.height - 2 * padding;

        ctx.strokeStyle = '#ef4444';
        ctx.lineWidth = 3;
        ctx.beginPath();

        gradients.forEach((grad, i) => {
            const x = padding + (i / (layers - 1)) * width;
            const y = padding + height - (Math.log10(grad + 1e-20) + 20) * height / 20;

            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }

            // ç»˜åˆ¶æ•°æ®ç‚¹
            ctx.fillStyle = '#ef4444';
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
        });

        ctx.stroke();

        // ç»˜åˆ¶æ ‡ç­¾
        ctx.fillStyle = '#f1f5f9';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('å±‚æ•°ï¼ˆä»åå¾€å‰ï¼‰', canvas.width / 2, canvas.height - 10);

        ctx.save();
        ctx.translate(15, canvas.height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText('æ¢¯åº¦å¤§å°ï¼ˆå¯¹æ•°åˆ»åº¦ï¼‰', 0, 0);
        ctx.restore();

        // ç»˜åˆ¶æ ‡é¢˜
        ctx.font = 'bold 16px sans-serif';
        ctx.fillText('æ¢¯åº¦åœ¨æ·±åº¦ç½‘ç»œä¸­çš„æŒ‡æ•°çº§è¡°å‡', canvas.width / 2, 25);
    }

    // åŠ¨ç”»æ¢¯åº¦æµ
    let animationFrame = null;
    function animateGradientFlow() {
        if (animationFrame) {
            cancelAnimationFrame(animationFrame);
            animationFrame = null;
            return;
        }

        const canvas = document.getElementById('gradient-flow-viz');
        const ctx = canvas.getContext('2d');
        let progress = 0;

        function animate() {
            progress += 0.02;
            if (progress > 1) progress = 0;

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // é‡æ–°ç»˜åˆ¶é™æ€éƒ¨åˆ†
            visualizeGradientFlow();

            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            const x = 40 + progress * (canvas.width - 80);
            ctx.strokeStyle = '#fbbf24';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, 40);
            ctx.lineTo(x, canvas.height - 40);
            ctx.stroke();

            animationFrame = requestAnimationFrame(animate);
        }

        animate();
    }

    // Sigmoidå¯è§†åŒ–
    function updateSigmoidPlot() {
        const canvas = document.getElementById('sigmoid-viz');
        const ctx = canvas.getContext('2d');
        const range = parseInt(document.getElementById('sigmoid-range').value);

        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶èƒŒæ™¯
        ctx.fillStyle = 'rgba(15, 23, 42, 0.8)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // è®¾ç½®åæ ‡ç³»
        const padding = 40;
        const width = canvas.width - 2 * padding;
        const height = canvas.height - 2 * padding;
        const centerX = padding + width / 2;
        const centerY = padding + height / 2;

        // ç»˜åˆ¶åæ ‡è½´
        ctx.strokeStyle = '#666';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padding, centerY);
        ctx.lineTo(canvas.width - padding, centerY);
        ctx.moveTo(centerX, padding);
        ctx.lineTo(centerX, canvas.height - padding);
        ctx.stroke();

        // Sigmoidå‡½æ•°
        function sigmoid(x) {
            return 1 / (1 + Math.exp(-x));
        }

        // Sigmoidå¯¼æ•°
        function sigmoidDerivative(x) {
            const s = sigmoid(x);
            return s * (1 - s);
        }

        // ç»˜åˆ¶å‡½æ•°
        const points = 200;
        const step = (2 * range) / points;

        // Sigmoid
        ctx.strokeStyle = '#22c55e';
        ctx.lineWidth = 3;
        ctx.beginPath();
        for (let i = 0; i <= points; i++) {
            const x = -range + i * step;
            const y = sigmoid(x);
            const px = centerX + (x / range) * (width / 2);
            const py = centerY - y * (height / 2);

            if (i === 0) {
                ctx.moveTo(px, py);
            } else {
                ctx.lineTo(px, py);
            }
        }
        ctx.stroke();

        // Sigmoidå¯¼æ•°
        ctx.strokeStyle = '#ef4444';
        ctx.lineWidth = 3;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        for (let i = 0; i <= points; i++) {
            const x = -range + i * step;
            const y = sigmoidDerivative(x) * 4; // æ”¾å¤§æ˜¾ç¤º
            const px = centerX + (x / range) * (width / 2);
            const py = centerY - y * (height / 2);

            if (i === 0) {
                ctx.moveTo(px, py);
            } else {
                ctx.lineTo(px, py);
            }
        }
        ctx.stroke();
        ctx.setLineDash([]);

        // æ ‡æ³¨æœ€å¤§å¯¼æ•°å€¼
        ctx.fillStyle = '#ef4444';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('max = 0.25', centerX, centerY - height / 2 + 20);

        // å›¾ä¾‹
        ctx.fillStyle = '#22c55e';
        ctx.fillRect(padding + 20, padding + 10, 30, 3);
        ctx.fillStyle = '#f1f5f9';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText('Sigmoidå‡½æ•°', padding + 55, padding + 15);

        ctx.fillStyle = '#ef4444';
        ctx.fillRect(padding + 20, padding + 30, 30, 3);
        ctx.fillStyle = '#f1f5f9';
        ctx.fillText('Sigmoidå¯¼æ•° (Ã—4)', padding + 55, padding + 35);

        // æ ‡é¢˜
        ctx.font = 'bold 16px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('Sigmoidå‡½æ•°çš„é¥±å’Œé—®é¢˜', canvas.width / 2, 25);
    }

    // æ»‘å—äº‹ä»¶
    document.getElementById('sigmoid-range').addEventListener('input', function(e) {
        document.getElementById('sigmoid-range-value').textContent = `Â±${e.target.value}`;
        updateSigmoidPlot();
    });

    document.getElementById('lr-slider').addEventListener('input', function(e) {
        document.getElementById('lr-value').textContent = (e.target.value / 100).toFixed(2);
    });

    // ä¼˜åŒ–å™¨è·¯å¾„å¯è§†åŒ–
    function visualizeOptimizerPaths() {
        const canvas = document.getElementById('optimizer-viz');
        const ctx = canvas.getContext('2d');

        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶èƒŒæ™¯
        ctx.fillStyle = 'rgba(15, 23, 42, 0.8)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶ç­‰é«˜çº¿ï¼ˆRosenbrockå‡½æ•°ï¼‰
        const centerX = 500;
        const centerY = 300;
        const scale = 100;

        ctx.strokeStyle = 'rgba(139, 92, 246, 0.3)';
        ctx.lineWidth = 1;

        for (let level = 0.1; level <= 10; level *= 2) {
            ctx.beginPath();
            for (let angle = 0; angle <= 2 * Math.PI; angle += 0.01) {
                const r = level * scale;
                const x = centerX + r * Math.cos(angle);
                const y = centerY + r * Math.sin(angle) * 0.3;

                if (angle === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.closePath();
            ctx.stroke();
        }

        // æ ‡è®°æœ€ä¼˜ç‚¹
        ctx.fillStyle = '#22c55e';
        ctx.beginPath();
        ctx.arc(centerX, centerY, 8, 0, 2 * Math.PI);
        ctx.fill();
        ctx.fillStyle = '#f1f5f9';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('æœ€ä¼˜ç‚¹', centerX, centerY - 15);

        // ç»˜åˆ¶ä¸åŒä¼˜åŒ–å™¨çš„è·¯å¾„
        const optimizers = [
            { name: 'SGD', color: '#ef4444', path: generateSGDPath() },
            { name: 'Momentum', color: '#fbbf24', path: generateMomentumPath() },
            { name: 'Adam', color: '#06b6d4', path: generateAdamPath() }
        ];

        optimizers.forEach(opt => {
            ctx.strokeStyle = opt.color;
            ctx.lineWidth = 2;
            ctx.beginPath();

            opt.path.forEach((point, i) => {
                if (i === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            });

            ctx.stroke();

            // æ ‡è®°ç»ˆç‚¹
            const lastPoint = opt.path[opt.path.length - 1];
            ctx.fillStyle = opt.color;
            ctx.beginPath();
            ctx.arc(lastPoint.x, lastPoint.y, 5, 0, 2 * Math.PI);
            ctx.fill();
        });

        // å›¾ä¾‹
        let legendY = 30;
        optimizers.forEach(opt => {
            ctx.fillStyle = opt.color;
            ctx.fillRect(20, legendY, 30, 3);
            ctx.fillStyle = '#f1f5f9';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(opt.name, 60, legendY + 5);
            legendY += 25;
        });

        // æ ‡é¢˜
        ctx.font = 'bold 16px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#f1f5f9';
        ctx.fillText('ä¸åŒä¼˜åŒ–å™¨çš„æ”¶æ•›è·¯å¾„', canvas.width / 2, 25);
    }

    // ç”Ÿæˆä¼˜åŒ–å™¨è·¯å¾„
    function generateSGDPath() {
        const path = [];
        let x = 100, y = 400;
        const lr = 0.001;

        for (let i = 0; i < 100; i++) {
            path.push({ x, y });
            // ç®€åŒ–çš„æ¢¯åº¦è®¡ç®—
            const dx = 2 * (x - 500);
            const dy = 2 * (y - 300) * 0.3;
            x -= lr * dx * 100;
            y -= lr * dy * 100;
        }

        return path;
    }

    function generateMomentumPath() {
        const path = [];
        let x = 100, y = 400;
        let vx = 0, vy = 0;
        const lr = 0.001;
        const beta = 0.9;

        for (let i = 0; i < 100; i++) {
            path.push({ x, y });
            const dx = 2 * (x - 500);
            const dy = 2 * (y - 300) * 0.3;
            vx = beta * vx + (1 - beta) * dx;
            vy = beta * vy + (1 - beta) * dy;
            x -= lr * vx * 100;
            y -= lr * vy * 100;
        }

        return path;
    }

    function generateAdamPath() {
        const path = [];
        let x = 100, y = 400;
        let mx = 0, my = 0, vx = 0, vy = 0;
        const lr = 0.01;
        const beta1 = 0.9, beta2 = 0.999;

        for (let i = 0; i < 100; i++) {
            path.push({ x, y });
            const dx = 2 * (x - 500);
            const dy = 2 * (y - 300) * 0.3;

            mx = beta1 * mx + (1 - beta1) * dx;
            my = beta1 * my + (1 - beta1) * dy;
            vx = beta2 * vx + (1 - beta2) * dx * dx;
            vy = beta2 * vy + (1 - beta2) * dy * dy;

            const mxHat = mx / (1 - Math.pow(beta1, i + 1));
            const myHat = my / (1 - Math.pow(beta1, i + 1));
            const vxHat = vx / (1 - Math.pow(beta2, i + 1));
            const vyHat = vy / (1 - Math.pow(beta2, i + 1));

            x -= lr * mxHat / (Math.sqrt(vxHat) + 1e-8) * 100;
            y -= lr * myHat / (Math.sqrt(vyHat) + 1e-8) * 100;
        }

        return path;
    }

    // åŠ¨ç”»ä¼˜åŒ–å™¨
    let optimizerAnimation = null;
    function animateOptimizers() {
        if (optimizerAnimation) {
            cancelAnimationFrame(optimizerAnimation);
            optimizerAnimation = null;
            return;
        }

        const canvas = document.getElementById('optimizer-viz');
        const ctx = canvas.getContext('2d');
        let step = 0;

        function animate() {
            if (step > 100) {
                optimizerAnimation = null;
                return;
            }

            visualizeOptimizerPaths();

            // æ·»åŠ å½“å‰ä½ç½®æ ‡è®°
            const optimizers = [
                { name: 'SGD', color: '#ef4444', path: generateSGDPath() },
                { name: 'Momentum', color: '#fbbf24', path: generateMomentumPath() },
                { name: 'Adam', color: '#06b6d4', path: generateAdamPath() }
            ];

            optimizers.forEach(opt => {
                if (step < opt.path.length) {
                    const point = opt.path[step];
                    ctx.fillStyle = opt.color;
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 8, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });

            step++;
            optimizerAnimation = requestAnimationFrame(animate);
        }

        animate();
    }

    // åˆå§‹åŒ–å®éªŒ
    function runInitExperiment() {
        // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„å®éªŒä»£ç 
        console.log('è¿è¡Œåˆå§‹åŒ–å®éªŒ...');
    }

    function runFinalExperiment() {
        // ç»˜åˆ¶æœ€ç»ˆç»“æœ
        const canvas = document.getElementById('final-results');
        const ctx = canvas.getContext('2d');

        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶èƒŒæ™¯
        ctx.fillStyle = 'rgba(15, 23, 42, 0.8)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // æ¨¡æ‹Ÿè®­ç»ƒæ›²çº¿
        const epochs = 50;
        const trainLoss = [];
        const valLoss = [];
        const gradNorm = [];

        for (let i = 0; i < epochs; i++) {
            trainLoss.push(2.3 * Math.exp(-i / 10) + 0.1 + Math.random() * 0.05);
            valLoss.push(2.3 * Math.exp(-i / 10) + 0.15 + Math.random() * 0.08);
            gradNorm.push(1.5 + Math.sin(i / 5) * 0.3 + Math.random() * 0.2);
        }

        // ç»˜åˆ¶æŸå¤±æ›²çº¿
        const padding = 40;
        const width = (canvas.width - 3 * padding) / 2;
        const height = canvas.height - 2 * padding;

        // è®­ç»ƒæŸå¤±
        ctx.strokeStyle = '#22c55e';
        ctx.lineWidth = 2;
        ctx.beginPath();
        trainLoss.forEach((loss, i) => {
            const x = padding + (i / epochs) * width;
            const y = padding + height - (loss / 2.5) * height;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // éªŒè¯æŸå¤±
        ctx.strokeStyle = '#06b6d4';
        ctx.lineWidth = 2;
        ctx.beginPath();
        valLoss.forEach((loss, i) => {
            const x = padding + (i / epochs) * width;
            const y = padding + height - (loss / 2.5) * height;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // æ¢¯åº¦èŒƒæ•°
        ctx.strokeStyle = '#8b5cf6';
        ctx.lineWidth = 2;
        ctx.beginPath();
        gradNorm.forEach((norm, i) => {
            const x = padding * 2 + width + (i / epochs) * width;
            const y = padding + height - (norm / 2) * height;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // æ ‡ç­¾
        ctx.fillStyle = '#f1f5f9';
        ctx.font = '14px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('è®­ç»ƒ/éªŒè¯æŸå¤±', padding + width / 2, canvas.height - 10);
        ctx.fillText('æ¢¯åº¦èŒƒæ•°', padding * 2 + width + width / 2, canvas.height - 10);

        // å›¾ä¾‹
        ctx.fillStyle = '#22c55e';
        ctx.fillRect(padding, 10, 20, 3);
        ctx.fillStyle = '#f1f5f9';
        ctx.textAlign = 'left';
        ctx.fillText('è®­ç»ƒæŸå¤±', padding + 25, 15);

        ctx.fillStyle = '#06b6d4';
        ctx.fillRect(padding + 100, 10, 20, 3);
        ctx.fillText('éªŒè¯æŸå¤±', padding + 125, 15);

        ctx.fillStyle = '#8b5cf6';
        ctx.fillRect(padding * 2 + width, 10, 20, 3);
        ctx.fillText('æ¢¯åº¦èŒƒæ•°', padding * 2 + width + 25, 15);
    }

    // æ¸…å•åŠŸèƒ½
    function toggleCheck(checkbox) {
        checkbox.classList.toggle('checked');
    }

    // åé¦ˆåŠŸèƒ½
    function submitFeedback(type) {
        console.log('Feedback:', type);
        alert('æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼æˆ‘ä»¬ä¼šç»§ç»­æ”¹è¿›æ•™ç¨‹ã€‚');
    }

    // åˆå§‹åŒ–æ‰€æœ‰å¯è§†åŒ–
    window.addEventListener('load', () => {
        visualizeGradientFlow();
        updateSigmoidPlot();
        visualizeOptimizerPaths();
        updateProgressBar();
    });

    // å­¦ä¹ å¾ªç¯æ­¥éª¤é«˜äº®
    let currentStep = 0;
    const loopSteps = document.querySelectorAll('.loop-step');

    function highlightStep() {
        loopSteps.forEach((step, index) => {
            step.classList.toggle('active', index === currentStep);
        });
        currentStep = (currentStep + 1) % loopSteps.length;
    }

    if (animationsEnabled) {
        setInterval(highlightStep, 3000);
    }
</script>
</body>
</html>
