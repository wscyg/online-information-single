<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLM模型推理系统 - 深度解析</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #ec4899;
            --bg-dark: #1e293b;
            --bg-light: #f8fafc;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --border-color: #e2e8f0;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* 顶部导航栏 */
        .navbar {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .navbar.scrolled {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo {
            font-size: 1.5em;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 30px;
        }

        .nav-menu a {
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-menu a:hover {
            color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .nav-menu a.active {
            color: white;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        /* 主要内容区域 */
        .main-container {
            margin-top: 90px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            padding: 0 20px 40px;
        }

        /* 英雄区域 */
        .hero-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 80px 0;
            text-align: center;
            border-radius: 20px;
            margin-bottom: 60px;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .hero-section h1 {
            font-size: 3em;
            margin-bottom: 20px;
            animation: fadeInUp 1s ease-out;
        }

        .hero-section p {
            font-size: 1.3em;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
            animation: fadeInUp 1s ease-out 0.2s;
            animation-fill-mode: both;
        }

        /* 内容部分 */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .content-section.active {
            display: block;
        }

        /* 卡片样式 */
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            color: white;
            font-size: 24px;
        }

        .card-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* 代码对比容器 */
        .code-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .code-panel {
            padding: 20px;
            background: #282c34;
            color: #abb2bf;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            overflow-x: auto;
            position: relative;
        }

        .code-panel-header {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.1);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #abb2bf;
        }

        .explanation-panel {
            padding: 30px;
            background: var(--bg-light);
        }

        .explanation-panel h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .explanation-panel h4 {
            color: var(--secondary-color);
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        /* 流程图 */
        .flow-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .flow-diagram {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .flow-step {
            flex: 1;
            min-width: 180px;
            text-align: center;
            position: relative;
        }

        .flow-step-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .flow-step:hover .flow-step-icon {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .flow-step-icon::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            z-index: -1;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }

        .flow-step-title {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .flow-step-desc {
            color: var(--text-light);
            font-size: 0.9em;
        }

        .flow-arrow {
            position: absolute;
            top: 40px;
            right: -30px;
            width: 40px;
            height: 2px;
            background: var(--border-color);
        }

        .flow-arrow::after {
            content: '';
            position: absolute;
            right: -8px;
            top: -4px;
            width: 0;
            height: 0;
            border-left: 8px solid var(--border-color);
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
        }

        .flow-step:last-child .flow-arrow {
            display: none;
        }

        /* Token可视化 */
        .token-visualization {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .token-group {
            margin-bottom: 15px;
        }

        .token-group-label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .token {
            display: inline-block;
            padding: 6px 12px;
            margin: 4px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: default;
        }

        .token:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .token.normal {
            background: var(--primary-color);
            color: white;
        }

        .token.special {
            background: var(--accent-color);
            color: white;
        }

        .token.mask {
            background: var(--success-color);
            color: white;
        }

        /* 矩阵可视化 */
        .matrix-visualization {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }

        .matrix-grid {
            display: inline-block;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.2;
        }

        .matrix-cell {
            display: inline-block;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            margin: 1px;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .matrix-cell.one {
            background: var(--primary-color);
            color: white;
        }

        .matrix-cell.zero {
            background: var(--border-color);
            color: var(--text-light);
        }

        .matrix-cell:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        /* 特性网格 */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.15);
        }

        .feature-card:hover::before {
            transform: scaleY(1);
        }

        .feature-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .feature-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .feature-desc {
            color: var(--text-light);
            font-size: 0.95em;
            line-height: 1.6;
        }

        /* 高亮框 */
        .highlight-box {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #fbbf24;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .highlight-box::before {
            content: '💡';
            position: absolute;
            top: -10px;
            right: 20px;
            font-size: 40px;
            opacity: 0.2;
        }

        .highlight-box h4 {
            color: #92400e;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .highlight-box p {
            color: #78350f;
            margin: 0;
        }

        /* 代码高亮 */
        .code-keyword { color: #c678dd; }
        .code-string { color: #98c379; }
        .code-comment { color: #5c6370; font-style: italic; }
        .code-function { color: #61afef; }
        .code-number { color: #d19a66; }
        .code-class { color: #e06c75; }

        /* 标签页 */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-light);
            transition: all 0.3s ease;
            position: relative;
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-color);
        }

        /* 动画 */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 代码行号 */
        .code-with-lines {
            position: relative;
            background: #282c34;
            border-radius: 8px;
            overflow: hidden;
        }

        .line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 50px;
            background: rgba(255,255,255,0.05);
            padding: 20px 0;
            text-align: center;
            color: #5c6370;
            font-size: 12px;
            line-height: 1.6em;
            user-select: none;
        }

        .code-content {
            padding: 20px 20px 20px 70px;
            overflow-x: auto;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }

            .code-comparison {
                grid-template-columns: 1fr;
            }

            .flow-diagram {
                flex-direction: column;
            }

            .flow-arrow {
                display: none;
            }

            .hero-section h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
<!-- 导航栏 -->
<nav class="navbar" id="navbar">
    <div class="nav-container">
        <div class="logo">GLM推理系统</div>
        <ul class="nav-menu">
            <li><a href="#overview" class="nav-link active">总览</a></li>
            <li><a href="#architecture" class="nav-link">架构</a></li>
            <li><a href="#data-flow" class="nav-link">数据流</a></li>
            <li><a href="#implementation" class="nav-link">实现</a></li>
            <li><a href="#features" class="nav-link">特性</a></li>
        </ul>
    </div>
</nav>

<!-- 主容器 -->
<div class="main-container">
    <!-- 英雄区域 -->
    <div class="hero-section">
        <div class="hero-content">
            <h1>GLM模型推理系统深度解析</h1>
            <p>基于百度Zeus框架的生成式语言模型，采用独特的双向-自回归混合注意力机制</p>
        </div>
    </div>

    <!-- 总览部分 -->
    <div id="overview" class="content-section active">
        <div class="flow-container">
            <h2 style="text-align: center; margin-bottom: 10px;">系统工作流程</h2>
            <p style="text-align: center; color: var(--text-light); margin-bottom: 30px;">
                从原始数据到最终推理结果的完整处理流程
            </p>
            <div class="flow-diagram">
                <div class="flow-step">
                    <div class="flow-step-icon">📄</div>
                    <div class="flow-step-title">数据输入</div>
                    <div class="flow-step-desc">TSV/JSONL格式<br>结构化数据</div>
                    <div class="flow-arrow"></div>
                </div>
                <div class="flow-step">
                    <div class="flow-step-icon">✂️</div>
                    <div class="flow-step-title">文本处理</div>
                    <div class="flow-step-desc">分割与截断<br>长度控制</div>
                    <div class="flow-arrow"></div>
                </div>
                <div class="flow-step">
                    <div class="flow-step-icon">🔤</div>
                    <div class="flow-step-title">分词编码</div>
                    <div class="flow-step-desc">BPE分词器<br>Token转换</div>
                    <div class="flow-arrow"></div>
                </div>
                <div class="flow-step">
                    <div class="flow-step-icon">📦</div>
                    <div class="flow-step-title">批处理</div>
                    <div class="flow-step-desc">数据对齐<br>掩码生成</div>
                    <div class="flow-arrow"></div>
                </div>
                <div class="flow-step">
                    <div class="flow-step-icon">🧠</div>
                    <div class="flow-step-title">模型推理</div>
                    <div class="flow-step-desc">GLM前向传播<br>结果输出</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon">🎯</div>
                <h2 class="card-title">核心功能</h2>
            </div>
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">📊</div>
                    <div class="feature-title">指令理解与响应</div>
                    <div class="feature-desc">
                        处理"指令-查询-标题"的输入格式，生成相应的标签分类和原因解释
                    </div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🔀</div>
                    <div class="feature-title">混合注意力机制</div>
                    <div class="feature-desc">
                        独特的GLM设计：输入部分使用双向注意力，生成部分使用自回归注意力
                    </div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">📏</div>
                    <div class="feature-title">智能长度控制</div>
                    <div class="feature-desc">
                        自动截断过长文本，优先保留重要信息，确保不超过156个token的限制
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 架构部分 -->
    <div id="architecture" class="content-section">
        <div class="card">
            <div class="card-header">
                <div class="card-icon">🏗️</div>
                <h2 class="card-title">系统架构</h2>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showArchTab('classes')">类结构</button>
                <button class="tab" onclick="showArchTab('tokens')">Token系统</button>
                <button class="tab" onclick="showArchTab('encoding')">编码系统</button>
            </div>

            <div id="arch-classes" class="arch-content active">
                <div class="code-comparison">
                    <div class="code-panel">
                        <div class="code-panel-header">BaseReader 基类</div>
                        <pre><span class="code-keyword">class</span> <span class="code-class">BaseReader</span>(object):
    <span class="code-keyword">def</span> <span class="code-function">__init__</span>(self, trainer_id, trainer_num, ...):
        <span class="code-comment"># 分布式训练配置</span>
        self.trainer_id = trainer_id
        self.trainer_num = trainer_num

        <span class="code-comment"># 分词器初始化</span>
        self.tokenizer = BpeTokenizer(vocab_path)
        self.vocab = self.tokenizer.vocab

        <span class="code-comment"># 特殊token映射</span>
        self.pad_id = self.vocab[<span class="code-string">"[PAD]"</span>]
        self.cls_id = self.vocab[<span class="code-string">"[CLS]"</span>]
        self.gmask_id = self.vocab[<span class="code-string">"[gMASK]"</span>]
        self.start_id = self.vocab[<span class="code-string">"[START]"</span>]</pre>
                    </div>
                    <div class="explanation-panel">
                        <h3>BaseReader 设计理念</h3>
                        <h4>核心职责</h4>
                        <ul>
                            <li><strong>数据读取</strong>：支持TSV和JSONL两种格式</li>
                            <li><strong>批处理管理</strong>：实现高效的批次数据生成</li>
                            <li><strong>分布式支持</strong>：通过trainer_id实现多GPU数据分配</li>
                        </ul>

                        <h4>关键组件</h4>
                        <ul>
                            <li><strong>BPE分词器</strong>：子词级别的分词，能处理未见词汇</li>
                            <li><strong>特殊Token系统</strong>：定义了模型理解的特殊标记</li>
                            <li><strong>随机数生成器</strong>：保证数据打乱的可重现性</li>
                        </ul>

                        <div class="highlight-box">
                            <h4>设计亮点</h4>
                            <p>采用生成器模式处理数据，避免一次性加载全部数据到内存，适合大规模数据集处理</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="arch-tokens" class="arch-content" style="display: none;">
                <div class="token-visualization">
                    <div class="token-group">
                        <div class="token-group-label">基础标记</div>
                        <span class="token normal">[PAD]</span>
                        <span class="token normal">[CLS]</span>
                        <span class="token normal">[SEP]</span>
                        <span class="token normal">[UNK]</span>
                    </div>
                    <div class="token-group">
                        <div class="token-group-label">GLM特殊标记</div>
                        <span class="token special">[START]</span>
                        <span class="token mask">[gMASK]</span>
                        <span class="token special">[gEND]</span>
                    </div>
                </div>

                <h4 style="margin-top: 30px;">Token功能说明</h4>
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                    <tr>
                        <th style="padding: 12px; background: #f8f9fa;">Token</th>
                        <th style="padding: 12px; background: #f8f9fa;">作用</th>
                        <th style="padding: 12px; background: #f8f9fa;">使用位置</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">[PAD]</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">填充短序列到统一长度</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">序列末尾</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">[CLS]</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">分类任务的特征提取点</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">输入序列末尾</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">[SEP]</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">分隔不同文本片段</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">片段之间</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">[gMASK]</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">标记生成位置</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">输入与生成之间</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">[START]</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">生成序列开始</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">目标序列开头</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">[gEND]</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">生成序列结束</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">目标序列末尾</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div id="arch-encoding" class="arch-content" style="display: none;">
                <h3>双重位置编码系统</h3>
                <div class="code-comparison">
                    <div class="code-panel">
<pre><span class="code-comment"># 主位置编码</span>
pos_ids = list(range(<span class="code-number">0</span>, len(tokens_src))) + \
          [tokens_src.index(<span class="code-string">"[gMASK]"</span>)] * len(tokens_target)

<span class="code-comment"># 辅助位置编码</span>
pos_ids_extra = [<span class="code-number">0</span>] * len(tokens_src) + \
                list(range(<span class="code-number">1</span>, len(tokens_target) + <span class="code-number">1</span>))

<span class="code-comment"># 损失掩码</span>
loss_mask = [<span class="code-number">0</span>] * len(tokens_src) + \
            [<span class="code-number">0</span>] + [<span class="code-number">1</span>] * (len(tokens_target) - <span class="code-number">1</span>)</pre>
                    </div>
                    <div class="explanation-panel">
                        <h3>编码策略解析</h3>

                        <h4>位置编码设计</h4>
                        <p>GLM采用双重位置编码系统，实现输入理解和生成的分离：</p>
                        <ul>
                            <li><strong>主位置编码</strong>：输入部分递增，生成部分固定</li>
                            <li><strong>辅助位置编码</strong>：输入部分为0，生成部分递增</li>
                        </ul>

                        <div class="matrix-visualization">
                            <h4>编码示例</h4>
                            <p style="margin-bottom: 10px;">输入: "判断相关性[SEP]查询[SEP]标题[SEP][gMASK][CLS]"</p>
                            <p style="margin-bottom: 10px;">生成: "[START]原因解释[gEND]"</p>
                            <div style="font-family: monospace; line-height: 1.8;">
                                <div>主位置:   [0,1,2,3,4,5,6,7,8,9,10,11,12] [11,11,11,11]</div>
                                <div>辅助位置: [0,0,0,0,0,0,0,0,0,0,0,0,0]   [1,2,3,4]</div>
                                <div>损失掩码: [0,0,0,0,0,0,0,0,0,0,0,0,0]   [0,1,1,1]</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 数据流部分 -->
    <div id="data-flow" class="content-section">
        <div class="card">
            <div class="card-header">
                <div class="card-icon">🔄</div>
                <h2 class="card-title">数据处理流程</h2>
            </div>

            <h3>输入数据格式</h3>
            <div class="code-comparison">
                <div class="code-panel">
<pre><span class="code-comment"># TSV文件格式</span>
qid     src     tgt
<span class="code-number">001</span>     指令[SEP]查询[SEP]标题     标签[SEP]原因
<span class="code-number">002</span>     判断相关性[SEP]职称评定[SEP]职称申报服务     <span class="code-number">1</span>[SEP]查询与标题高度相关

<span class="code-comment"># 处理流程</span>
<span class="code-keyword">def</span> <span class="code-function">_convert_example_to_record</span>(self, example, ...):
    <span class="code-comment"># 1. 分割文本</span>
    text_instruction, text_query, text_title = \
        example.src.split(<span class="code-string">"[SEP]"</span>)
    text_label, text_reason = \
        example.tgt.split(<span class="code-string">"[SEP]"</span>)</pre>
                </div>
                <div class="explanation-panel">
                    <h3>数据预处理步骤</h3>

                    <h4>1. 文本分割</h4>
                    <p>使用[SEP]标记将输入分解为三个部分：</p>
                    <ul>
                        <li><strong>指令</strong>：任务描述（如"判断相关性"）</li>
                        <li><strong>查询</strong>：用户输入的搜索词</li>
                        <li><strong>标题</strong>：待匹配的内容标题</li>
                    </ul>

                    <h4>2. 分词处理</h4>
                    <div class="token-visualization">
                        <div class="token-group">
                            <div class="token-group-label">原始文本</div>
                            <span style="background: #e2e8f0; padding: 8px; border-radius: 6px;">
                                    判断相关性
                                </span>
                        </div>
                        <div class="token-group">
                            <div class="token-group-label">分词结果</div>
                            <span class="token normal">判断</span>
                            <span class="token normal">相关</span>
                            <span class="token normal">性</span>
                        </div>
                    </div>
                </div>
            </div>

            <h3 style="margin-top: 40px;">序列构建</h3>
            <div class="token-visualization">
                <div class="token-group">
                    <div class="token-group-label">完整输入序列</div>
                    <span class="token normal">指令tokens</span>
                    <span class="token special">[SEP]</span>
                    <span class="token normal">查询tokens</span>
                    <span class="token special">[SEP]</span>
                    <span class="token normal">标题tokens</span>
                    <span class="token special">[SEP]</span>
                    <span class="token mask">[gMASK]</span>
                    <span class="token special">[CLS]</span>
                </div>
                <div class="token-group">
                    <div class="token-group-label">目标生成序列</div>
                    <span class="token special">[START]</span>
                    <span class="token normal">原因tokens</span>
                    <span class="token special">[gEND]</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon">🎭</div>
                <h2 class="card-title">注意力掩码机制</h2>
            </div>

            <h3>GLM独特的混合注意力模式</h3>
            <div class="matrix-visualization">
                <h4>注意力矩阵示例（8×8）</h4>
                <div class="matrix-grid">
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <br>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <br>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <br>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <br>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <br>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell zero">0</div>
                    <div class="matrix-cell zero">0</div>
                    <br>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell zero">0</div>
                    <br>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                    <div class="matrix-cell one">1</div>
                </div>
                <p style="margin-top: 15px;">
                    <strong>左上角4×4</strong>：输入部分（双向注意力）<br>
                    <strong>右下角4×4</strong>：生成部分（自回归注意力）
                </p>
            </div>

            <div class="highlight-box" style="margin-top: 20px;">
                <h4>设计理念</h4>
                <p>这种混合注意力机制让模型在理解输入时能够充分利用上下文信息（双向），
                    而在生成输出时保持自回归特性，确保生成的连贯性。</p>
            </div>
        </div>
    </div>

    <!-- 实现部分 -->
    <div id="implementation" class="content-section">
        <div class="card">
            <div class="card-header">
                <div class="card-icon">💻</div>
                <h2 class="card-title">关键实现细节</h2>
            </div>

            <h3>批处理与填充</h3>
            <div class="code-comparison">
                <div class="code-panel">
<pre><span class="code-keyword">def</span> <span class="code-function">_pad_batch_records</span>(self, batch_records):
    <span class="code-comment"># 提取各字段</span>
    batch_token_ids = [record.token_ids
                      <span class="code-keyword">for</span> record <span class="code-keyword">in</span> batch_records]

    <span class="code-comment"># 填充到相同长度</span>
    padded_token_ids = pad_batch_data(
        batch_token_ids,
        pad_idx=self.pad_id,
        return_input_mask=False
    )

    <span class="code-comment"># 生成注意力掩码</span>
    input_mask = self._gen_self_attn_mask_for_glm(
        batch_token_ids
    )</pre>
                </div>
                <div class="explanation-panel">
                    <h3>批处理策略</h3>

                    <h4>数据对齐</h4>
                    <p>批处理需要将不同长度的序列对齐到相同长度：</p>
                    <ul>
                        <li>找出批次中最长的序列</li>
                        <li>使用[PAD]标记填充短序列</li>
                        <li>生成对应的注意力掩码</li>
                    </ul>

                    <h4>内存优化</h4>
                    <ul>
                        <li>使用生成器模式，按需生成批次</li>
                        <li>动态批次大小，基于token总数</li>
                        <li>避免一次性加载全部数据</li>
                    </ul>
                </div>
            </div>

            <h3 style="margin-top: 40px;">模型推理流程</h3>
            <div class="code-comparison">
                <div class="code-panel">
<pre><span class="code-comment"># 准备输入张量</span>
input_ids = torch.tensor(padded_token_ids,
                        dtype=torch.int32,
                        device=device)

<span class="code-comment"># 双层位置编码</span>
position_ids = torch.stack([
    old_position_ids,
    old_position_ids_extra
], dim=<span class="code-number">0</span>)

<span class="code-comment"># 模型推理</span>
<span class="code-keyword">with</span> torch.no_grad():
    output = hf_model(
        input_ids=input_ids,
        position_ids=position_ids,
        attention_mask=attention_mask,
        last_token_ids=token_pos_ids
    )</pre>
                </div>
                <div class="explanation-panel">
                    <h3>推理优化技巧</h3>

                    <h4>性能优化</h4>
                    <ul>
                        <li><code>torch.no_grad()</code>：禁用梯度计算</li>
                        <li><code>model.eval()</code>：关闭dropout等训练特性</li>
                        <li>批处理：提高GPU利用率</li>
                    </ul>

                    <h4>调试支持</h4>
                    <ul>
                        <li>详细的输入输出日志</li>
                        <li>注意力掩码可视化</li>
                        <li>中间结果保存</li>
                    </ul>

                    <div class="highlight-box">
                        <h4>CUDA调试技巧</h4>
                        <p>设置<code>CUDA_LAUNCH_BLOCKING=1</code>可以让CUDA操作同步执行，
                            便于定位错误位置。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 特性部分 -->
    <div id="features" class="content-section">
        <div class="card">
            <div class="card-header">
                <div class="card-icon">✨</div>
                <h2 class="card-title">系统特性总结</h2>
            </div>

            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">🧩</div>
                    <div class="feature-title">模块化设计</div>
                    <div class="feature-desc">
                        清晰的类层次结构，BaseReader提供基础功能，InstructionReader实现具体逻辑，便于扩展和维护。
                    </div>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">⚡</div>
                    <div class="feature-title">高效数据处理</div>
                    <div class="feature-desc">
                        生成器模式处理数据，支持大规模数据集。智能批处理策略，优化GPU利用率。
                    </div>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">🔧</div>
                    <div class="feature-title">灵活配置</div>
                    <div class="feature-desc">
                        支持调试模式、批次大小调整、序列长度限制等多种配置选项，适应不同场景需求。
                    </div>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">📊</div>
                    <div class="feature-title">分布式支持</div>
                    <div class="feature-desc">
                        内置多GPU训练支持，通过trainer_id和trainer_num实现数据的自动分配。
                    </div>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">🛡️</div>
                    <div class="feature-title">错误处理</div>
                    <div class="feature-desc">
                        完善的异常捕获和日志记录，断言检查确保数据完整性，便于问题定位。
                    </div>
                </div>

                <div class="feature-card">
                    <div class="feature-icon">📈</div>
                    <div class="feature-title">性能监控</div>
                    <div class="feature-desc">
                        详细的调试输出，包括输入形状、token范围、注意力矩阵结构等，便于性能分析。
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-icon">🎯</div>
                <h2 class="card-title">使用建议</h2>
            </div>

            <div style="display: grid; gap: 20px;">
                <div class="highlight-box">
                    <h4>数据准备</h4>
                    <p>确保输入数据格式正确，使用[SEP]分隔不同部分。建议预先检查数据质量，避免格式错误。</p>
                </div>

                <div class="highlight-box">
                    <h4>性能优化</h4>
                    <p>根据GPU内存调整batch_size，使用较大的批次可以提高吞吐量。注意序列长度限制，避免OOM错误。</p>
                </div>

                <div class="highlight-box">
                    <h4>调试技巧</h4>
                    <p>开启debug模式进行小规模测试，使用调试输出了解数据处理流程，保存中间结果便于问题分析。</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 导航栏滚动效果
    window.addEventListener('scroll', function() {
        const navbar = document.getElementById('navbar');
        if (window.scrollY > 50) {
            navbar.classList.add('scrolled');
        } else {
            navbar.classList.remove('scrolled');
        }
    });

    // 导航链接激活
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.content-section');

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            // 移除所有active类
            navLinks.forEach(l => l.classList.remove('active'));
            sections.forEach(s => s.classList.remove('active'));

            // 添加active类
            this.classList.add('active');
            const targetId = this.getAttribute('href').substring(1);
            document.getElementById(targetId).classList.add('active');

            // 平滑滚动到顶部
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    });

    // 架构标签页切换
    function showArchTab(tabName) {
        const tabs = document.querySelectorAll('.tab');
        const contents = document.querySelectorAll('.arch-content');

        tabs.forEach(tab => tab.classList.remove('active'));
        contents.forEach(content => content.style.display = 'none');

        event.target.classList.add('active');
        document.getElementById('arch-' + tabName).style.display = 'block';
    }

    // 流程图动画
    const flowSteps = document.querySelectorAll('.flow-step-icon');
    flowSteps.forEach((step, index) => {
        step.style.animationDelay = `${index * 0.2}s`;
    });

    // 矩阵单元格悬停效果
    const matrixCells = document.querySelectorAll('.matrix-cell');
    matrixCells.forEach(cell => {
        cell.addEventListener('mouseenter', function() {
            this.style.zIndex = '10';
        });
        cell.addEventListener('mouseleave', function() {
            this.style.zIndex = '1';
        });
    });

    // 代码高亮增强
    function enhanceCodeHighlight() {
        const codeBlocks = document.querySelectorAll('.code-panel pre');
        codeBlocks.forEach(block => {
            // 添加行号
            const lines = block.innerHTML.split('\n');
            const lineNumbers = lines.map((_, i) => i + 1).join('\n');

            // 可以在这里添加更多的代码高亮逻辑
        });
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        enhanceCodeHighlight();

        // 添加加载动画
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.5s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });
    });

    // 复制代码功能
    document.querySelectorAll('.code-panel').forEach(panel => {
        panel.addEventListener('dblclick', function() {
            const code = this.querySelector('pre').textContent;
            navigator.clipboard.writeText(code).then(() => {
                // 显示复制成功提示
                const tooltip = document.createElement('div');
                tooltip.textContent = '已复制到剪贴板';
                tooltip.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: #10b981;
                        color: white;
                        padding: 8px 16px;
                        border-radius: 6px;
                        font-size: 14px;
                        z-index: 1000;
                    `;
                this.appendChild(tooltip);

                setTimeout(() => {
                    tooltip.remove();
                }, 2000);
            });
        });
    });
</script>
</body>
</html>